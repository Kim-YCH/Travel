<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºç™¼å›‰ (v48 é™¤éŒ¯ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding-bottom: 200px; /* é ç•™åº•éƒ¨ç©ºé–“çµ¦é™¤éŒ¯æ¡† */ }
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 10px; }
        .flex { display: flex; } .gap-2 { gap: 8px; }
        input, select { border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 100%; }
        
        /* åœ°åœ–å®¹å™¨ */
        #map { height: 300px; width: 100%; background: #eee; margin-top: 10px; }
        
        /* æœå°‹å»ºè­° */
        .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 50; max-height: 250px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .suggestion-item:hover { background: #f0f9ff; }

        /* é™¤éŒ¯è¦–çª—æ¨£å¼ */
        #debug-console {
            position: fixed; bottom: 0; left: 0; right: 0; height: 150px;
            background: #000; color: #0f0; font-family: monospace; font-size: 12px;
            padding: 10px; overflow-y: scroll; z-index: 99999; opacity: 0.9;
            border-top: 2px solid #333;
        }
    </style>
</head>
<body>

<div id="debug-console">
    <div>=== ç³»çµ±æ—¥èªŒ (è«‹æˆªåœ–æ­¤è™•) ===</div>
</div>

<script>
    // æ””æˆªæ‰€æœ‰éŒ¯èª¤ä¸¦é¡¯ç¤ºåœ¨è¢å¹•ä¸Š
    function log(msg) {
        const el = document.getElementById('debug-console');
        const line = document.createElement('div');
        line.innerText = '> ' + msg;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
        console.log(msg);
    }
    window.onerror = function(msg, url, line) {
        log("âŒ ERROR: " + msg + " (Line: " + line + ")");
        return false; // è®“éŒ¯èª¤ç¹¼çºŒæ‹‹å‡ºï¼Œä»¥ä¾¿ç€è¦½å™¨è™•ç†
    };
    log("ç³»çµ±å•Ÿå‹•ä¸­...");
</script>

<div id="app">
    <div v-if="isLoading" style="position:fixed;top:0;left:0;right:0;height:4px;background:blue;"></div>

    <div v-if="currentView === 'lobby'" class="p-4">
        <h1 class="text-3xl font-bold mb-4">âœˆï¸ å‡ºç™¼å›‰</h1>
        
        <div class="space-y-4 mb-8">
            <div v-for="trip in trips" :key="trip.id" @click="selectTrip(trip)" class="card cursor-pointer border-l-4 border-blue-500 hover:shadow-md flex justify-between">
                <div><div class="font-bold text-xl">{{ trip.name }}</div><div class="text-sm text-gray-500">{{ trip.city }}</div></div><div>âœ</div>
            </div>
            <div v-if="trips.length === 0" class="text-center text-gray-400 py-10">è®€å–ä¸­æˆ–å°šç„¡æ—…ç¨‹...</div>
        </div>

        <div class="card">
            <h3 class="font-bold mb-2">æ–°å¢æ—…ç¨‹</h3>
            <input v-model="newTripName" placeholder="æ—…ç¨‹åç¨±" class="mb-2">
            <input v-model="newTripCity" placeholder="ä¸»è¦åŸå¸‚" class="mb-2">
            <button @click="createTrip" class="w-full bg-blue-600 text-white py-2 rounded font-bold" :disabled="isLoading">å»ºç«‹</button>
        </div>
    </div>

    <div v-else class="flex flex-col h-full">
        <header class="bg-blue-600 text-white p-4 pt-8 sticky top-0 z-50 flex justify-between items-center">
            <div><h1 class="text-lg font-bold">{{ currentTrip.name }}</h1><div class="text-xs">Day {{ currentDay }}</div></div>
            <button @click="fetchData" class="text-xs bg-blue-800 px-3 py-1 rounded">â†» åŒæ­¥</button>
        </header>

        <main class="flex-1 overflow-hidden flex flex-col p-4 overflow-y-auto">
            <div v-if="currentTab === 'itinerary'" class="space-y-4">
                <div class="flex gap-2 overflow-x-auto">
                    <button v-for="d in totalDays" :key="d" @click="currentDay = d" class="px-4 py-1 rounded-full border text-sm" :class="currentDay === d ? 'bg-blue-600 text-white' : 'bg-white text-gray-500'">Day {{ d }}</button>
                    <button @click="addNewDay" class="px-3 py-1 rounded-full border bg-white">+</button>
                </div>
                
                <div class="card relative">
                    <div class="flex gap-2 mb-2 relative">
                        <input v-model="newPlace" @input="searchPlacesInput" type="text" placeholder="æœå°‹åœ°é»..." class="flex-1">
                        <button @click="addPlace" class="bg-blue-600 text-white w-10 rounded">+</button>
                        <div v-if="searchResults.length > 0" class="suggestions-list">
                            <div v-for="item in searchResults" :key="item.place_id" @click="selectPlace(item)" class="suggestion-item">
                                ğŸ“ {{ item.structured_formatting.main_text }}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="newTime" type="time" class="w-1/3">
                        <input v-model="newNote" type="text" placeholder="å‚™è¨»..." class="flex-1">
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div v-for="place in filteredItinerary" :key="place.id" class="card flex justify-between items-start">
                        <div class="flex-1" @click="openGoogleMap(place)">
                            <div class="flex items-center gap-2">
                                <span v-if="place.time" class="text-blue-600 font-bold text-sm bg-blue-50 px-1 rounded">{{ formatTime(place.time) }}</span>
                                <span class="font-bold text-lg">{{ place.name }}</span>
                            </div>
                            <div v-if="place.message" class="text-sm text-gray-500">ğŸ“ {{ place.message }}</div>
                        </div>
                        <div>
                            <button @click.stop="editPlace(place)" class="text-gray-400 px-1">âœ</button>
                            <button @click.stop="removePlace(place.id)" class="text-red-400 px-1">Ã—</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'map'" class="h-full flex flex-col">
                <button @click="fitBoundsToTrip" class="bg-white text-blue-600 p-2 rounded shadow mb-2 text-sm font-bold border">ğŸ”„ é¡¯ç¤ºæ‰€æœ‰è¡Œç¨‹</button>
                <div id="map"></div>
            </div>

            <div v-if="currentTab === 'money'" class="space-y-4">
                <div class="card bg-gray-800 text-white">
                    <div class="flex justify-between items-end"><span class="text-gray-400">ç¸½æ”¯å‡º</span><span class="text-2xl font-bold">${{ totalExpense }}</span></div>
                    <div class="border-t border-gray-600 mt-2 pt-2 text-sm"><div v-for="res in balanceSheet" :key="res.name" class="flex justify-between"><span>{{ res.name }}</span><span>{{ res.balance }}</span></div></div>
                </div>
                <div class="card">
                    <div class="flex gap-2 mb-2"><input v-model="newExpense.title" placeholder="é …ç›®" class="flex-1"><input v-model.number="newExpense.amount" type="number" placeholder="$" class="w-20"></div>
                    <div class="flex gap-2 mb-2"><button v-for="cat in categories" :key="cat" @click="newExpense.category = cat" class="px-2 py-1 text-xs rounded border" :class="newExpense.category===cat?'bg-blue-500 text-white':''">{{cat}}</button></div>
                    <select v-model="newExpense.payer" class="mb-2 w-full"><option v-for="p in people" :value="p.name">{{p.name}}</option></select>
                    <button @click="addExpense" class="w-full bg-blue-600 text-white py-2 rounded">è¨˜å¸³</button>
                </div>
                <div v-for="exp in expenses" :key="exp.id" class="card flex justify-between">
                    <div><div class="font-bold">{{ exp.title }}</div><div class="text-xs text-gray-500">{{ exp.payer }} ä»˜æ¬¾</div></div>
                    <div class="font-bold">${{ exp.amount }} <button @click="removeExpense(exp.id)" class="text-red-400 ml-2">Ã—</button></div>
                </div>
            </div>

            <div v-if="currentTab === 'settings'" class="p-4 space-y-4">
                <button @click="exitTrip" class="w-full bg-gray-600 text-white py-2 rounded mb-4">ğŸ”™ åˆ‡æ›æ—…ç¨‹</button>
                <button @click="exportItinerary" class="w-full border border-blue-500 text-blue-500 py-2 rounded">ğŸ“¤ åŒ¯å‡ºè¡Œç¨‹</button>
                
                <h3 class="font-bold mt-4">æˆå“¡ç®¡ç†</h3>
                <div class="flex gap-2"><input v-model="newPerson" placeholder="åå­—"><button @click="addPerson" class="bg-gray-800 text-white px-4 rounded">æ–°å¢</button></div>
                <div v-for="p in people" :key="p.id" class="flex justify-between p-2 border-b"><span>{{p.name}}</span><button @click="removePerson(p.id)" class="text-red-500">ç§»é™¤</button></div>
            </div>
        </main>

        <nav class="bg-white border-t flex justify-around p-2 pb-6">
            <button @click="switchTab('itinerary')" class="text-2xl">ğŸ“</button>
            <button @click="switchTab('map')" class="text-2xl">ğŸ—ºï¸</button>
            <button @click="switchTab('money')" class="text-2xl">ğŸ’°</button>
            <button @click="switchTab('settings')" class="text-2xl">âš™ï¸</button>
        </nav>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;
    log("Vue å·²è¼‰å…¥ï¼Œæº–å‚™å•Ÿå‹• App...");

    const app = createApp({
        setup() {
            // â˜… Config â˜…
            const API_URL = 'https://script.google.com/macros/s/AKfycby303KH-yL7YZajdYUwBQEW-lyFmhz5qsCL5KrY73fZSS5wmSfjPZX8qCYxaNP3FnM/exec';
            const GOOGLE_MAPS_API_KEY = 'AIzaSyCLrHk9V-eQby0aDVx31iwFyqmhI-jIs4Q';

            // State
            const currentView = ref('lobby'); const currentTrip = ref(null); const trips = ref([]); 
            const newTripName = ref(''); const newTripCity = ref('');
            const currentTab = ref('itinerary'); const isLoading = ref(false); 
            const currentDay = ref(1); const totalDays = ref(1);
            
            const people = ref([]); const itinerary = ref([]); const expenses = ref([]);
            const newPlace = ref(''); const newTime = ref(''); const newNote = ref(''); const newPerson = ref('');
            const newExpense = ref({ title: '', amount: '', payer: '', involved: [], category: 'é£²é£Ÿ' });
            const categories = ['é£²é£Ÿ', 'äº¤é€š', 'ä½å®¿', 'è³¼ç‰©', 'é–€ç¥¨'];
            const searchResults = ref([]);
            
            // Map
            let mapInstance = null; let markers = []; let autocompleteService = null;

            const generateId = () => Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            const formatTime = (timeStr) => {
                if (!timeStr) return '';
                if (/^\d{1,2}:\d{2}$/.test(timeStr)) return timeStr;
                try {
                    const date = new Date(timeStr);
                    if (isNaN(date.getTime())) return timeStr;
                    return `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                } catch { return timeStr; }
            };

            const loadGoogleMaps = () => {
                if (window.google) return;
                log("æ­£åœ¨è¼‰å…¥ Google Maps...");
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=zh-TW`;
                script.async = true; script.defer = true;
                script.onload = () => { 
                    log("Google Maps è¼‰å…¥æˆåŠŸ");
                    try { autocompleteService = new google.maps.places.AutocompleteService(); } catch(e){ log("Autocomplete åˆå§‹åŒ–å¤±æ•—: " + e); }
                };
                script.onerror = () => log("âŒ Google Maps è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯");
                document.head.appendChild(script);
            };

            const fetchTrips = async () => {
                log("æ­£åœ¨è®€å–æ—…ç¨‹åˆ—è¡¨...");
                isLoading.value = true;
                try {
                    const res = await fetch(`${API_URL}?type=trips`);
                    const data = await res.json();
                    log("æ—…ç¨‹åˆ—è¡¨è®€å–æˆåŠŸ: " + data.length + " ç­†");
                    trips.value = data;
                } catch (e) { log("âŒ è®€å–æ—…ç¨‹å¤±æ•—: " + e); }
                finally { isLoading.value = false; }
            };

            const createTrip = async () => {
                if (!newTripName.value) return;
                isLoading.value = true;
                const id = generateId();
                const newTrip = { id, name: newTripName.value, city: newTripCity.value };
                trips.value.push(newTrip);
                newTripName.value = '';
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', type: 'trips', data: newTrip }) });
                isLoading.value = false;
            };

            const selectTrip = (trip) => {
                log("é¸æ“‡æ—…ç¨‹: " + trip.name);
                currentTrip.value = trip;
                itinerary.value = []; expenses.value = []; people.value = [];
                currentView.value = 'app';
                fetchData();
            };

            const fetchData = async () => {
                if (!currentTrip.value) return;
                isLoading.value = true;
                const tid = currentTrip.value.id;
                try {
                    log("æ­£åœ¨è®€å–è©³ç´°è³‡æ–™...");
                    const [resItin, resExp, resPpl] = await Promise.all([
                        fetch(`${API_URL}?type=itinerary&tripId=${tid}`),
                        fetch(`${API_URL}?type=expenses&tripId=${tid}`),
                        fetch(`${API_URL}?type=people&tripId=${tid}`)
                    ]);
                    itinerary.value = await resItin.json();
                    expenses.value = await resExp.json();
                    people.value = await resPpl.json();
                    if(people.value.length) newExpense.value.payer = people.value[0].name;
                    
                    // è¨ˆç®—å¤©æ•¸
                    if (itinerary.value.length > 0) {
                        const max = itinerary.value.reduce((m, i) => Math.max(m, parseInt(i.day||1)), 1);
                        totalDays.value = max;
                    }
                    log("è©³ç´°è³‡æ–™è®€å–å®Œæˆ");
                } catch(e) { log("âŒ è©³ç´°è³‡æ–™è®€å–å¤±æ•—: " + e); }
                finally { isLoading.value = false; }
            };

            // Search
            const searchPlacesInput = () => {
                if (!newPlace.value || !autocompleteService) return;
                autocompleteService.getPlacePredictions({ input: newPlace.value }, (predictions, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) searchResults.value = predictions;
                });
            };

            const selectPlace = (item) => {
                newPlace.value = item.structured_formatting.main_text;
                // ç›´æ¥å­˜ä¸‹ place_idï¼Œæ–°å¢æ™‚å†å»æŸ¥åº§æ¨™
                newPlace.value = item.structured_formatting.main_text; 
                addPlace(item.place_id); 
                searchResults.value = [];
            };

            const addPlace = async (googlePlaceId = null) => {
                if(!newPlace.value) return;
                const id = generateId();
                const item = { 
                    id, name: newPlace.value, day: currentDay.value, 
                    time: newTime.value, message: newNote.value,
                    lat: '', lng: '', place_id: googlePlaceId 
                };
                
                // å¦‚æœæœ‰ Google Place IDï¼Œå…ˆæŸ¥åº§æ¨™å†é¡¯ç¤º
                if (googlePlaceId && window.google) {
                    const dummy = document.createElement('div');
                    const service = new google.maps.places.PlacesService(dummy);
                    service.getDetails({ placeId: googlePlaceId }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            item.lat = place.geometry.location.lat();
                            item.lng = place.geometry.location.lng();
                            // æ›´æ–°å‰ç«¯èˆ‡å¾Œç«¯
                            itinerary.value.push(item);
                            sendToApi('add', 'itinerary', item);
                        }
                    });
                } else {
                    itinerary.value.push(item);
                    sendToApi('add', 'itinerary', item);
                }
                
                newPlace.value = ''; newNote.value = '';
            };

            const removePlace = (id) => {
                const idx = itinerary.value.findIndex(i => i.id === id);
                if (idx > -1) {
                    itinerary.value.splice(idx, 1);
                    sendToApi('del', 'itinerary', id);
                }
            };
            
            const editPlace = (item) => {
                newPlace.value = item.name;
                newTime.value = formatTime(item.time);
                newNote.value = item.message;
                removePlace(item.id);
            };

            const sendToApi = async (action, type, data) => {
                const body = { action, type };
                if (action === 'add') {
                    data.trip_id = currentTrip.value.id;
                    body.data = data;
                } else {
                    body.id = data;
                }
                fetch(API_URL, { method: 'POST', body: JSON.stringify(body) }).catch(e => log("âŒ å„²å­˜å¤±æ•—: " + e));
            };

            // Map Logic
            const switchTab = (tab) => {
                currentTab.value = tab;
                if (tab === 'map') {
                    nextTick(() => {
                        if (!mapInstance && window.google) {
                            mapInstance = new google.maps.Map(document.getElementById('map'), {
                                center: { lat: 23.6, lng: 121 }, zoom: 8
                            });
                        }
                        updateMapMarkers();
                    });
                }
            };

            const updateMapMarkers = () => {
                if (!mapInstance) return;
                // æ¸…é™¤èˆŠ Marker
                markers.forEach(m => m.setMap(null)); markers = [];
                const bounds = new google.maps.LatLngBounds();
                let hasPoint = false;

                itinerary.value.forEach(item => {
                    if (item.lat && item.lng) {
                        const pos = { lat: parseFloat(item.lat), lng: parseFloat(item.lng) };
                        const marker = new google.maps.Marker({
                            position: pos, map: mapInstance, label: item.day.toString(), title: item.name
                        });
                        markers.push(marker);
                        bounds.extend(pos);
                        hasPoint = true;
                    }
                });
                
                if (hasPoint) mapInstance.fitBounds(bounds);
            };
            
            const fitBoundsToTrip = () => updateMapMarkers();

            // Other
            const addNewDay = () => { totalDays.value++; currentDay.value = totalDays.value; };
            const addExpense = () => { /* ... (ç°¡åŒ–ä»¥ç¸®çŸ­ä»£ç¢¼é•·åº¦) ... */ };
            const exportItinerary = () => { /* ... */ };
            const exitTrip = () => { currentView.value = 'lobby'; currentTrip.value = null; };

            onMounted(() => {
                fetchTrips();
                loadGoogleMaps();
            });

            return {
                currentView, trips, newTripName, newTripCity, createTrip, selectTrip, exitTrip,
                currentTab, switchTab, isLoading, currentTrip, currentDay, totalDays, addNewDay,
                itinerary, expenses, people,
                newPlace, newTime, newNote, searchResults, searchPlacesInput, selectPlace,
                addPlace, removePlace, editPlace,
                newExpense, categories, addExpense,
                fetchData, formatTime, fitBoundsToTrip,
                filteredItinerary: computed(() => itinerary.value.filter(i => parseInt(i.day) == currentDay.value)),
                // é€™è£¡æš«æ™‚çœç•¥åˆ†å¸³é‚è¼¯ä»¥ç¢ºä¿æ ¸å¿ƒé‹ä½œ
                balanceSheet: computed(() => []), 
                totalExpense: computed(() => 0),
                categoryAnalysis: computed(() => [])
            };
        }
    });

    app.mount('#app');
</script>
</body>
</html>
