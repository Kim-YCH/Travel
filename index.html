<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å‡ºç™¼å›‰</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; }
    .mobile-container { max-width: 480px; margin: 0 auto; background: #f8fafc; height: 100%; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    .content-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; display: flex; flex-direction: column; background: #f8fafc; }
    .content-fixed { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
    .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 16px; margin-bottom: 12px; flex-shrink: 0; }

    input, select {
      -webkit-user-select: text; user-select: text;
      border: 1px solid #e2e8f0;
      background-color: #ffffff;
      height: 54px;
      padding: 0 16px;
      font-size: 16px;
      border-radius: 12px;
      width: 100%;
      outline: none;
      transition: all 0.2s;
    }
    input:focus, select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    .day-tab-active { background: #2563eb; color: white; border-color: #2563eb; }
    .day-tab-inactive { background: white; color: #64748b; border-color: #e2e8f0; }
    .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .loading-bar { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: #2563eb; z-index: 9999; animation: loading 1s infinite linear; }
    @keyframes loading { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }

    #map { width: 100%; height: 100%; background-color: #e5e7eb; border-radius: 14px; }

    .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 50; max-height: 250px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 12px; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .suggestion-item { padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .suggestion-item:hover { background-color: #f0f9ff; }

    .checkbox-wrapper input:checked + div { background-color: #dbeafe; color: #1e40af; border-color: #2563eb; font-weight: bold; }
    .stat-bar { transition: width 0.5s ease-in-out; }
    .gmnoprint a, .gmnoprint span, .gm-style-cc { display:none; } img[src*="google"] { display: inline !important; }

    .drag-handle { cursor: grab; }
    .drag-handle:active { cursor: grabbing; }

    .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .modal-card { width: 92%; max-width: 360px; background: #fff; border-radius: 18px; padding: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.25); }

    .day-btn-wrap { position: relative; }
    .day-x {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(0,0,0,0.15);
      color: white;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .day-x:active { transform: scale(0.95); }

    .small-btn {
      height: 46px;
      border-radius: 12px;
      font-weight: 800;
      display:flex;
      align-items:center;
      justify-content:center;
    }
  </style>
</head>
<body>

<div id="app" class="mobile-container">
  <div v-if="isLoading" class="loading-bar"></div>

  <div v-if="currentView === 'lobby'" class="content-scroll p-6 justify-center bg-gray-50">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">âœˆï¸ å‡ºç™¼å›‰</h1>

    <div class="space-y-4 mb-8">
      <div v-for="trip in trips" :key="trip.id" @click="selectTrip(trip)"
           class="card flex justify-between items-center active:scale-95 transition cursor-pointer border-l-4 border-blue-500 hover:shadow-md">
        <div>
          <div class="font-bold text-xl text-gray-900">{{ trip.name }}</div>
          <div class="text-sm text-gray-500">ğŸ“ {{ trip.city }}</div>
        </div>
        <div class="text-2xl text-gray-300">âœ</div>
      </div>
      <div v-if="trips.length === 0" class="text-center text-gray-400 py-10">å°šç„¡æ—…ç¨‹</div>
    </div>

    <div class="card border border-blue-100">
      <h3 class="font-bold text-gray-700 mb-3">æ–°å¢æ—…ç¨‹</h3>
      <div class="flex flex-col gap-3">
        <input v-model="newTripName" placeholder="æ—…ç¨‹åç¨±">
        <input v-model="newTripCity" placeholder="ä¸»è¦åŸå¸‚">
        <button @click="createTrip" class="w-full bg-blue-600 text-white h-[54px] rounded-xl font-bold shadow active:scale-95 transition text-lg" :disabled="isLoading">å»ºç«‹</button>
      </div>
    </div>
  </div>

  <div v-else class="flex flex-col h-full overflow-hidden">
    <header class="bg-blue-600 text-white p-4 pt-12 pb-4 shadow-md sticky top-0 z-50 flex justify-between items-center flex-shrink-0">
      <div>
        <h1 class="text-lg font-bold tracking-wide">{{ currentTrip.name }}</h1>
        <div class="text-xs text-blue-200">
          Day {{ currentDay }} | {{ dayLabel(currentDay) }} | {{ currentTrip.city }}
        </div>
      </div>
      <button @click="fetchData" class="text-xs bg-white/20 px-3 py-1 rounded-full text-white backdrop-blur-sm active:scale-95">â†» åŒæ­¥</button>
    </header>

    <main :class="currentTab === 'map' ? 'content-fixed' : 'content-scroll'" class="bg-gray-50">

      <div v-if="currentTab === 'itinerary'" class="p-4 space-y-4 pb-24">
        <div class="flex overflow-x-auto pb-2 gap-2 no-scrollbar items-center flex-shrink-0 relative z-50">
          <div v-for="d in totalDays" :key="d" class="day-btn-wrap flex-shrink-0">
            <button
              @click.stop.prevent="onDayClick(d)"
              @dblclick.stop.prevent="onDayDblClick(d)"
              class="px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition"
              :class="currentDay === d ? 'day-tab-active' : 'day-tab-inactive'">
              <div>Day {{ d }}</div>
              <div class="text-[10px] font-normal opacity-90">
                {{ dayLabel(d) || 'â€”' }}
              </div>
            </button>

            <div
              class="day-x"
              v-if="totalDays > 1"
              @click.stop.prevent="deleteDay(d)">Ã—</div>
          </div>

          <button @click="addNewDay" class="px-3 py-2 rounded-full border border-gray-300 bg-white font-bold flex-shrink-0 shadow-sm text-gray-600">+</button>
        </div>

        <div class="card relative space-y-2 flex-shrink-0">
          <div class="flex gap-2 relative">
            <input v-model="newPlace" @input="searchPlacesInput" type="text" :placeholder="'æœå°‹ ' + currentTrip.city + '...'" class="flex-1 font-bold">
            <button @click="addPlace" class="bg-blue-600 text-white w-[54px] h-[54px] rounded-xl text-3xl shadow active:scale-95 transition flex items-center justify-center pb-1 flex-shrink-0" :disabled="isLoading">+</button>

            <div v-if="newPlace.length > 0 && (searchResults.length > 0 || isSearching || isCoordinateMode)" class="suggestions-list">
              <div v-if="isSearching" class="p-3 text-center text-gray-400 text-sm">æœå°‹ä¸­...</div>

              <div v-if="isCoordinateMode" @click="useCoordinateInput" class="suggestion-item bg-green-50 hover:bg-green-100 border-green-200">
                <span class="text-xl">ğŸ“</span>
                <div>
                  <div class="font-bold text-green-700 text-sm">{{ resolvedCoordName || 'åº§æ¨™æ¨¡å¼' }}</div>
                  <div class="text-xs text-green-600">é»æ“Šä½¿ç”¨</div>
                </div>
              </div>

              <div v-for="item in searchResults" :key="item.place_id" @click="selectPlace(item)" class="suggestion-item hover:bg-blue-50">
                <span class="text-xl">ğŸ“</span>
                <div class="overflow-hidden">
                  <div class="font-bold text-gray-800 text-sm truncate">{{ item.structured_formatting.main_text }}</div>
                  <div class="text-xs text-gray-500 truncate">{{ item.structured_formatting.secondary_text }}</div>
                </div>
              </div>

              <div v-if="!isCoordinateMode" @click="searchInGoogleMaps" class="suggestion-item hover:bg-gray-100 border-t-2 border-gray-100 cursor-pointer">
                <span class="text-xl">ğŸ”</span>
                <div class="flex-1">
                  <div class="font-bold text-blue-600 text-sm">æ‰¾ä¸åˆ°ï¼Ÿå» Google Maps æ‰¾</div>
                  <div class="text-xs text-gray-400">å¯è¤‡è£½åº§æ¨™è²¼å›ä¾†</div>
                </div>
                <span class="text-gray-300 text-lg">âœ</span>
              </div>
            </div>
          </div>

          <div class="flex gap-2">
            <input v-model="newTime" type="time" class="w-1/3 text-center font-mono">
            <input v-model="newNote" type="text" placeholder="å‚™è¨»..." class="flex-1">
          </div>
        </div>

        <div class="space-y-3 pb-20" ref="itineraryListEl">
          <div v-for="place in filteredItinerary" :key="place.id" :data-id="place.id" class="card flex justify-between items-start active:scale-[0.99] transition">
            <div class="flex items-start gap-2 flex-1">
              <div class="drag-handle text-gray-300 select-none text-2xl leading-none pt-1">â‰¡</div>

              <div class="flex-1" @click="openGoogleMap(place)">
                <div class="flex items-center gap-2 flex-wrap mb-1">
                  <span v-if="place.time" class="text-blue-600 font-mono font-bold text-sm bg-blue-50 px-2 py-0.5 rounded border border-blue-100">{{ formatTime(place.time) }}</span>
                  <span class="font-bold text-lg text-gray-800">{{ place.name }}</span>
                </div>
                <div class="flex gap-2 items-center">
                  <span v-if="place.lat && place.lng" class="text-[10px] text-green-600 bg-green-100 px-1.5 rounded font-bold border border-green-200">å·²å®šä½</span>
                  <span v-else class="text-[10px] text-red-400 bg-red-50 px-1.5 rounded font-bold border border-red-200">ç„¡åº§æ¨™</span>
                  <div v-if="place.message" class="text-sm text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">ğŸ“ {{ place.message }}</div>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-1 pl-3 border-l ml-2">
              <button @click.stop="removePlace(place.id)" class="text-gray-300 hover:text-red-500 px-2 text-xl font-bold" :disabled="isLoading">Ã—</button>
            </div>
          </div>

          <div v-if="filteredItinerary.length===0" class="text-center text-gray-400 mt-10">å°šç„¡è¡Œç¨‹</div>
        </div>
      </div>

      <div v-if="currentTab === 'map'" class="content-fixed p-4 w-full">
        <div class="flex flex-col gap-2 flex-shrink-0">
          <div class="flex shadow-lg rounded-xl overflow-hidden border border-gray-200">
            <input v-model="mapSearchQuery" @keyup.enter="searchCityAndJump"
                   type="text" :placeholder="'è·³è½‰è‡³ ' + (currentTrip.city || '') + '...'"
                   class="flex-1 p-3 border-0 outline-none h-[54px] text-gray-900 bg-white" style="border-radius: 0;">
            <button @click="searchCityAndJump" class="bg-blue-600 text-white px-4 font-bold h-[54px]">å‰å¾€</button>
          </div>
          <button @click="fitBoundsToTrip" class="bg-white text-gray-700 font-bold py-2.5 rounded-xl shadow-sm border border-gray-200 active:scale-95 text-sm flex justify-center items-center gap-1">
            <span>ğŸ”„</span> é¡¯ç¤ºè¡Œç¨‹
          </button>
        </div>

        <div id="map" class="shadow-inner mt-2" style="height: calc(100% - 140px);"></div>
        <div v-if="!isMapReady" class="text-center text-gray-400 mt-4 text-sm absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">æ­£åœ¨è¼‰å…¥åœ°åœ–...</div>
      </div>

      <div v-if="currentTab === 'money'" class="p-4 space-y-4 pb-24">
        <div class="card bg-gradient-to-r from-gray-800 to-gray-700 text-white shadow-lg">
          <div class="flex justify-between items-end mb-4"><span class="text-gray-400 text-sm">ç¸½æ”¯å‡º</span><span class="text-3xl font-bold tracking-wider">${{ totalExpense }}</span></div>
          <div class="space-y-1 border-t border-gray-600 pt-3 text-sm">
            <div v-for="res in balanceSheet" :key="res.name" class="flex justify-between">
              <span>{{ res.name }}</span>
              <span :class="res.balance>=0?'text-green-400':'text-red-400'" class="font-bold">{{ res.balance > 0 ? '+' : ''}}{{ Math.round(res.balance) }}</span>
            </div>
          </div>
        </div>

        <div v-if="categoryAnalysis.length > 0" class="card">
          <h3 class="font-bold text-gray-700 text-sm mb-3">ğŸ“Š æ¶ˆè²»åˆ†æ</h3>
          <div class="space-y-3">
            <div v-for="cat in categoryAnalysis" :key="cat.name" class="text-xs">
              <div class="flex justify-between mb-1">
                <span class="text-gray-600">{{ cat.name }}</span>
                <span class="font-bold text-gray-800">${{ cat.total }} ({{ totalExpense ? ((cat.total/totalExpense)*100).toFixed(0) : 0 }}%)</span>
              </div>
              <div class="w-full bg-gray-100 rounded-full h-2">
                <div class="bg-blue-500 h-2 rounded-full stat-bar" :style="{ width: totalExpense ? (cat.total/totalExpense)*100 + '%' : '0%' }"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card border border-blue-100">
          <div class="grid grid-cols-3 gap-3 mb-3">
            <input v-model="newExpense.title" placeholder="é …ç›®" class="col-span-2">
            <input v-model.number="newExpense.amount" type="number" placeholder="$" class="font-mono font-bold">
          </div>
          <div class="mb-3 flex gap-2 overflow-x-auto no-scrollbar pb-1">
            <button v-for="cat in categories" :key="cat" @click="newExpense.category = cat"
                    class="px-3 py-1.5 rounded-full border text-xs font-bold whitespace-nowrap transition"
                    :class="newExpense.category === cat ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-200'">{{ cat }}</button>
          </div>
          <div class="mb-3 flex gap-2 items-center">
            <span class="text-lg text-gray-500 font-bold w-10 text-center">ä»˜æ¬¾</span>
            <select v-model="newExpense.payer" class="flex-1">
              <option disabled value="">è«‹é¸æ“‡</option>
              <option v-for="(p, index) in people" :value="p.name">{{ p.name || 'æˆå“¡ ' + (index+1) }}</option>
            </select>
          </div>
          <div class="mb-4">
            <span class="text-xs text-gray-500 font-bold block mb-2 ml-1">åˆ†æ”¤çµ¦ (é»æ“Šåˆ‡æ›)</span>
            <div class="flex flex-wrap gap-2">
              <label v-for="(p, index) in people" :key="p.id" class="checkbox-wrapper cursor-pointer relative">
                <input type="checkbox" :value="p.name" v-model="newExpense.involved" class="absolute opacity-0 w-0 h-0">
                <div class="px-3 py-1.5 rounded-full border border-gray-200 text-sm bg-white transition select-none text-gray-700 hover:bg-gray-50">{{ p.name || 'æˆå“¡ ' + (index+1) }}</div>
              </label>
            </div>
          </div>
          <button @click="addExpense" class="w-full bg-blue-600 text-white h-[54px] rounded-xl font-bold shadow active:scale-95 transition text-lg" :disabled="isLoading">è¨˜å¸³</button>
        </div>

        <div class="space-y-2">
          <div v-for="(exp, idx) in expenses" :key="exp.id" class="card flex justify-between items-center py-3 border-l-4 border-gray-300">
            <div>
              <div class="font-bold text-gray-800 text-lg">
                {{ exp.title }}
                <span class="text-xs font-normal text-white bg-gray-400 px-1.5 py-0.5 rounded ml-1">{{ exp.category }}</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">{{ exp.payer }} å…ˆä»˜ <span class="text-gray-300">|</span> {{ formatInvolved(exp.involved) }} åˆ†æ”¤</div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="font-bold text-xl text-gray-800 font-mono">${{ exp.amount }}</span>
              <button @click="removeExpense(idx)" class="text-gray-300 hover:text-red-500 px-2">Ã—</button>
            </div>
          </div>
        </div>
      </div>

      <div v-if="currentTab === 'settings'" class="p-4 space-y-4 pb-24">
        <button @click="exitTrip" class="w-full bg-gray-700 text-white h-[54px] rounded-lg font-bold mb-6 shadow text-lg">ğŸ”™ åˆ‡æ›æ—…ç¨‹</button>

        <h3 class="font-bold text-gray-700 ml-1">ğŸ“‹ è³‡æ–™ç®¡ç†</h3>
        <button @click="exportItinerary" class="w-full bg-white text-blue-600 border border-blue-200 h-[54px] rounded-lg font-bold shadow-sm active:scale-95 transition flex justify-center items-center gap-2"><span>ğŸ“¤</span> åŒ¯å‡ºç´”æ–‡å­—è¡Œç¨‹</button>

        <h3 class="font-bold text-gray-700 mt-6 ml-1">ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
        <div class="flex gap-2">
          <input v-model="newPerson" placeholder="åå­—" class="flex-1">
          <button @click="addPerson" class="bg-gray-800 text-white px-4 rounded-lg font-bold">æ–°å¢</button>
        </div>
        <div class="space-y-2 mb-10">
          <div v-for="(p, idx) in people" :key="p.id" class="flex justify-between items-center p-3 bg-white rounded border border-gray-100 shadow-sm">
            <span class="font-bold text-gray-800">{{ p.name || 'æˆå“¡ ' + (idx + 1) }}</span>
            <button @click="removePerson(idx)" class="text-red-400 font-bold px-2">ç§»é™¤</button>
          </div>
        </div>

        <div class="border-t pt-4 mt-4 text-center">
          <button @click="deleteTripTotally" class="w-full bg-red-500 text-white border border-red-600 py-3 rounded-lg font-bold mb-3 shadow-md hover:bg-red-600 transition">âŒ åˆªé™¤æ­¤æ—…ç¨‹</button>
        </div>
      </div>

    </main>

    <nav class="bg-white border-t flex justify-around pb-safe pt-2 pb-2 z-50 flex-shrink-0 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
      <button @click="switchTab('itinerary')" class="flex flex-col items-center w-full transition duration-200" :class="currentTab==='itinerary'?'text-blue-600 scale-110':'text-gray-400'"><span class="text-2xl mb-0.5">ğŸ“</span><span class="text-[10px] font-bold">è¡Œç¨‹</span></button>
      <button @click="switchTab('map')" class="flex flex-col items-center w-full transition duration-200" :class="currentTab==='map'?'text-purple-600 scale-110':'text-gray-400'"><span class="text-2xl mb-0.5">ğŸ—ºï¸</span><span class="text-[10px] font-bold">åœ°åœ–</span></button>
      <button @click="switchTab('money')" class="flex flex-col items-center w-full transition duration-200" :class="currentTab==='money'?'text-green-600 scale-110':'text-gray-400'"><span class="text-2xl mb-0.5">ğŸ’°</span><span class="text-[10px] font-bold">åˆ†å¸³</span></button>
      <button @click="switchTab('settings')" class="flex flex-col items-center w-full transition duration-200" :class="currentTab==='settings'?'text-gray-800 scale-110':'text-gray-400'"><span class="text-2xl mb-0.5">âš™ï¸</span><span class="text-[10px] font-bold">è¨­å®š</span></button>
    </nav>
  </div>

  <div v-if="showDayModal" class="modal-mask" @click.self="closeDayModal">
    <div class="modal-card space-y-3">
      <div class="font-bold text-gray-800 text-lg">Day{{ modalDay }} è¨­å®š</div>

      <template v-if="modalDay === 1">
        <div class="text-sm text-gray-500">è¨­å®š Day1 æ—¥æœŸï¼ˆå…¶ä»–å¤©è‡ªå‹•æ¨ç®—ï¼‰</div>
        <input type="date" v-model="dateInput">
        <button class="w-full bg-blue-600 text-white small-btn active:scale-95" @click="applyDay1Date">å¥—ç”¨ Day1 æ—¥æœŸ</button>
      </template>

      <div class="border-t pt-3">
        <div class="text-sm text-gray-500 mb-2">äº¤æ›å¤©æ•¸ï¼ˆDay{{ modalDay }} â†” å…¶ä»–å¤©ï¼‰</div>
        <div class="flex gap-2">
          <select v-model.number="swapTargetDay" class="flex-1">
            <option :value="0" disabled>é¸æ“‡è¦äº¤æ›çš„å¤©æ•¸</option>
            <option v-for="d in totalDays" :key="'swap'+d" :value="d" v-if="d !== modalDay">Day {{ d }}</option>
          </select>
          <button class="w-[120px] bg-gray-900 text-white small-btn active:scale-95" @click="swapWithDay">äº¤æ›</button>
        </div>

      </div>

      <button class="w-full border text-gray-600 small-btn active:scale-95" @click="closeDayModal">é—œé–‰</button>
    </div>
  </div>

</div>

<script>
const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

createApp({
  setup() {
    const API_URL = 'https://script.google.com/macros/s/AKfycbwYDtsU5BZ35LS7XNV2_pd4qrUfGwqaz0O_rMU45yyBBtjIJaUyYRxu_4cL0m1TJOJ8/exec';
    const GOOGLE_MAPS_API_KEY = 'AIzaSyCLrHk9V-eQby0aDVx31iwFyqmhI-jIs4Q';

    const currentView = ref('lobby');
    const currentTrip = ref(null);
    const trips = ref([]);
    const newTripName = ref('');
    const newTripCity = ref('');

    const currentTab = ref('itinerary');
    const isLoading = ref(false);

    const currentDay = ref(1);
    const totalDays = ref(1);

    const people = ref([]);
    const itinerary = ref([]);
    const expenses = ref([]);

    const newPlace = ref('');
    const newTime = ref('');
    const newNote = ref('');
    const newPerson = ref('');
    const newExpense = ref({ title: '', amount: '', payer: '', involved: [], category: 'é£²é£Ÿ' });
    const categories = ['é£²é£Ÿ', 'äº¤é€š', 'ä½å®¿', 'è³¼ç‰©', 'é–€ç¥¨', 'å…¶ä»–'];

    const searchResults = ref([]);
    const isSearching = ref(false);
    const isCoordinateMode = ref(false);
    const resolvedCoordName = ref('');
    const selectedLat = ref(null);
    const selectedLng = ref(null);
    const selectedPlaceData = ref(null);

    const mapSearchQuery = ref('');
    const isMapReady = ref(false);
    let mapInstance = null;
    let markers = [];
    let infoWindow = null;
    let autocompleteService = null;

    const itineraryListEl = ref(null);
    let sortable = null;

    const showDayModal = ref(false);
    const modalDay = ref(1);
    const dateInput = ref('');
    const swapTargetDay = ref(0);

    const generateId = () => Date.now() + '_' + Math.floor(Math.random() * 1000);

    const pad2 = (n) => String(n).padStart(2, '0');
    const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const parseYMD = (s) => {
      if (!s) return null;
      const p = String(s).split('-');
      if (p.length !== 3) return null;
      const y = parseInt(p[0],10), m = parseInt(p[1],10), d = parseInt(p[2],10);
      if (!y || !m || !d) return null;
      return new Date(y, m-1, d, 12, 0, 0);
    };
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };

    const dayLabel = (day) => {
      const base = parseYMD(currentTrip.value?.start_date);
      if (!base) return '';
      const dt = addDays(base, day-1);
      const wk = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dt.getDay()];
      return `${dt.getFullYear()}/${pad2(dt.getMonth()+1)}/${pad2(dt.getDate())} (${wk})`;
    };

    const formatInvolved = (list) => (!list || list.length === 0) ? 'å…¨å“¡' : (Array.isArray(list) ? list.join(', ') : list);

    const formatTime = (timeStr) => {
      if (!timeStr) return '';
      if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}$/.test(timeStr)) return timeStr;
      try {
        const date = new Date(timeStr);
        if (isNaN(date.getTime())) return timeStr;
        const h = date.getHours().toString().padStart(2, '0');
        const m = date.getMinutes().toString().padStart(2, '0');
        return `${h}:${m}`;
      } catch (e) { return timeStr; }
    };

    const timeToNum = (t) => {
      const s = formatTime(t);
      if (!s) return 999999;
      const p = s.split(':');
      if (p.length !== 2) return 999999;
      const hh = parseInt(p[0],10), mm = parseInt(p[1],10);
      if (Number.isNaN(hh) || Number.isNaN(mm)) return 999999;
      return hh*60+mm;
    };

    const jsonp = (url, timeoutMs = 15000) => new Promise((resolve, reject) => {
      const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      const sep = url.includes('?') ? '&' : '?';
      const full = `${url}${sep}callback=${cb}`;

      const s = document.createElement('script');
      const t = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);

      const cleanup = () => {
        clearTimeout(t);
        if (s.parentNode) s.parentNode.removeChild(s);
        try { delete window[cb]; } catch (e) { window[cb] = undefined; }
      };

      window[cb] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };
      s.src = full;
      document.head.appendChild(s);
    });

    const apiGet = async (paramsObj) => {
      const qs = new URLSearchParams(paramsObj).toString();
      return await jsonp(`${API_URL}?${qs}`);
    };

    const postJSON = async (payload) => {
      const p = { ...payload };
      if (p.data && typeof p.data === 'object') p.data = JSON.stringify(p.data);
      return await apiGet(p);
    };

    const orderKey = (tripId, day) => `trip_${tripId}_day_${day}_order`;
    const setOrderIds = (tripId, day, ids) => localStorage.setItem(orderKey(tripId, day), JSON.stringify(ids || []));
    const getOrderIds = (tripId, day) => {
      try {
        const raw = localStorage.getItem(orderKey(tripId, day));
        const ids = JSON.parse(raw);
        return Array.isArray(ids) ? ids : null;
      } catch(e){ return null; }
    };
    const clearOrderIds = (tripId, day) => localStorage.removeItem(orderKey(tripId, day));

    const saveOrderToDB = async (tripId, day, ids) => {
      await postJSON({ action: 'save_order', tripId, day: String(day), order: (ids||[]).join(',') });
    };

    const escapeHtml = (s) => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");

    const loadGoogleMaps = () => {
      if (window.google && window.google.maps) {
        try { autocompleteService = new google.maps.places.AutocompleteService(); } catch(e){}
        isMapReady.value = true;
        return Promise.resolve();
      }
      return new Promise((resolve) => {
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=zh-TW`;
        s.async = true; s.defer = true;
        s.onload = () => {
          try { autocompleteService = new google.maps.places.AutocompleteService(); } catch(e){}
          isMapReady.value = true;
          resolve();
        };
        s.onerror = () => resolve();
        document.head.appendChild(s);
      });
    };

    const initGoogleMap = () => {
      if (!window.google) return;
      const mapEl = document.getElementById('map'); if (!mapEl) return;
      if (!mapInstance) {
        mapInstance = new google.maps.Map(mapEl, {
          center: { lat: 23.6, lng: 121 },
          zoom: 8,
          streetViewControl: false,
          mapTypeControl: false,
          fullscreenControl: false
        });
        infoWindow = new google.maps.InfoWindow();
      }
      updateMapMarkers();
    };

    const updateMapMarkers = () => {
      if (!mapInstance || !window.google) return;
      markers.forEach(m => m.setMap(null));
      markers = [];

      const bounds = new google.maps.LatLngBounds();
      let hasPoint = false;

      itinerary.value.forEach(item => {
        if (item.lat && item.lng) {
          const d = item.day ? parseInt(item.day,10) : 1;

          const marker = new google.maps.Marker({
            position: { lat: Number(item.lat), lng: Number(item.lng) },
            map: mapInstance,
            label: { text: d.toString(), color: "white" },
            title: item.name
          });

          marker.addListener("click", () => {
            const link = item.place_id
              ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name)}&query_place_id=${item.place_id}`
              : `https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}`;

            infoWindow.setContent(
              `<div style="padding:6px; color:#111">
                <b>${escapeHtml(item.name || '')}</b><br/>
                <span style="font-size:12px; color:#555">${escapeHtml(formatTime(item.time)||'')} ${escapeHtml(item.message||'')}</span><br/>
                <a href="${link}" target="_blank" style="color:#2563eb;">Google Maps</a>
              </div>`
            );
            infoWindow.open(mapInstance, marker);
          });

          markers.push(marker);
          bounds.extend(marker.getPosition());
          hasPoint = true;
        }
      });

      if (hasPoint) mapInstance.fitBounds(bounds);
      else if (currentTrip.value?.city && window.google) {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: currentTrip.value.city }, (results, status) => {
          if (status === 'OK' && results[0]) {
            mapInstance.setCenter(results[0].geometry.location);
            mapInstance.setZoom(12);
          }
        });
      }
    };

    const fitBoundsToTrip = () => updateMapMarkers();

    const searchCityAndJump = () => {
      if(!mapSearchQuery.value || !window.google || !mapInstance) return;
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: mapSearchQuery.value }, (results, status) => {
        if (status === 'OK' && results[0]) {
          mapInstance.setCenter(results[0].geometry.location);
          mapInstance.setZoom(13);
        }
      });
    };

    const fetchTrips = async () => {
      isLoading.value = true;
      try {
        const data = await apiGet({ type: 'trips' });
        trips.value = Array.isArray(data) ? data : [];
      } finally { isLoading.value = false; }
    };

    const createTrip = async () => {
      const name = newTripName.value.trim();
      if(!name) return;

      const id = generateId();
      const newTrip = { id, name, city: newTripCity.value || '', start_date: '' };

      trips.value.push(newTrip);
      newTripName.value = ''; newTripCity.value = '';

      await postJSON({ action: 'add', type: 'trips', data: newTrip });
    };

    const selectTrip = (trip) => {
      if(!trip) return;
      currentTrip.value = trip;
      itinerary.value = [];
      expenses.value = [];
      people.value = [];
      currentDay.value = 1;
      totalDays.value = 1;
      currentView.value = 'app';
      fetchData();
    };

    const exitTrip = () => {
      currentView.value = 'lobby';
      currentTrip.value = null;
      fetchTrips();
    };

    const deleteTripTotally = async () => {
      if(!confirm('ç¢ºå®šç§»é™¤ï¼Ÿ')) return;
      await postJSON({ action: 'del', type: 'trips', id: currentTrip.value.id });
      exitTrip();
      await fetchTrips();
    };

    const fetchData = async () => {
      if(!currentTrip.value) return;
      isLoading.value = true;
      const tripId = currentTrip.value.id;

      try {
        const [itinData, expData, pplData, tripsAll] = await Promise.all([
          apiGet({ type:'itinerary', tripId }),
          apiGet({ type:'expenses', tripId }),
          apiGet({ type:'people', tripId }),
          apiGet({ type:'trips' })
        ]);

        itinerary.value = Array.isArray(itinData) ? itinData : [];
        expenses.value = Array.isArray(expData) ? expData : [];
        const ppl = Array.isArray(pplData) ? pplData : [];
        people.value = ppl.length ? ppl : [{id:'default', name:'æˆ‘'}];

        if (people.value.length) {
          newExpense.value.payer = people.value[0].name;
          newExpense.value.involved = people.value.map(p=>p.name);
        }

        const t = (Array.isArray(tripsAll) ? tripsAll : []).find(x => String(x.id) === String(tripId));
        if (t) {
          currentTrip.value.start_date = t.start_date || '';
          const idx = trips.value.findIndex(x => String(x.id) === String(tripId));
          if (idx !== -1) trips.value[idx] = t;
        }

        const maxDay = itinerary.value.reduce((m, it) => Math.max(m, it.day ? parseInt(it.day,10) : 1), 1);
        totalDays.value = Math.max(1, maxDay, totalDays.value);

        await nextTick();
        initSortable();
        if (currentTab.value === 'map') {
          initGoogleMap();
          if (mapInstance && window.google) {
            google.maps.event.trigger(mapInstance, 'resize');
          }
        }
        updateMapMarkers();
      } finally {
        isLoading.value = false;
      }
    };

    const onDayClick = async (d) => {
      currentDay.value = d;
      await nextTick();
      initSortable();
    };

    const onDayDblClick = (d) => {
      modalDay.value = d;
      if (d === 1) {
        const base = parseYMD(currentTrip.value?.start_date);
        dateInput.value = toYMD(base || new Date());
      }
      swapTargetDay.value = 0;
      showDayModal.value = true;
    };

    const closeDayModal = () => { showDayModal.value = false; };

    const applyDay1Date = async () => {
      const pick = parseYMD(dateInput.value);
      if (!pick || !currentTrip.value) { showDayModal.value = false; return; }

      const ymd = toYMD(pick);
      currentTrip.value.start_date = ymd;

      const idx = trips.value.findIndex(t => String(t.id) === String(currentTrip.value.id));
      if (idx !== -1) trips.value[idx].start_date = ymd;

      isLoading.value = true;
      try {
        await postJSON({ action:'set_trip_start_date', type:'trips', tripId: currentTrip.value.id, start_date: ymd });
      } finally {
        isLoading.value = false;
        showDayModal.value = false;
      }
    };

    const swapWithDay = async () => {
      if (!currentTrip.value) return;

      const dayA = parseInt(modalDay.value, 10);
      const dayB = parseInt(swapTargetDay.value, 10);
      if (!dayA || !dayB || dayA === dayB) return;

      isLoading.value = true;
      try {
        await postJSON({
          action:'swap_days',
          tripId: currentTrip.value.id,
          dayA: String(dayA),
          dayB: String(dayB)
        });

        const tripId = currentTrip.value.id;
        const oA = getOrderIds(tripId, dayA);
        const oB = getOrderIds(tripId, dayB);

        if (oA) setOrderIds(tripId, dayB, oA); else clearOrderIds(tripId, dayB);
        if (oB) setOrderIds(tripId, dayA, oB); else clearOrderIds(tripId, dayA);

        await fetchData();
        currentDay.value = dayA;
      } finally {
        isLoading.value = false;
        showDayModal.value = false;
      }
    };

    const addNewDay = () => {
      totalDays.value++;
      currentDay.value = totalDays.value;
      nextTick().then(initSortable);
    };

    const deleteDay = async (d) => {
      if (!currentTrip.value) return;
      if (!confirm(`åˆªé™¤ Day ${d} çš„æ‰€æœ‰è¡Œç¨‹ï¼Ÿ`)) return;

      isLoading.value = true;
      try {
        const tripId = currentTrip.value.id;

        const toDelete = itinerary.value.filter(it => (it.day ? parseInt(it.day,10) : 1) === d);
        for (const it of toDelete) {
          await postJSON({ action:'del', type:'itinerary', id: it.id });
        }
        itinerary.value = itinerary.value.filter(it => (it.day ? parseInt(it.day,10) : 1) !== d);

        const toShift = itinerary.value.filter(it => (it.day ? parseInt(it.day,10) : 1) > d);
        for (const it of toShift) {
          const newDay = (it.day ? parseInt(it.day,10) : 1) - 1;
          it.day = newDay;
          await postJSON({ action:'edit', type:'itinerary', data: { id: it.id, day: newDay }});
        }

        clearOrderIds(tripId, d);
        await postJSON({ action:'clear_order', tripId, day: String(d) });

        for (let day = d+1; day <= totalDays.value; day++) {
          const prev = getOrderIds(tripId, day);
          if (prev) {
            setOrderIds(tripId, day-1, prev);
            clearOrderIds(tripId, day);
            await postJSON({ action:'save_order', tripId, day: String(day-1), order: prev.join(',') });
            await postJSON({ action:'clear_order', tripId, day: String(day) });
          }
        }

        totalDays.value = Math.max(1, totalDays.value - 1);
        if (currentDay.value > totalDays.value) currentDay.value = totalDays.value;

        await nextTick();
        initSortable();
        updateMapMarkers();
      } finally {
        isLoading.value = false;
      }
    };

    const destroySortable = () => { if (sortable) { sortable.destroy(); sortable = null; } };

    const initSortable = () => {
      destroySortable();
      if (!itineraryListEl.value) return;
      if (currentTab.value !== 'itinerary') return;
      if (!currentTrip.value) return;

      sortable = new Sortable(itineraryListEl.value, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'opacity-50',
        onEnd: async () => {
          const ids = Array.from(itineraryListEl.value.querySelectorAll('[data-id]'))
            .map(el => el.getAttribute('data-id'))
            .filter(Boolean);
          setOrderIds(currentTrip.value.id, currentDay.value, ids);
          try { await saveOrderToDB(currentTrip.value.id, currentDay.value, ids); } catch(e){}
        }
      });
    };

    const filteredItinerary = computed(() => {
      const day = currentDay.value;
      const list = itinerary.value.filter(i => (i.day ? parseInt(i.day,10) : 1) === day);

      const ids = currentTrip.value ? getOrderIds(currentTrip.value.id, day) : null;
      if (ids && ids.length) {
        const map = new Map(list.map(x => [String(x.id), x]));
        const ordered = [];
        ids.forEach(id => { const it = map.get(String(id)); if (it) ordered.push(it); });
        list.forEach(it => { if (!ids.includes(String(it.id))) ordered.push(it); });
        return ordered;
      }

      return list.slice().sort((a,b) => {
        const ta = timeToNum(a.time), tb = timeToNum(b.time);
        if (ta !== tb) return ta - tb;
        return (a.name||'').localeCompare(b.name||'');
      });
    });

    let searchTimeout = null;

    const searchPlacesInput = () => {
      const q = newPlace.value.trim();
      if(!q) { searchResults.value = []; isCoordinateMode.value=false; return; }

      const coordRegex = /^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/;
      if (coordRegex.test(q)) {
        isCoordinateMode.value = true;
        isSearching.value = true;
        const parts = q.split(',');
        selectedLat.value = parseFloat(parts[0]);
        selectedLng.value = parseFloat(parts[1]);

        if(window.google) {
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ location: { lat: selectedLat.value, lng: selectedLng.value } }, (results, status) => {
            if (status === "OK" && results && results[0]) {
              resolvedCoordName.value = results[0].address_components?.[0]?.short_name || "æœªçŸ¥åœ°é»";
            } else {
              resolvedCoordName.value = "åº§æ¨™";
            }
            isSearching.value = false;
          });
        } else {
          resolvedCoordName.value = "åº§æ¨™";
          isSearching.value = false;
        }
        return;
      } else {
        isCoordinateMode.value = false;
        selectedLat.value = null;
        selectedLng.value = null;
        resolvedCoordName.value = '';
      }

      selectedPlaceData.value = null;
      if (!autocompleteService) return;

      isSearching.value = true;
      if(searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        autocompleteService.getPlacePredictions({ input: q, language: 'zh-TW' }, (predictions, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && predictions) searchResults.value = predictions;
          else searchResults.value = [];
          isSearching.value = false;
        });
      }, 350);
    };

    const useCoordinateInput = () => { if (resolvedCoordName.value) newPlace.value = resolvedCoordName.value; addPlace(); };

    const selectPlace = (item) => {
      newPlace.value = item.structured_formatting.main_text;
      selectedPlaceData.value = item;
      searchResults.value = [];
    };

    const searchInGoogleMaps = () => {
      const query = newPlace.value + (currentTrip.value?.city ? ' ' + currentTrip.value.city : '');
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
      searchResults.value = [];
    };

    const addPlace = async () => {
      if(!currentTrip.value) return;
      const placeName = newPlace.value.trim();
      if(!placeName) return;

      isLoading.value = true;
      try {
        const id = generateId();
        const d = currentDay.value;

        let lat = null, lng = null, placeId = '';

        if (selectedPlaceData.value && window.google) {
          placeId = selectedPlaceData.value.place_id;
          const dummyMap = new google.maps.Map(document.createElement('div'));
          const service = new google.maps.places.PlacesService(dummyMap);

          await new Promise((resolve) => {
            service.getDetails({ placeId }, (place, status) => {
              if (status === google.maps.places.PlacesServiceStatus.OK && place?.geometry?.location) {
                lat = place.geometry.location.lat();
                lng = place.geometry.location.lng();
              }
              resolve();
            });
          });
        }
        else if (selectedLat.value != null && selectedLng.value != null) {
          lat = selectedLat.value; lng = selectedLng.value;
          placeId = '';
        }
        else if (window.google) {
          const geocoder = new google.maps.Geocoder();
          await new Promise((resolve) => {
            geocoder.geocode({ address: placeName + (currentTrip.value.city ? " " + currentTrip.value.city : "") }, (results, status) => {
              if (status === 'OK' && results && results[0]) {
                lat = results[0].geometry.location.lat();
                lng = results[0].geometry.location.lng();
                placeId = results[0].place_id || '';
              }
              resolve();
            });
          });
        }

        const item = {
          id,
          name: placeName,
          day: d,
          lat, lng,
          place_id: placeId,
          message: newNote.value || '',
          time: newTime.value || '',
          trip_id: currentTrip.value.id
        };

        itinerary.value.push(item);

        newPlace.value = ''; newNote.value = ''; newTime.value = '';
        selectedPlaceData.value = null; searchResults.value = [];
        selectedLat.value = null; selectedLng.value = null;
        isCoordinateMode.value = false; resolvedCoordName.value = '';

        await postJSON({ action:'add', type:'itinerary', data: item });

        const oldIds = getOrderIds(currentTrip.value.id, d) || filteredItinerary.value.map(x => String(x.id));
        const ids = oldIds.slice();
        ids.push(String(id));
        setOrderIds(currentTrip.value.id, d, ids);
        await saveOrderToDB(currentTrip.value.id, d, ids);

        await nextTick();
        initSortable();
        updateMapMarkers();
      } finally {
        isLoading.value = false;
      }
    };

    const removePlace = async (id) => {
      const i = itinerary.value.findIndex(x=>String(x.id)===String(id));
      if(i!==-1) itinerary.value.splice(i,1);

      await postJSON({ action:'del', type:'itinerary', id });

      const ids = (getOrderIds(currentTrip.value.id, currentDay.value) || []).filter(x => String(x) !== String(id));
      setOrderIds(currentTrip.value.id, currentDay.value, ids);
      try { await saveOrderToDB(currentTrip.value.id, currentDay.value, ids); } catch(e){}

      await nextTick();
      initSortable();
      updateMapMarkers();
    };

    const openGoogleMap = (p) => {
      if (p.place_id) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.name)}&query_place_id=${p.place_id}`, '_blank');
        return;
      }
      if (p.lat && p.lng) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`, '_blank');
        return;
      }
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((p.name||'') + ' ' + (currentTrip.value?.city||''))}`, '_blank');
    };

    const addExpense = async () => {
      if (!newExpense.value.title || !newExpense.value.amount) return;
      const uid = generateId();
      const d = { id: uid, ...newExpense.value, involved: [...newExpense.value.involved], trip_id: currentTrip.value.id };
      expenses.value.unshift(d);
      await postJSON({ action:'add', type:'expenses', data: { ...d, involved: d.involved.join(',') } });
      newExpense.value = { title: '', amount: '', payer: people.value[0]?.name||'', involved: people.value.map(p=>p.name), category: 'é£²é£Ÿ' };
    };

    const removeExpense = async (idx) => {
      const item = expenses.value[idx];
      if (!item?.id) return;
      expenses.value.splice(idx, 1);
      await postJSON({ action:'del', type:'expenses', id: item.id });
    };

    const addPerson = async () => {
      const name = newPerson.value.trim();
      if (!name) return;
      const uid = generateId();
      people.value.push({ id: uid, name, trip_id: currentTrip.value.id });
      newExpense.value.involved.push(name);
      newPerson.value = '';
      await postJSON({ action:'add', type:'people', data: { id: uid, name, trip_id: currentTrip.value.id } });
    };

    const removePerson = async (idx) => {
      const item = people.value[idx];
      if (!item?.id || !confirm('ç§»é™¤ï¼Ÿ')) return;
      people.value.splice(idx, 1);
      await postJSON({ action:'del', type:'people', id: item.id });
    };

    const totalExpense = computed(() => expenses.value.reduce((s,i)=>s+(Number(i.amount)||0),0));

    const balanceSheet = computed(() => {
      if(!people.value.length) return [];
      let b={};
      people.value.forEach(p=>b[p.name]=0);
      expenses.value.forEach(e=>{
        const amt=Number(e.amount)||0;
        if(b[e.payer]===undefined) return;
        b[e.payer]+=amt;
        const inv=(e.involved&&e.involved.length)?e.involved:people.value.map(p=>p.name);
        const v=inv.filter(n=>b[n]!==undefined);
        if(v.length) {
          const s=amt/v.length;
          v.forEach(n=>b[n]-=s);
        }
      });
      return Object.keys(b).map(n=>({name:n, balance:b[n]}));
    });

    const categoryAnalysis = computed(() => {
      const stats = {};
      expenses.value.forEach(e => {
        const cat = e.category || 'æœªåˆ†é¡';
        stats[cat] = (stats[cat] || 0) + (Number(e.amount) || 0);
      });
      return Object.entries(stats).map(([name, total]) => ({name, total})).sort((a,b)=>b.total-a.total);
    });

    const exportItinerary = () => {
      if(!currentTrip.value) return;
      let text = `ã€${currentTrip.value.name}ã€‘è¡Œç¨‹è¡¨\n\n`;
      for(let d = 1; d <= totalDays.value; d++) {
        text += `ğŸ“… Day ${d}\n`;
        const base = itinerary.value.filter(i => (i.day ? parseInt(i.day,10) : 1) === d);
        const ids = getOrderIds(currentTrip.value.id, d);
        let dayItems = base.slice();

        if (ids && ids.length) {
          const map = new Map(dayItems.map(x => [String(x.id), x]));
          const ordered = [];
          ids.forEach(id => { const it = map.get(String(id)); if (it) ordered.push(it); });
          dayItems.forEach(it => { if (!ids.includes(String(it.id))) ordered.push(it); });
          dayItems = ordered;
        } else {
          dayItems = dayItems.sort((a,b)=>timeToNum(a.time)-timeToNum(b.time));
        }

        if(dayItems.length === 0) { text += "  (ç„¡è¡Œç¨‹)\n\n"; continue; }
        dayItems.forEach(item => {
          text += `  ${formatTime(item.time) ? formatTime(item.time)+' ' : ''}${item.name} ${item.message ? '('+item.message+')' : ''}\n`;
        });
        text += "\n";
      }
      navigator.clipboard.writeText(text);
      alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    };

    const switchTab = (tab) => {
      currentTab.value = tab;
      if(tab === 'map') {
        setTimeout(() => {
          initGoogleMap();
          if(mapInstance && window.google) {
            google.maps.event.trigger(mapInstance, 'resize');
            updateMapMarkers();
          }
        }, 150);
      }
      nextTick().then(initSortable);
    };

    watch(currentDay, () => nextTick().then(initSortable));
    watch(currentTab, () => nextTick().then(initSortable));
    watch(currentView, () => nextTick().then(initSortable));

    onMounted(async () => {
      await fetchTrips();
      await loadGoogleMaps();
    });

    return {
      currentView, currentTrip, trips, newTripName, newTripCity,
      currentTab, isLoading,
      currentDay, totalDays,
      people, itinerary, expenses, filteredItinerary,
      newPlace, newTime, newNote, newPerson, newExpense, categories,
      searchResults, isSearching, isCoordinateMode, resolvedCoordName,
      mapSearchQuery, isMapReady,

      createTrip, selectTrip, exitTrip, deleteTripTotally, fetchData,

      switchTab, addNewDay, deleteDay, onDayClick, onDayDblClick, dayLabel,

      showDayModal, modalDay, dateInput, swapTargetDay, closeDayModal, applyDay1Date, swapWithDay,

      searchPlacesInput, useCoordinateInput, selectPlace, searchInGoogleMaps,
      addPlace, removePlace, openGoogleMap,
      itineraryListEl, formatTime,

      searchCityAndJump, fitBoundsToTrip,

      addExpense, removeExpense, addPerson, removePerson,
      totalExpense, balanceSheet, categoryAnalysis, formatInvolved,

      exportItinerary
    };
  }
}).mount('#app');
</script>

</body>
</html>
