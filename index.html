<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºç™¼å›‰</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* å…¨è¢å¹•è¨­å®š */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* åŸºç¤æ¨£å¼ */
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); padding: 16px; margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.02); }
        
        /* â˜…â˜…â˜… é‡é»ç¾åŒ–ï¼šç¾ä»£åŒ–è¼¸å…¥æ¡†æ¨£å¼ â˜…â˜…â˜… */
        input, select { 
            -webkit-user-select: text; 
            user-select: text; 
            border: 1px solid #e2e8f0; /* æ·ºç°é‚Šæ¡† */
            background-color: #f8fafc; /* æ¥µæ·ºç°èƒŒæ™¯ */
            padding: 12px 16px;        /* åŠ å¤§å…§è·ï¼Œå¥½é»æ“Š */
            border-radius: 12px;       /* åœ“æ½¤å°è§’ */
            width: 100%; 
            font-size: 16px;           /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
            color: #334155;            /* æ·±ç°æ–‡å­— */
            outline: none;             /* ç§»é™¤é è¨­é»‘æ¡† */
            transition: all 0.2s ease-in-out; /* æ»‘é †å‹•ç•« */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
        }
        /* è¼¸å…¥æ¡†èšç„¦æ™‚çš„ç‰¹æ•ˆ */
        input:focus, select:focus {
            background-color: #ffffff;
            border-color: #3b82f6;     /* è—è‰²é‚Šæ¡† */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); /* è—è‰²å…‰æšˆ */
        }
        /* æç¤ºæ–‡å­—é¡è‰² */
        ::placeholder { color: #94a3b8; }

        /* åœ°åœ–æ»¿ç‰ˆè¨­å®š */
        #map-container { flex: 1; position: relative; width: 100%; height: 100%; background: #e5e7eb; }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        /* éŒ¯èª¤é¡¯ç¤ºæ¡† (é è¨­éš±è—) */
        #fatal-error { display: none !important; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 99999; padding: 20px; color: red; overflow: auto; }
        
        /* æœå°‹å»ºè­°ç¾åŒ– */
        .suggestions-list { position: absolute; top: 105%; left: 0; right: 0; background: white; z-index: 50; max-height: 250px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .suggestion-item { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .suggestion-item:hover { background: #eff6ff; }
        
        .gmnoprint a, .gmnoprint span, .gm-style-cc { display:none; } img[src*="google"] { display: inline !important; }
        .loading-bar { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: #2563eb; z-index: 9999; animation: loading 1s infinite linear; }
        @keyframes loading { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }
        
        .checkbox-wrapper input:checked + div { background-color: #eff6ff; color: #1d4ed8; border-color: #3b82f6; font-weight: 600; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1); }
        .day-tab-active { background: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .day-tab-inactive { background: white; color: #64748b; border-color: #e2e8f0; }
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="fatal-error">
    <h2 class="text-2xl font-bold mb-4">âš ï¸ ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤</h2>
    <pre id="error-text" class="bg-gray-100 p-4 rounded text-sm text-black border border-red-300"></pre>
</div>

<script>
    window.onerror = function(msg, url, line, col, error) {
        document.getElementById('fatal-error').style.display = 'block'; // å…¶å¯¦ CSS æ“‹ä½äº†ï¼Œæ‰€ä»¥ä¸æœƒé¡¯ç¤º
        document.getElementById('error-text').innerText = `Error: ${msg}\nLine: ${line}:${col}`;
        return false;
    };
</script>

<div id="app" class="flex flex-col h-full w-full">
    <div v-if="isLoading" class="loading-bar"></div>

    <div v-if="currentView === 'lobby'" class="flex-1 p-6 flex flex-col justify-center bg-gray-50 overflow-y-auto">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">âœˆï¸ å‡ºç™¼å›‰</h1>
        <p class="text-slate-500 mb-8">æº–å‚™å¥½é–‹å§‹æ–°çš„å†’éšªäº†å—ï¼Ÿ</p>
        
        <div class="space-y-4 mb-8">
            <div v-for="trip in trips" :key="trip.id" @click="selectTrip(trip)" class="card cursor-pointer border-l-4 border-blue-500 hover:shadow-lg transition-all flex justify-between items-center group">
                <div><div class="font-bold text-xl text-slate-800 group-hover:text-blue-600 transition">{{ trip.name }}</div><div class="text-sm text-slate-500">ğŸ“ {{ trip.city }}</div></div><div class="text-2xl text-slate-300 group-hover:text-blue-500 transition">âœ</div>
            </div>
            <div v-if="trips.length === 0" class="text-center text-slate-400 py-10">è®€å–ä¸­...</div>
        </div>
        
        <div class="card border-0">
            <h3 class="font-bold text-slate-700 mb-4">æ–°å¢æ—…ç¨‹</h3>
            <div class="flex flex-col gap-3">
                <input v-model="newTripName" placeholder="æ—…ç¨‹åç¨± (ä¾‹å¦‚: æ±äº¬äº”æ—¥éŠ)">
                <input v-model="newTripCity" placeholder="ä¸»è¦åŸå¸‚ (ä¾‹å¦‚: Tokyo)">
                <button @click="createTrip" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-[0.98] transition-all" :disabled="isLoading">å»ºç«‹æ—…ç¨‹</button>
            </div>
        </div>
    </div>

    <div v-else class="flex flex-col h-full w-full overflow-hidden bg-gray-50">
        <header class="bg-white/90 backdrop-blur-md text-slate-800 p-4 pt-10 pb-3 shadow-sm z-50 flex justify-between items-center flex-shrink-0 border-b border-gray-200">
            <div><h1 class="text-lg font-bold tracking-wide">{{ currentTrip.name }}</h1><div class="text-xs text-slate-500 font-medium">Day {{ currentDay }} | {{ currentTrip.city }}</div></div>
            <button @click="fetchData" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full font-bold active:scale-95 transition hover:bg-slate-200">â†» åŒæ­¥</button>
        </header>

        <main class="flex-1 relative overflow-hidden">
            
            <div v-show="currentTab === 'itinerary'" class="absolute inset-0 p-4 overflow-y-auto space-y-4 pb-24">
                <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                    <button v-for="d in totalDays" :key="d" @click="currentDay = d" class="px-5 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition-all flex-shrink-0" :class="currentDay === d ? 'day-tab-active' : 'day-tab-inactive'">Day {{ d }}</button>
                    <button @click="addNewDay" class="px-4 py-2 rounded-full border border-gray-200 bg-white text-slate-600 font-bold flex-shrink-0 shadow-sm hover:bg-gray-50">+</button>
                </div>
                
                <div class="card relative space-y-3 !overflow-visible">
                    <div class="flex gap-2 relative">
                        <div class="relative flex-1">
                            <input v-model="newPlace" @input="searchPlacesInput" type="text" :placeholder="'æœå°‹ ' + currentTrip.city + '...'" class="pl-10">
                            <span class="absolute left-3 top-3.5 text-slate-400">ğŸ”</span>
                        </div>
                        <button @click="addPlace" class="bg-blue-600 text-white w-12 rounded-xl text-2xl shadow-md font-bold hover:bg-blue-700 active:scale-95 transition flex items-center justify-center pb-1">+</button>
                        
                        <div v-if="searchResults.length > 0" class="suggestions-list">
                            <div v-for="item in searchResults" :key="item.place_id" @click="selectPlace(item)" class="suggestion-item">
                                <span class="text-xl">ğŸ“</span>
                                <div class="overflow-hidden"><div class="font-bold text-slate-700 text-sm truncate">{{ item.structured_formatting.main_text }}</div><div class="text-xs text-slate-400 truncate">{{ item.structured_formatting.secondary_text }}</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="newTime" type="time" class="w-1/3 text-center">
                        <input v-model="newNote" type="text" placeholder="å‚™è¨»..." class="flex-1">
                    </div>
                </div>
                
                <div class="space-y-3 pb-20">
                    <div v-for="place in filteredItinerary" :key="place.id" class="card flex justify-between items-start active:scale-[0.99] transition border-l-4 border-l-transparent hover:border-l-blue-500">
                        <div class="flex-1" @click="openGoogleMap(place)">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <span v-if="place.time" class="text-blue-600 font-mono font-bold text-sm bg-blue-50 px-2 py-0.5 rounded-md">{{ formatTime(place.time) }}</span>
                                <span class="font-bold text-lg text-slate-800">{{ place.name }}</span>
                            </div>
                            <div class="flex gap-2 mt-1">
                                <span v-if="place.lat && place.lng" class="text-[10px] text-green-600 bg-green-50 px-1.5 py-0.5 rounded font-bold border border-green-100">å·²å®šä½</span>
                                <span v-else class="text-[10px] text-red-400 bg-red-50 px-1.5 py-0.5 rounded border border-red-100">ç„¡åº§æ¨™</span>
                                <div v-if="place.message" class="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full inline-block truncate max-w-[150px]">ğŸ“ {{ place.message }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 pl-2 border-l ml-2 self-stretch">
                            <button @click.stop="editPlace(place)" class="text-slate-400 hover:text-blue-500 px-2 text-lg transition">âœ</button>
                            <button @click.stop="removePlace(place.id)" class="text-slate-300 hover:text-red-500 px-2 text-xl font-bold transition">Ã—</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'map'" id="map-container">
                <div class="absolute top-4 left-4 right-4 z-[10] flex flex-col gap-2 pointer-events-none">
                    <div class="flex shadow-xl rounded-xl overflow-hidden border border-white/50 pointer-events-auto">
                        <input v-model="mapSearchQuery" @keyup.enter="searchCityAndJump" type="text" :placeholder="'è·³è½‰è‡³ ' + currentTrip.city + '...'" class="flex-1 !rounded-r-none !border-0 bg-white/90 backdrop-blur">
                        <button @click="searchCityAndJump" class="bg-blue-600 text-white px-5 font-bold hover:bg-blue-700 transition">Go</button>
                    </div>
                    <div class="flex gap-2 pointer-events-auto">
                        <button @click="exploreNearby" class="flex-1 bg-white/90 backdrop-blur text-purple-700 font-bold py-2.5 rounded-xl shadow-lg border border-white active:scale-95 text-sm flex justify-center items-center gap-1 transition">
                            <span v-if="isMapLoading" class="animate-spin">â†»</span>{{ isMapLoading ? 'æœå°‹ä¸­...' : 'ğŸ” æœå°‹é™„è¿‘' }}
                        </button>
                        <button @click="fitBoundsToTrip" class="flex-1 bg-white/90 backdrop-blur text-slate-700 font-bold py-2.5 rounded-xl shadow-lg border border-white active:scale-95 text-sm flex justify-center items-center gap-1 transition">
                            <span>ğŸ”„</span> é¡¯ç¤ºè¡Œç¨‹
                        </button>
                    </div>
                </div>
                <div id="map"></div>
                <div v-if="!isMapReady" class="absolute inset-0 flex items-center justify-center pointer-events-none"><span class="bg-white/90 backdrop-blur px-6 py-3 rounded-xl shadow-xl text-slate-500 font-bold">åœ°åœ–è¼‰å…¥ä¸­...</span></div>
            </div>

            <div v-show="currentTab === 'money'" class="absolute inset-0 p-4 overflow-y-auto space-y-4 pb-24">
                <div class="card bg-gradient-to-br from-slate-800 to-slate-900 text-white shadow-xl border-0">
                    <div class="flex justify-between items-end mb-4"><span class="text-slate-400 text-sm font-medium">ç¸½æ”¯å‡º</span><span class="text-3xl font-bold tracking-wider">${{ totalExpense }}</span></div>
                    <div class="space-y-1.5 border-t border-slate-700 pt-3 text-sm"><div v-for="res in balanceSheet" :key="res.name" class="flex justify-between"><span>{{ res.name }}</span><span :class="res.balance>=0?'text-emerald-400':'text-rose-400'" class="font-mono font-bold text-base">{{ res.balance > 0 ? '+' : ''}}{{ res.balance }}</span></div></div>
                </div>
                
                <div v-if="categoryAnalysis.length > 0" class="card">
                    <h3 class="font-bold text-slate-700 text-sm mb-3 flex items-center gap-2">ğŸ“Š æ¶ˆè²»åˆ†æ</h3>
                    <div class="space-y-3">
                        <div v-for="cat in categoryAnalysis" :key="cat.name" class="text-xs">
                            <div class="flex justify-between mb-1.5"><span class="text-slate-600 font-medium">{{ cat.name }}</span><span class="font-bold text-slate-800">${{ cat.total }} ({{ ((cat.total/totalExpense)*100).toFixed(0) }}%)</span></div>
                            <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden"><div class="bg-blue-500 h-2 rounded-full stat-bar" :style="{ width: (cat.total/totalExpense)*100 + '%' }"></div></div>
                        </div>
                    </div>
                </div>

                <div class="card border border-blue-100">
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <input v-model="newExpense.title" placeholder="é …ç›®" class="col-span-2">
                        <input v-model.number="newExpense.amount" type="number" placeholder="$" class="font-mono text-center">
                    </div>
                    <div class="mb-3 flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button v-for="cat in categories" :key="cat" @click="newExpense.category = cat" class="px-4 py-1.5 rounded-full border text-xs font-bold whitespace-nowrap transition-all" :class="newExpense.category === cat ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-105' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'">{{ cat }}</button>
                    </div>
                    <div class="mb-3 flex gap-2 items-center">
                        <span class="text-xs text-slate-400 w-12 font-bold">ä»˜æ¬¾äºº</span>
                        <select v-model="newExpense.payer" class="flex-1"><option disabled value="">è«‹é¸æ“‡</option><option v-for="(p, index) in people" :value="p.name">{{ p.name || 'æˆå“¡ ' + (index+1) }}</option></select>
                    </div>
                    <div class="mb-4">
                        <span class="text-xs text-slate-400 block mb-2 font-bold">åˆ†æ”¤çµ¦ (é»æ“Šåˆ‡æ›)</span>
                        <div class="flex flex-wrap gap-2">
                            <label v-for="(p, index) in people" :key="p.id" class="checkbox-wrapper cursor-pointer relative">
                                <input type="checkbox" :value="p.name" v-model="newExpense.involved" class="absolute opacity-0 w-0 h-0">
                                <div class="px-4 py-1.5 rounded-full border border-slate-200 text-sm bg-white transition-all select-none text-slate-600 hover:bg-slate-50">{{ p.name || 'æˆå“¡ ' + (index+1) }}</div>
                            </label>
                        </div>
                    </div>
                    <button @click="addExpense" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-[0.98] transition" :disabled="isLoading">è¨˜å¸³</button>
                </div>

                <div class="space-y-2">
                    <div v-for="(exp, idx) in expenses" :key="exp.id" class="card flex justify-between items-center py-3 hover:shadow-md transition">
                        <div><div class="font-bold text-slate-800 text-lg">{{ exp.title }} <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded ml-1 align-middle">{{ exp.category }}</span></div><div class="text-xs text-slate-400 mt-1 flex gap-2"><span>{{ exp.payer }} å…ˆä»˜</span><span class="text-slate-300">|</span><span>{{ formatInvolved(exp.involved) }} åˆ†æ”¤</span></div></div>
                        <div class="flex flex-col items-end gap-1"><span class="font-bold text-xl text-slate-800 font-mono">${{ exp.amount }}</span><button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-500 px-2 transition">Ã—</button></div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'settings'" class="absolute inset-0 p-4 space-y-4 overflow-y-auto">
                <button @click="exitTrip" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold mb-4 shadow-lg active:scale-[0.98] transition">ğŸ”™ åˆ‡æ›æ—…ç¨‹</button>
                
                <h3 class="font-bold text-slate-700 ml-1">ğŸ“‹ è³‡æ–™ç®¡ç†</h3>
                <button @click="exportItinerary" class="w-full bg-white text-blue-600 border border-blue-100 py-3.5 rounded-xl font-bold shadow-sm active:scale-[0.98] transition flex justify-center items-center gap-2 hover:bg-blue-50"><span>ğŸ“¤</span> åŒ¯å‡ºç´”æ–‡å­—è¡Œç¨‹</button>
                
                <h3 class="font-bold text-slate-700 mt-6 ml-1">ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
                <div class="flex gap-2"><input v-model="newPerson" placeholder="è¼¸å…¥åå­—"><button @click="addPerson" class="bg-slate-800 text-white px-5 rounded-xl font-bold shadow hover:bg-slate-700 transition">æ–°å¢</button></div>
                <div class="space-y-2 mb-10"><div v-for="(p, idx) in people" :key="p.id" class="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm"><span class="font-bold text-slate-700">{{ p.name || 'æˆå“¡ ' + (idx + 1) }}</span><button @click="removePerson(idx)" class="text-red-400 font-bold px-2 hover:text-red-600 transition">ç§»é™¤</button></div></div>
                
                <div class="border-t pt-8 mt-4 text-center">
                    <button @click="resetTrip" class="w-full bg-red-50 text-red-600 border border-red-100 py-3 rounded-xl font-bold mb-3 hover:bg-red-100 transition">ğŸ—‘ï¸ åˆªé™¤æ­¤æ—…ç¨‹è³‡æ–™</button>
                    <button @click="deleteTripTotally" class="w-full text-slate-400 text-xs py-3 hover:text-red-400 transition">âŒ ç§»é™¤æ­¤æ—…ç¨‹å¡ç‰‡</button>
                </div>
            </div>
        </main>

        <nav class="bg-white/90 backdrop-blur-md border-t flex justify-around pb-safe pt-2 pb-2 z-50 flex-shrink-0 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <button @click="switchTab('itinerary')" class="flex flex-col items-center w-full transition active:scale-90" :class="currentTab==='itinerary'?'text-blue-600':'text-slate-400'"><span class="text-2xl mb-0.5">ğŸ“</span><span class="text-[10px] font-bold">è¡Œç¨‹</span></button>
            <button @click="switchTab('map')" class="flex flex-col items-center w-full transition active:scale-90" :class="currentTab==='map'?'text-purple-600':'text-slate-400'"><span class="text-2xl mb-0.5">ğŸ—ºï¸</span><span class="text-[10px] font-bold">åœ°åœ–</span></button>
            <button @click="switchTab('money')" class="flex flex-col items-center w-full transition active:scale-90" :class="currentTab==='money'?'text-green-600':'text-slate-400'"><span class="text-2xl mb-0.5">ğŸ’°</span><span class="text-[10px] font-bold">åˆ†å¸³</span></button>
            <button @click="switchTab('settings')" class="flex flex-col items-center w-full transition active:scale-90" :class="currentTab==='settings'?'text-slate-600':'text-slate-400'"><span class="text-2xl mb-0.5">âš™ï¸</span><span class="text-[10px] font-bold">è¨­å®š</span></button>
        </nav>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;
    const app = createApp({
        setup() {
            // â˜… Config â˜…
            const API_URL = 'https://script.google.com/macros/s/AKfycby303KH-yL7YZajdYUwBQEW-lyFmhz5qsCL5KrY73fZSS5wmSfjPZX8qCYxaNP3FnM/exec';
            const GOOGLE_MAPS_API_KEY = 'AIzaSyCLrHk9V-eQby0aDVx31iwFyqmhI-jIs4Q';

            // State
            const currentView = ref('lobby'); 
            const currentTrip = ref(null);
            const trips = ref([]);
            const newTripName = ref('');
            const newTripCity = ref('');
            const currentTab = ref('itinerary');
            const isLoading = ref(false);
            const isMapLoading = ref(false); 
            const isMapReady = ref(false);
            const currentDay = ref(1);
            const totalDays = ref(1);
            
            const people = ref([]);
            const itinerary = ref([]);
            const expenses = ref([]);

            const newPlace = ref('');
            const newTime = ref('');
            const newNote = ref('');
            const newPerson = ref('');
            const newExpense = ref({ title: '', amount: '', payer: '', involved: [], category: 'é£²é£Ÿ' });
            const categories = ['é£²é£Ÿ', 'äº¤é€š', 'ä½å®¿', 'è³¼ç‰©', 'é–€ç¥¨', 'å…¶ä»–'];
            
            const searchResults = ref([]);
            const mapSearchQuery = ref('');
            let searchTimeout = null;
            let mapInstance = null; let markers = []; let infoWindow = null;
            let autocompleteService = null;

            const generateId = () => Date.now() + '_' + Math.floor(Math.random() * 1000);
            const formatInvolved = (list) => (!list || list.length === 0) ? 'å…¨å“¡' : (Array.isArray(list) ? list.join(', ') : list);

            const formatTime = (timeStr) => {
                if (!timeStr) return '';
                if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}$/.test(timeStr)) return timeStr;
                try {
                    const date = new Date(timeStr);
                    if (isNaN(date.getTime())) return timeStr;
                    const h = date.getHours().toString().padStart(2, '0');
                    const m = date.getMinutes().toString().padStart(2, '0');
                    return `${h}:${m}`;
                } catch (e) { return timeStr; }
            };

            const loadGoogleMaps = () => {
                if (window.google && window.google.maps) { isMapReady.value = true; return Promise.resolve(); }
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=zh-TW`;
                    script.async = true; script.defer = true;
                    script.onload = () => { try { autocompleteService = new google.maps.places.AutocompleteService(); } catch(e){} isMapReady.value = true; resolve(); };
                    script.onerror = () => { console.warn('Map Error'); resolve(); };
                    document.head.appendChild(script);
                });
            };

            const fetchTrips = async () => { isLoading.value = true; try { const res = await fetch(`${API_URL}?type=trips`); trips.value = await res.json(); } catch(e) {} finally { isLoading.value = false; } };
            const createTrip = async () => { if(!newTripName.value) return; const id = generateId(); const newTrip = { id, name: newTripName.value, city: newTripCity.value || '' }; trips.value.push(newTrip); newTripName.value = ''; newTripCity.value = ''; await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', type: 'trips', data: newTrip }) }); };
            
            const selectTrip = (trip) => { 
                if(!trip) return;
                currentTrip.value = trip; 
                itinerary.value = []; expenses.value = []; people.value = []; 
                currentDay.value = 1; totalDays.value = 1; 
                currentView.value = 'app'; 
                fetchData(); 
            };
            
            const deleteTripTotally = async () => { if(!confirm('ç¢ºå®šç§»é™¤ï¼Ÿ')) return; await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'del', type: 'trips', id: currentTrip.value.id }) }); exitTrip(); fetchTrips(); };
            const exitTrip = () => { currentView.value = 'lobby'; currentTrip.value = null; fetchTrips(); };
            onMounted(() => { fetchTrips(); loadGoogleMaps(); });

            const fetchData = async () => { if(!currentTrip.value) return; isLoading.value = true; const tripId = currentTrip.value.id; try { const [resItin, resExp, resPpl] = await Promise.all([ fetch(`${API_URL}?type=itinerary&tripId=${tripId}`), fetch(`${API_URL}?type=expenses&tripId=${tripId}`), fetch(`${API_URL}?type=people&tripId=${tripId}`) ]); const itinData = await resItin.json(); itinerary.value = itinData; if(itinData.length > 0) { const max = itinData.reduce((m, i) => Math.max(m, i.day ? parseInt(i.day) : 1), 1); if(max > totalDays.value) totalDays.value = max; } expenses.value = await resExp.json(); const ppl = await resPpl.json(); people.value = ppl.length ? ppl : [{id:'default', name:'æˆ‘'}]; if(people.value.length) { newExpense.value.payer = people.value[0].name; newExpense.value.involved = people.value.map(p=>p.name); } } catch(e) {} finally { isLoading.value = false; } };
            const sendToApi = async (action, type, data) => { const body = { action, type }; if (action === 'add') { data.trip_id = currentTrip.value.id; body.data = data; } else { body.id = data; } await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) }); };
            
            const searchPlacesInput = () => { 
                const q = newPlace.value.trim(); 
                if(!q) { searchResults.value = []; return; }
                if (!autocompleteService) return;
                if(searchTimeout) clearTimeout(searchTimeout); 
                searchTimeout = setTimeout(() => { 
                    autocompleteService.getPlacePredictions({ input: q }, (predictions, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK && predictions) searchResults.value = predictions;
                        else searchResults.value = [];
                    });
                }, 500); 
            };
            
            const selectPlace = (item) => { newPlace.value = item.structured_formatting.main_text; addPlace(item.place_id); searchResults.value = []; };
            const searchInGoogleMaps = () => { const query = newPlace.value + (currentTrip.value.city ? ' ' + currentTrip.value.city : ''); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank'); searchResults.value = []; };

            const switchTab = (tab) => { 
                currentTab.value = tab; 
                if(tab === 'map') { 
                    setTimeout(() => {
                        initGoogleMap();
                        if(mapInstance) {
                            google.maps.event.trigger(mapInstance, 'resize');
                            updateMapMarkers();
                        }
                    }, 200); 
                } 
            };

            const initGoogleMap = () => { 
                if (!window.google) return; 
                const mapEl = document.getElementById('map'); if (!mapEl) return; 
                if (!mapInstance) { mapInstance = new google.maps.Map(mapEl, { center: { lat: 23.6, lng: 121 }, zoom: 8, streetViewControl: false, mapTypeControl: false, fullscreenControl: false }); infoWindow = new google.maps.InfoWindow(); } 
                updateMapMarkers(); 
            };
            
            const updateMapMarkers = () => {
                if (!mapInstance) return;
                markers.forEach(m => m.setMap(null)); markers = [];
                const bounds = new google.maps.LatLngBounds(); let hasPoint = false;
                
                itinerary.value.forEach(item => {
                    if (item.lat && item.lng) {
                        createMarker(item, Number(item.lat), Number(item.lng), bounds);
                        hasPoint = true;
                    } else if (item.name && window.google) {
                        const geocoder = new google.maps.Geocoder();
                        geocoder.geocode({ address: item.name + (currentTrip.value.city ? " " + currentTrip.value.city : "") }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                createMarker(item, results[0].geometry.location.lat(), results[0].geometry.location.lng(), bounds);
                            }
                        });
                    }
                });

                if (hasPoint) mapInstance.fitBounds(bounds);
                else if (currentTrip.value && currentTrip.value.city) { const geocoder = new google.maps.Geocoder(); geocoder.geocode({ address: currentTrip.value.city }, (results, status) => { if (status === 'OK' && results[0]) { mapInstance.setCenter(results[0].geometry.location); mapInstance.setZoom(12); } }); }
            };

            const createMarker = (item, lat, lng, bounds) => {
                const d = item.day ? parseInt(item.day) : 1;
                const marker = new google.maps.Marker({ position: { lat, lng }, map: mapInstance, label: { text: d.toString(), color: "white" }, title: item.name });
                marker.addListener("click", () => { infoWindow.setContent(`<div style="padding:5px; color:black"><b>${item.name}</b><br><span style="font-size:12px; color:#555">${formatTime(item.time)||''} ${item.message||''}</span><br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name)}" target="_blank" style="color:blue;">Google Maps</a></div>`); infoWindow.open(mapInstance, marker); });
                markers.push(marker); 
                if(bounds) bounds.extend(marker.getPosition());
            };

            const fitBoundsToTrip = () => updateMapMarkers();
            
            const searchCityAndJump = () => {
                if(!mapSearchQuery.value || !window.google) return;
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: mapSearchQuery.value }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        mapInstance.setCenter(results[0].geometry.location);
                        mapInstance.setZoom(12);
                    } else alert('æ‰¾ä¸åˆ°è©²åœ°é»');
                });
            };

            const exploreNearby = () => {
                if(!mapInstance || !window.google) return;
                isMapLoading.value = true;
                const service = new google.maps.places.PlacesService(mapInstance);
                service.nearbySearch({ location: mapInstance.getCenter(), radius: 1000, type: ['tourist_attraction', 'point_of_interest'] }, (results, status) => {
                    isMapLoading.value = false;
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        markers.forEach(m => m.setMap(null)); markers = [];
                        const bounds = new google.maps.LatLngBounds();
                        results.forEach(place => {
                            const marker = new google.maps.Marker({ position: place.geometry.location, map: mapInstance, icon: { url: place.icon, scaledSize: new google.maps.Size(20, 20) }, title: place.name });
                            marker.addListener("click", () => {
                                infoWindow.setContent(`<div style="padding:5px; text-align:center"><b>${place.name}</b><br><button onclick="document.dispatchEvent(new CustomEvent('add-map', {detail: {name: '${place.name}', lat: ${place.geometry.location.lat()}, lng: ${place.geometry.location.lng()}}}))" style="background:#2563eb;color:white;border:none;padding:5px 10px;border-radius:4px;margin-top:5px;width:100%;">â• åŠ å…¥è¡Œç¨‹</button></div>`);
                                infoWindow.open(mapInstance, marker);
                            });
                            markers.push(marker);
                            bounds.extend(place.geometry.location);
                        });
                        mapInstance.fitBounds(bounds);
                    } else alert('é™„è¿‘ç„¡æ™¯é»');
                });
            };
            
            document.addEventListener('add-map', (e) => {
                const { name, lat, lng } = e.detail;
                const item = { id: generateId(), name, day: currentDay.value, lat, lng, time: '', message: '' };
                itinerary.value.push(item);
                sendToApi('add', 'itinerary', item);
                alert(`å·²åŠ å…¥: ${name}`);
            });

            const addPlace = async (googlePlaceId = null) => {
                if(!newPlace.value) return;
                const id = generateId();
                const item = { id, name: newPlace.value, day: currentDay.value, time: newTime.value, message: newNote.value, lat: '', lng: '', place_id: googlePlaceId };
                itinerary.value.push(item);
                newPlace.value = ''; newNote.value = '';
                if (googlePlaceId && window.google) {
                    const dummy = document.createElement('div');
                    const service = new google.maps.places.PlacesService(dummy);
                    service.getDetails({ placeId: googlePlaceId }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            item.lat = place.geometry.location.lat();
                            item.lng = place.geometry.location.lng();
                            sendToApi('add', 'itinerary', item);
                        } else sendToApi('add', 'itinerary', item);
                    });
                } else sendToApi('add', 'itinerary', item);
            };
            
            const removePlace = async(id) => { const i=itinerary.value.findIndex(x=>x.id===id); if(i!==-1) { itinerary.value.splice(i,1); await sendToApi('del', 'itinerary', id); updateMapMarkers(); } };
            const editPlace = (item) => { newPlace.value = item.name; newTime.value = formatTime(item.time); newNote.value = item.message || ''; removePlace(item.id); };
            const addNewDay = () => { totalDays.value++; currentDay.value = totalDays.value; };
            const openGoogleMap = (p) => { if (p.place_id) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.name)}&query_place_id=${p.place_id}`, '_blank'); else if (p.lat && p.lng) window.open(`https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`, '_blank'); else window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.name + ' ' + currentTrip.value.city)}`, '_blank'); };
            
            const addExpense = async () => { if (!newExpense.value.title || !newExpense.value.amount) return; const uid = generateId(); const d = { id: uid, ...newExpense.value, involved: [...newExpense.value.involved] }; expenses.value.unshift(d); await sendToApi('add', 'expenses', { ...d, involved: d.involved.join(',') }); newExpense.value = { title: '', amount: '', payer: people.value[0]?.name||'', involved: people.value.map(p=>p.name), category: 'é£²é£Ÿ' }; };
            const removeExpense = async (idx) => { const item = expenses.value[idx]; if (!item.id) return; expenses.value.splice(idx, 1); await sendToApi('del', 'expenses', item.id); };
            const addPerson = async () => { const name = newPerson.value.trim(); if (!name) return; const uid = generateId(); people.value.push({ id: uid, name: name }); newExpense.value.involved.push(name); newPerson.value = ''; await sendToApi('add', 'people', { id: uid, name: name }); };
            const removePerson = async (idx) => { const item = people.value[idx]; if (!item.id || !confirm('ç§»é™¤ï¼Ÿ')) return; people.value.splice(idx, 1); await sendToApi('del', 'people', item.id); };
            const resetTrip = async () => { if(!confirm(`è­¦å‘Šï¼šæ¸…ç©ºï¼Ÿ`)) return; await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'reset_trip', type:'all', tripId: currentTrip.value.id})}); itinerary.value=[]; expenses.value=[]; people.value=[{id:'def',name:'æˆ‘'}]; alert('å·²æ¸…ç©º'); };
            const totalExpense = computed(() => expenses.value.reduce((s,i)=>s+(Number(i.amount)||0),0));
            const balanceSheet = computed(() => { if(!people.value.length) return []; let b={}; people.value.forEach(p=>b[p.name]=0); expenses.value.forEach(e=>{ const amt=Number(e.amount)||0; if(b[e.payer]===undefined) return; b[e.payer]+=amt; const inv=(e.involved&&e.involved.length)?e.involved:people.value.map(p=>p.name); const v=inv.filter(n=>b[n]!==undefined); if(v.length) { const s=amt/v.length; v.forEach(n=>b[n]-=s); } }); return Object.keys(b).map(n=>({name:n, balance:b[n]})); });
            const filteredItinerary = computed(() => { let list = itinerary.value.filter(i => (i.day ? parseInt(i.day) : 1) === currentDay.value); return list.sort((a, b) => { if (a.time && b.
