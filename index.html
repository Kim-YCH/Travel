<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºç™¼å›‰ (v50 é™¤éŒ¯ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding-bottom: 200px; /* ç•™çµ¦é™¤éŒ¯æ¡† */ }
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 10px; }
        .flex { display: flex; } .gap-2 { gap: 8px; }
        input, select { border: 1px solid #ddd; padding: 8px; border-radius: 4px; width: 100%; }
        
        /* åœ°åœ–å®¹å™¨ */
        #map { height: 300px; width: 100%; background: #ddd; margin-top: 10px; }
        
        /* æœå°‹å»ºè­° */
        .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 50; max-height: 250px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .suggestion-item:hover { background: #f0f9ff; }

        /* é™¤éŒ¯è¦–çª—æ¨£å¼ */
        #debug-console {
            position: fixed; bottom: 0; left: 0; right: 0; height: 160px;
            background: #111; color: #0f0; font-family: monospace; font-size: 11px;
            padding: 10px; overflow-y: scroll; z-index: 99999; opacity: 0.95;
            border-top: 2px solid #444; box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        }
        .log-time { color: #888; margin-right: 5px; }
        .log-err { color: #ff5555; font-weight: bold; }
        .gmnoprint a, .gmnoprint span, .gm-style-cc { display:none; } img[src*="google"] { display: inline !important; }
    </style>
</head>
<body>

<div id="debug-console">
    <div>=== ç³»çµ±æ—¥èªŒ v50.0 ===</div>
</div>

<script>
    // éŒ¯èª¤æ””æˆªå™¨
    function log(msg, isError = false) {
        const el = document.getElementById('debug-console');
        const line = document.createElement('div');
        const time = new Date().toLocaleTimeString();
        line.innerHTML = `<span class="log-time">[${time}]</span> <span class="${isError ? 'log-err' : ''}">${msg}</span>`;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
        if(isError) console.error(msg); else console.log(msg);
    }
    
    window.onerror = function(msg, url, line) {
        log("ğŸ’¥ ç³»çµ±éŒ¯èª¤: " + msg + " (Line: " + line + ")", true);
        return false;
    };
    
    log("åˆå§‹åŒ–ä¸­... æ­£åœ¨æª¢æŸ¥ Vue...");
    if (typeof Vue === 'undefined') {
        log("âŒ Vue.js è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š", true);
    } else {
        log("âœ… Vue.js å·²å°±ç·’");
    }
</script>

<div id="app">
    <div v-if="isLoading" style="position:fixed;top:0;left:0;right:0;height:4px;background:#2563eb;z-index:9999;"></div>

    <div v-if="currentView === 'lobby'" class="p-4">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">âœˆï¸ å‡ºç™¼å›‰</h1>
        
        <div class="space-y-4 mb-8">
            <div v-for="trip in trips" :key="trip.id" @click="selectTrip(trip)" class="card cursor-pointer border-l-4 border-blue-500 hover:shadow-md flex justify-between items-center">
                <div><div class="font-bold text-xl">{{ trip.name }}</div><div class="text-sm text-gray-500">{{ trip.city }}</div></div><div class="text-2xl text-gray-300">âœ</div>
            </div>
            <div v-if="trips.length === 0" class="text-center text-gray-400 py-10">è®€å–ä¸­æˆ–å°šç„¡æ—…ç¨‹</div>
        </div>

        <div class="card border border-blue-100">
            <h3 class="font-bold mb-3 text-gray-700">æ–°å¢æ—…ç¨‹</h3>
            <div class="flex flex-col gap-2">
                <input v-model="newTripName" placeholder="æ—…ç¨‹åç¨±" class="bg-gray-50">
                <input v-model="newTripCity" placeholder="ä¸»è¦åŸå¸‚" class="bg-gray-50">
                <button @click="createTrip" class="w-full bg-blue-600 text-white py-3 rounded font-bold shadow" :disabled="isLoading">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <div v-else class="flex flex-col h-full">
        <header class="bg-blue-600 text-white p-4 pt-8 sticky top-0 z-50 flex justify-between items-center shadow-md">
            <div><h1 class="text-lg font-bold">{{ currentTrip.name }}</h1><div class="text-xs text-blue-100">Day {{ currentDay }} | {{ currentTrip.city }}</div></div>
            <button @click="fetchData" class="text-xs bg-blue-700 px-3 py-1 rounded text-white shadow">â†» åŒæ­¥</button>
        </header>

        <main class="flex-1 overflow-hidden flex flex-col p-4 overflow-y-auto bg-gray-50">
            <div v-if="currentTab === 'itinerary'" class="space-y-4">
                <div class="flex gap-2 overflow-x-auto pb-2">
                    <button v-for="d in totalDays" :key="d" @click="currentDay = d" class="px-4 py-2 rounded-full border text-sm font-bold shadow-sm transition" :class="currentDay === d ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200'">Day {{ d }}</button>
                    <button @click="addNewDay" class="px-3 py-2 rounded-full border bg-white shadow-sm font-bold">+</button>
                </div>
                
                <div class="card relative space-y-2">
                    <div class="flex gap-2 relative">
                        <input v-model="newPlace" @input="searchPlacesInput" type="text" :placeholder="'æœå°‹ ' + currentTrip.city + '...'" class="flex-1 bg-gray-100">
                        <button @click="addPlace" class="bg-blue-600 text-white w-12 rounded shadow text-xl font-bold">+</button>
                        
                        <div v-if="searchResults.length > 0" class="suggestions-list">
                            <div v-for="item in searchResults" :key="item.place_id" @click="selectPlace(item)" class="suggestion-item">
                                <span class="text-xl mr-2">ğŸ“</span>
                                <div>
                                    <div class="font-bold text-sm">{{ item.structured_formatting.main_text }}</div>
                                    <div class="text-xs text-gray-500">{{ item.structured_formatting.secondary_text }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="newTime" type="time" class="w-1/3 bg-gray-100">
                        <input v-model="newNote" type="text" placeholder="å‚™è¨»..." class="flex-1 bg-gray-100">
                    </div>
                </div>
                
                <div class="space-y-3 pb-10">
                    <div v-for="place in filteredItinerary" :key="place.id" class="card flex justify-between items-start active:scale-[0.99] transition">
                        <div class="flex-1" @click="openGoogleMap(place)">
                            <div class="flex items-center gap-2">
                                <span v-if="place.time" class="text-blue-600 font-mono font-bold text-sm bg-blue-50 px-1 rounded">{{ formatTime(place.time) }}</span>
                                <span class="font-bold text-lg text-gray-800">{{ place.name }}</span>
                                <span v-if="place.lat && place.lng" class="text-[10px] text-green-600 bg-green-100 px-1 rounded font-bold">å®šä½</span>
                            </div>
                            <div v-if="place.message" class="text-sm text-gray-500 mt-1 bg-gray-50 p-1 rounded inline-block">ğŸ“ {{ place.message }}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click.stop="editPlace(place)" class="text-gray-400 hover:text-blue-500">âœ</button>
                            <button @click.stop="removePlace(place.id)" class="text-gray-300 hover:text-red-500 font-bold text-lg">Ã—</button>
                        </div>
                    </div>
                    <div v-if="filteredItinerary.length===0" class="text-center text-gray-400 mt-10">å°šç„¡è¡Œç¨‹</div>
                </div>
            </div>

            <div v-show="currentTab === 'map'" class="h-full flex flex-col">
                <div class="flex gap-2 mb-2">
                    <button @click="fitBoundsToTrip" class="flex-1 bg-white text-gray-700 font-bold py-3 rounded-lg shadow border border-gray-200 text-sm">ğŸ”„ é¡¯ç¤ºæ‰€æœ‰è¡Œç¨‹</button>
                </div>
                <div id="map"></div>
                <div v-if="!isMapReady" class="text-center text-gray-500 mt-4">åœ°åœ–è¼‰å…¥ä¸­...</div>
            </div>

            <div v-if="currentTab === 'money'" class="space-y-4 pb-24">
                <div class="card bg-gray-800 text-white shadow-lg">
                    <div class="flex justify-between items-end mb-4"><span class="text-gray-400 text-sm">ç¸½æ”¯å‡º</span><span class="text-3xl font-bold">${{ totalExpense }}</span></div>
                    <div class="border-t border-gray-600 pt-3 text-sm space-y-1"><div v-for="res in balanceSheet" :key="res.name" class="flex justify-between"><span>{{ res.name }}</span><span :class="res.balance>=0?'text-green-400':'text-red-400'">{{ res.balance }}</span></div></div>
                </div>
                <div class="card border border-blue-100">
                    <div class="flex gap-2 mb-3"><input v-model="newExpense.title" placeholder="é …ç›®" class="flex-1 bg-gray-50"><input v-model.number="newExpense.amount" type="number" placeholder="$" class="w-24 bg-gray-50"></div>
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-1"><button v-for="cat in categories" :key="cat" @click="newExpense.category = cat" class="px-3 py-1 text-xs rounded-full border whitespace-nowrap" :class="newExpense.category===cat?'bg-blue-600 text-white border-blue-600':'bg-white text-gray-500'">{{cat}}</button></div>
                    <select v-model="newExpense.payer" class="mb-4 w-full bg-gray-50"><option disabled value="">ä»˜æ¬¾äºº</option><option v-for="p in people" :value="p.name">{{p.name}}</option></select>
                    <button @click="addExpense" class="w-full bg-blue-600 text-white py-3 rounded font-bold shadow">è¨˜å¸³</button>
                </div>
                <div class="space-y-2">
                    <div v-for="(exp, idx) in expenses" :key="exp.id" class="card flex justify-between items-center py-3">
                        <div><div class="font-bold text-gray-800">{{ exp.title }} <span class="text-xs font-normal bg-gray-100 text-gray-500 px-1 rounded">{{ exp.category }}</span></div><div class="text-xs text-gray-500 mt-1">{{ exp.payer }} ä»˜æ¬¾</div></div>
                        <div class="font-bold text-lg">${{ exp.amount }} <button @click="removeExpense(idx)" class="text-gray-300 ml-2">Ã—</button></div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'settings'" class="p-4 space-y-4">
                <button @click="exitTrip" class="w-full bg-gray-700 text-white py-3 rounded font-bold mb-4">ğŸ”™ åˆ‡æ›æ—…ç¨‹</button>
                <h3 class="font-bold text-gray-700">æˆå“¡ç®¡ç†</h3>
                <div class="flex gap-2"><input v-model="newPerson" placeholder="åå­—" class="bg-gray-50"><button @click="addPerson" class="bg-gray-800 text-white px-4 rounded font-bold">æ–°å¢</button></div>
                <div class="space-y-2"><div v-for="(p, idx) in people" :key="p.id" class="flex justify-between p-3 bg-white border rounded items-center"><span class="font-bold text-gray-800">{{p.name}}</span><button @click="removePerson(idx)" class="text-red-500 font-bold">ç§»é™¤</button></div></div>
                <div class="border-t pt-4 mt-8 text-center"><button @click="exportItinerary" class="text-blue-600 font-bold mb-4 block w-full">ğŸ“¤ è¤‡è£½è¡Œç¨‹æ–‡å­—</button><button @click="resetTrip" class="text-red-500 text-xs py-2">ğŸ—‘ï¸ æ¸…ç©ºæ­¤æ—…ç¨‹è³‡æ–™</button></div>
            </div>
        </main>

        <nav class="bg-white border-t flex justify-around p-2 pb-6 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-50">
            <button @click="switchTab('itinerary')" class="flex flex-col items-center w-full" :class="currentTab==='itinerary'?'text-blue-600':'text-gray-400'"><span class="text-xl">ğŸ“</span><span class="text-xs">è¡Œç¨‹</span></button>
            <button @click="switchTab('map')" class="flex flex-col items-center w-full" :class="currentTab==='map'?'text-purple-600':'text-gray-400'"><span class="text-xl">ğŸ—ºï¸</span><span class="text-xs">åœ°åœ–</span></button>
            <button @click="switchTab('money')" class="flex flex-col items-center w-full" :class="currentTab==='money'?'text-green-600':'text-gray-400'"><span class="text-xl">ğŸ’°</span><span class="text-xs">åˆ†å¸³</span></button>
            <button @click="switchTab('settings')" class="flex flex-col items-center w-full" :class="currentTab==='settings'?'text-gray-600':'text-gray-400'"><span class="text-xl">âš™ï¸</span><span class="text-xs">è¨­å®š</span></button>
        </nav>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;
    log("Vue æ ¸å¿ƒè¼‰å…¥å®Œæˆ");

    const app = createApp({
        setup() {
            log("App Setup é–‹å§‹...");
            
            // â˜… Config â˜…
            const API_URL = 'https://script.google.com/macros/s/AKfycby303KH-yL7YZajdYUwBQEW-lyFmhz5qsCL5KrY73fZSS5wmSfjPZX8qCYxaNP3FnM/exec';
            const GOOGLE_MAPS_API_KEY = 'AIzaSyCLrHk9V-eQby0aDVx31iwFyqmhI-jIs4Q';

            // State
            const currentView = ref('lobby'); const currentTrip = ref(null); const trips = ref([]); 
            const newTripName = ref(''); const newTripCity = ref('');
            const currentTab = ref('itinerary'); const isLoading = ref(false); 
            const isMapLoading = ref(false); const isMapReady = ref(false);
            const currentDay = ref(1); const totalDays = ref(1);
            
            const people = ref([]); const itinerary = ref([]); const expenses = ref([]);
            const newPlace = ref(''); const newTime = ref(''); const newNote = ref(''); const newPerson = ref('');
            const newExpense = ref({ title: '', amount: '', payer: '', involved: [], category: 'é£²é£Ÿ' });
            const categories = ['é£²é£Ÿ', 'äº¤é€š', 'ä½å®¿', 'è³¼ç‰©', 'é–€ç¥¨', 'å…¶ä»–'];
            const searchResults = ref([]);
            
            // Map
            let mapInstance = null; let markers = []; let infoWindow = null; let autocompleteService = null;

            const generateId = () => Date.now() + '_' + Math.floor(Math.random() * 1000);
            const formatInvolved = (list) => (!list || list.length === 0) ? 'å…¨å“¡' : (Array.isArray(list) ? list.join(', ') : list);

            // Time Formatter (Handle 1899...)
            const formatTime = (timeStr) => {
                if (!timeStr) return '';
                if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}$/.test(timeStr)) return timeStr;
                try {
                    const date = new Date(timeStr);
                    if (isNaN(date.getTime())) return timeStr;
                    const h = date.getHours().toString().padStart(2, '0');
                    const m = date.getMinutes().toString().padStart(2, '0');
                    return `${h}:${m}`;
                } catch { return timeStr; }
            };

            const loadGoogleMaps = () => {
                if (window.google && window.google.maps) { 
                    log("Google Maps å·²å­˜åœ¨");
                    isMapReady.value = true; 
                    return Promise.resolve(); 
                }
                return new Promise((resolve, reject) => {
                    log("é–‹å§‹è¼‰å…¥ Google Maps API...");
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&language=zh-TW`;
                    script.async = true; script.defer = true;
                    script.onload = () => { 
                        log("Google Maps API è¼‰å…¥æˆåŠŸ");
                        try { autocompleteService = new google.maps.places.AutocompleteService(); } catch(e){ log("Autocomplete init fail", true); }
                        isMapReady.value = true; 
                        resolve(); 
                    };
                    script.onerror = () => { 
                        log("âŒ Google Maps API è¼‰å…¥å¤±æ•— (å¯èƒ½è¢«æ“‹æˆ– Key éŒ¯èª¤)", true); 
                        resolve(); // ä¸ rejectï¼Œé¿å…å¡æ­»
                    };
                    document.head.appendChild(script);
                });
            };

            const fetchTrips = async () => {
                isLoading.value = true;
                log("æ­£åœ¨è®€å–æ—…ç¨‹æ¸…å–®...");
                try {
                    const res = await fetch(`${API_URL}?type=trips`);
                    trips.value = await res.json();
                    log(`è®€å–åˆ° ${trips.value.length} å€‹æ—…ç¨‹`);
                } catch (e) { log("âŒ è®€å–æ—…ç¨‹å¤±æ•—: " + e, true); }
                finally { isLoading.value = false; }
            };

            const createTrip = async () => {
                if (!newTripName.value) return;
                isLoading.value = true;
                const id = generateId();
                const newTrip = { id, name: newTripName.value, city: newTripCity.value || '' };
                trips.value.push(newTrip);
                newTripName.value = ''; newTripCity.value = '';
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', type: 'trips', data: newTrip }) });
                isLoading.value = false;
            };

            const selectTrip = (trip) => {
                log("é€²å…¥æ—…ç¨‹: " + trip.name);
                currentTrip.value = trip;
                itinerary.value = []; expenses.value = []; people.value = [];
                currentDay.value = 1; totalDays.value = 1;
                currentView.value = 'app';
                fetchData();
            };

            const fetchData = async () => {
                if (!currentTrip.value) return;
                isLoading.value = true;
                const tid = currentTrip.value.id;
                try {
                    log("åŒæ­¥è³‡æ–™ä¸­...");
                    const [resItin, resExp, resPpl] = await Promise.all([
                        fetch(`${API_URL}?type=itinerary&tripId=${tid}`),
                        fetch(`${API_URL}?type=expenses&tripId=${tid}`),
                        fetch(`${API_URL}?type=people&tripId=${tid}`)
                    ]);
                    itinerary.value = await resItin.json();
                    expenses.value = await resExp.json();
                    people.value = await resPpl.json();
                    
                    if (itinerary.value.length > 0) {
                        const max = itinerary.value.reduce((m, i) => Math.max(m, parseInt(i.day||1)), 1);
                        totalDays.value = max;
                    }
                    if(people.value.length) newExpense.value.payer = people.value[0].name;
                    log("è³‡æ–™åŒæ­¥å®Œæˆ");
                } catch(e) { log("âŒ è³‡æ–™åŒæ­¥å¤±æ•—: " + e, true); }
                finally { isLoading.value = false; }
            };

            const searchPlacesInput = () => {
                if (!newPlace.value || !autocompleteService) return;
                autocompleteService.getPlacePredictions({ input: newPlace.value }, (predictions, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) searchResults.value = predictions;
                });
            };

            const selectPlace = (item) => {
                newPlace.value = item.structured_formatting.main_text;
                addPlace(item.place_id); 
                searchResults.value = [];
            };

            const addPlace = async (googlePlaceId = null) => {
                if(!newPlace.value) return;
                const id = generateId();
                const item = { 
                    id, name: newPlace.value, day: currentDay.value, 
                    time: newTime.value, message: newNote.value,
                    lat: '', lng: '', place_id: googlePlaceId 
                };
                
                log("æ–°å¢åœ°é»: " + item.name);
                
                // å…ˆæ¨å…¥å‰ç«¯ï¼Œå†å»æŸ¥åº§æ¨™
                itinerary.value.push(item);
                newPlace.value = ''; newNote.value = '';

                if (googlePlaceId && window.google) {
                    const dummy = document.createElement('div');
                    const service = new google.maps.places.PlacesService(dummy);
                    service.getDetails({ placeId: googlePlaceId }, (place, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            item.lat = place.geometry.location.lat();
                            item.lng = place.geometry.location.lng();
                            log(`å–å¾—åº§æ¨™: ${item.lat}, ${item.lng}`);
                            // æ›´æ–°å¾Œç«¯
                            sendToApi('add', 'itinerary', item);
                        } else {
                            sendToApi('add', 'itinerary', item);
                        }
                    });
                } else {
                    sendToApi('add', 'itinerary', item);
                }
            };

            const removePlace = (id) => {
                const idx = itinerary.value.findIndex(i => i.id === id);
                if (idx > -1) {
                    itinerary.value.splice(idx, 1);
                    sendToApi('del', 'itinerary', id);
                }
            };
            
            const editPlace = (item) => {
                newPlace.value = item.name;
                newTime.value = formatTime(item.time);
                newNote.value = item.message;
                removePlace(item.id);
            };

            const sendToApi = async (action, type, data) => {
                const body = { action, type };
                if (action === 'add') { data.trip_id = currentTrip.value.id; body.data = data; } else { body.id = data; }
                fetch(API_URL, { method: 'POST', body: JSON.stringify(body) }).catch(e => log("âŒ API éŒ¯èª¤: " + e, true));
            };

            // Map Logic
            const switchTab = (tab) => {
                currentTab.value = tab;
                if (tab === 'map') {
                    nextTick(() => {
                        setTimeout(() => {
                            if (!mapInstance && window.google) {
                                log("åˆå§‹åŒ–åœ°åœ–...");
                                mapInstance = new google.maps.Map(document.getElementById('map'), {
                                    center: { lat: 23.6, lng: 121 }, zoom: 8, streetViewControl: false
                                });
                                infoWindow = new google.maps.InfoWindow();
                            }
                            if(mapInstance) {
                                google.maps.event.trigger(mapInstance, 'resize');
                                updateMapMarkers();
                            }
                        }, 200);
                    });
                }
            };

            const updateMapMarkers = () => {
                if (!mapInstance) return;
                markers.forEach(m => m.setMap(null)); markers = [];
                const bounds = new google.maps.LatLngBounds();
                let hasPoint = false;

                itinerary.value.forEach(item => {
                    if (item.lat && item.lng) {
                        const pos = { lat: parseFloat(item.lat), lng: parseFloat(item.lng) };
                        const marker = new google.maps.Marker({
                            position: pos, map: mapInstance, label: { text: item.day.toString(), color: "white" }, title: item.name
                        });
                        
                        marker.addListener("click", () => {
                            infoWindow.setContent(`<div style="color:black;padding:5px;"><b>${item.name}</b><br>${item.message||''}</div>`);
                            infoWindow.open(mapInstance, marker);
                        });

                        markers.push(marker);
                        bounds.extend(pos);
                        hasPoint = true;
                    }
                });
                
                if (hasPoint) mapInstance.fitBounds(bounds);
                else if (currentTrip.value && currentTrip.value.city) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: currentTrip.value.city }, (results, status) => {
                        if (status === 'OK') { mapInstance.setCenter(results[0].geometry.location); mapInstance.setZoom(12); }
                    });
                }
            };
            
            const fitBoundsToTrip = () => updateMapMarkers();

            // Other
            const addNewDay = () => { totalDays.value++; currentDay.value = totalDays.value; };
            const addExpense = async () => { 
                if(!newExpense.value.title || !newExpense.value.amount) return;
                const id = generateId();
                const item = { id, ...newExpense.value, involved: people.value.map(p=>p.name) };
                expenses.value.unshift(item);
                newExpense.value.title = ''; newExpense.value.amount = '';
                await sendToApi('add', 'expenses', { ...item, involved: item.involved.join(',') });
            };
            const removeExpense = (idx) => { 
                const item = expenses.value[idx];
                expenses.value.splice(idx, 1);
                sendToApi('del', 'expenses', item.id);
            };
            const addPerson = async () => { 
                if(!newPerson.value) return;
                const id = generateId();
                const p = { id, name: newPerson.value };
                people.value.push(p); newPerson.value = '';
                await sendToApi('add', 'people', p);
            };
            const removePerson = (idx) => {
                const p = people.value[idx];
                if(confirm('ç¢ºå®šç§»é™¤?')) {
                    people.value.splice(idx, 1);
                    sendToApi('del', 'people', p.id);
                }
            };
            const exportItinerary = () => {
                let txt = `ã€${currentTrip.value.name}ã€‘\n`;
                itinerary.value.sort((a,b) => (a.day - b.day) || (a.time||'').localeCompare(b.time||'')).forEach(i => {
                    txt += `D${i.day} ${formatTime(i.time)} ${i.name}\n`;
                });
                navigator.clipboard.writeText(txt).then(() => alert("å·²è¤‡è£½"));
            };
            const resetTrip = async () => { if(confirm('æ¸…ç©º?')) await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'reset_trip', type:'all', tripId: currentTrip.value.id})}); location.reload(); };
            const exitTrip = () => { currentView.value = 'lobby'; currentTrip.value = null; fetchTrips(); };

            onMounted(() => {
                fetchTrips();
                loadGoogleMaps();
            });

            return {
                currentView, trips, newTripName, newTripCity, createTrip, selectTrip, exitTrip,
                currentTab, switchTab, isLoading, currentTrip, currentDay, totalDays, addNewDay,
                itinerary, expenses, people,
                newPlace, newTime, newNote, searchResults, searchPlacesInput, selectPlace, searchInGoogleMaps,
                addPlace, removePlace, editPlace,
                newExpense, categories, addExpense, removeExpense,
                newPerson, addPerson, removePerson,
                fetchData, formatTime, fitBoundsToTrip,
                filteredItinerary: computed(() => itinerary.value.filter(i => parseInt(i.day) == currentDay.value).sort((a,b)=>(a.time||'').localeCompare(b.time||''))),
                balanceSheet: computed(() => {
                    let b={}; people.value.forEach(p=>b[p.name]=0);
                    expenses.value.forEach(e=>{
                        const amt=Number(e.amount);
                        if(b[e.payer]!==undefined) b[e.payer]+=amt;
                        const len = e.involved.length || people.value.length;
                        const share = amt/len;
                        (e.involved.length?e.involved:people.value.map(p=>p.name)).forEach(n=> { if(b[n]!==undefined) b[n]-=share; });
                    });
                    return Object.keys(b).map(n=>({name:n, balance: Math.round(b[n])}));
                }),
                totalExpense: computed(() => expenses.value.reduce((s,i)=>s+(Number(i.amount)||0),0)),
                categoryAnalysis: computed(() => {
                    const s={}; expenses.value.forEach(e=>{ s[e.category] = (s[e.category]||0)+Number(e.amount); });
                    return Object.keys(s).map(k=>({name:k, total:s[k]}));
                }),
                exportItinerary, resetTrip, isMapLoading, isMapReady
            };
        }
    });

    app.mount('#app');
</script>
</body>
</html>
