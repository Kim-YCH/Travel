<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å‡ºç™¼å›‰</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- âœ… ç”¨ UMD globalï¼Œç¢ºä¿ Vue å­˜åœ¨ -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; }
    .mobile-container { max-width: 480px; margin: 0 auto; background: #f8fafc; height: 100%; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    .content-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; display: flex; flex-direction: column; background: #f8fafc; }
    .content-fixed { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
    .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 16px; margin-bottom: 12px; flex-shrink: 0; }

    input, select {
      -webkit-user-select: text; user-select: text;
      border: 1px solid #e2e8f0;
      background-color: #ffffff;
      height: 54px;
      padding: 0 16px;
      font-size: 16px;
      border-radius: 12px;
      width: 100%;
      outline: none;
      transition: all 0.2s;
    }
    input:focus, select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    .day-tab-active { background: #2563eb; color: white; border-color: #2563eb; }
    .day-tab-inactive { background: white; color: #64748b; border-color: #e2e8f0; }
    .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .loading-bar { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: #2563eb; z-index: 9999; animation: loading 1s infinite linear; }
    @keyframes loading { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }

    #map { width: 100%; height: 100%; background-color: #e5e7eb; }

    .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 50; max-height: 250px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 12px; margin-top: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .suggestion-item { padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .suggestion-item:hover { background-color: #f0f9ff; }

    .checkbox-wrapper input:checked + div { background-color: #dbeafe; color: #1e40af; border-color: #2563eb; font-weight: bold; }
    .stat-bar { transition: width 0.5s ease-in-out; }
    .gmnoprint a, .gmnoprint span, .gm-style-cc { display:none; } img[src*="google"] { display: inline !important; }

    .drag-handle { cursor: grab; }
    .drag-handle:active { cursor: grabbing; }

    .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .modal-card { width: 92%; max-width: 360px; background: #fff; border-radius: 18px; padding: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
  </style>
</head>
<body>

<div id="app" class="mobile-container">
  <div v-if="isLoading" class="loading-bar"></div>

  <!-- Lobby -->
  <div v-if="currentView === 'lobby'" class="content-scroll p-6 justify-center bg-gray-50">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">âœˆï¸ å‡ºç™¼å›‰</h1>

    <div class="space-y-4 mb-8">
      <div v-for="trip in trips" :key="trip.id" @click="selectTrip(trip)"
           class="card flex justify-between items-center active:scale-95 transition cursor-pointer border-l-4 border-blue-500 hover:shadow-md">
        <div>
          <div class="font-bold text-xl text-gray-900">{{ trip.name }}</div>
          <div class="text-sm text-gray-500">ğŸ“ {{ trip.city }}</div>
        </div>
        <div class="text-2xl text-gray-300">âœ</div>
      </div>
      <div v-if="trips.length === 0" class="text-center text-gray-400 py-10">å°šç„¡æ—…ç¨‹</div>
    </div>

    <div class="card border border-blue-100">
      <h3 class="font-bold text-gray-700 mb-3">æ–°å¢æ—…ç¨‹</h3>
      <div class="flex flex-col gap-3">
        <input v-model="newTripName" placeholder="æ—…ç¨‹åç¨±">
        <input v-model="newTripCity" placeholder="ä¸»è¦åŸå¸‚">
        <button @click="createTrip" class="w-full bg-blue-600 text-white h-[54px] rounded-xl font-bold shadow active:scale-95 transition text-lg" :disabled="isLoading">å»ºç«‹</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div v-else class="flex flex-col h-full overflow-hidden">
    <header class="bg-blue-600 text-white p-4 pt-12 pb-4 shadow-md sticky top-0 z-50 flex justify-between items-center flex-shrink-0">
      <div>
        <h1 class="text-lg font-bold tracking-wide">{{ currentTrip.name }}</h1>
        <div class="text-xs text-blue-200">
          Day {{ currentDay }} | {{ dayLabel(currentDay) }} | {{ currentTrip.city }}
        </div>
      </div>
      <button @click="fetchData(false)" class="text-xs bg-white/20 px-3 py-1 rounded-full text-white backdrop-blur-sm active:scale-95">â†» åŒæ­¥</button>
    </header>

    <main :class="currentTab === 'map' ? 'content-fixed' : 'content-scroll'" class="bg-gray-50">
      <!-- Itinerary -->
      <div v-if="currentTab === 'itinerary'" class="p-4 space-y-4 pb-24">
        <div class="flex overflow-x-auto pb-2 gap-2 no-scrollbar items-center flex-shrink-0">
          <button v-for="d in totalDays" :key="d"
            @click="onDayClick(d)"
            @dblclick="onDayDblClick(d)"
            class="px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition flex-shrink-0"
            :class="currentDay === d ? 'day-tab-active' : 'day-tab-inactive'">
            <div>Day {{ d }}</div>
            <div class="text-[10px] font-normal opacity-90">
              {{ dayLabel(d) || 'â€”' }}
            </div>
          </button>

          <button @click="addNewDay" class="px-3 py-2 rounded-full border border-gray-300 bg-white font-bold flex-shrink-0 shadow-sm text-gray-600">+</button>
        </div>

        <div class="card relative space-y-2 flex-shrink-0">
          <div class="flex gap-2 relative">
            <input v-model="newPlace" @input="searchPlacesInput" type="text" :placeholder="'æœå°‹ ' + currentTrip.city + '...'" class="flex-1 font-bold">
            <button @click="addPlace" class="bg-blue-600 text-white w-[54px] h-[54px] rounded-xl text-3xl shadow active:scale-95 transition flex items-center justify-center pb-1 flex-shrink-0" :disabled="isLoading">+</button>

            <div v-if="newPlace.length > 0 && (searchResults.length > 0 || isSearching || isCoordinateMode)" class="suggestions-list">
              <div v-if="isSearching" class="p-3 text-center text-gray-400 text-sm">æœå°‹ä¸­...</div>
              <div v-if="isCoordinateMode" @click="useCoordinateInput" class="suggestion-item bg-green-50 hover:bg-green-100 border-green-200">
                <span class="text-xl">ğŸ“</span>
                <div>
                  <div class="font-bold text-green-700 text-sm">{{ resolvedCoordName || 'åº§æ¨™æ¨¡å¼' }}</div>
                  <div class="text-xs text-green-600">é»æ“Šä½¿ç”¨</div>
                </div>
              </div>
              <div v-for="item in searchResults" :key="item.place_id" @click="selectPlace(item)" class="suggestion-item hover:bg-blue-50">
                <span class="text-xl">ğŸ“</span>
                <div class="overflow-hidden">
                  <div class="font-bold text-gray-800 text-sm truncate">{{ item.structured_formatting.main_text }}</div>
                  <div class="text-xs text-gray-500 truncate">{{ item.structured_formatting.secondary_text }}</div>
                </div>
              </div>
              <div v-if="!isCoordinateMode" @click="searchInGoogleMaps" class="suggestion-item hover:bg-gray-100 border-t-2 border-gray-100 cursor-pointer">
                <span class="text-xl">ğŸ”</span>
                <div class="flex-1">
                  <div class="font-bold text-blue-600 text-sm">æ‰¾ä¸åˆ°ï¼Ÿå» Google Maps æ‰¾</div>
                  <div class="text-xs text-gray-400">è¤‡è£½åº§æ¨™è²¼å›ä¾†</div>
                </div>
                <span class="text-gray-300 text-lg">âœ</span>
              </div>
            </div>
          </div>
          <div class="flex gap-2">
            <input v-model="newTime" type="time" class="w-1/3 text-center font-mono">
            <input v-model="newNote" type="text" placeholder="å‚™è¨»..." class="flex-1">
          </div>
        </div>

        <div class="space-y-3 pb-20" ref="itineraryListEl">
          <div v-for="place in filteredItinerary" :key="place.id" :data-id="place.id" class="card flex justify-between items-start active:scale-[0.99] transition">
            <div class="flex items-start gap-2 flex-1">
              <div class="drag-handle text-gray-300 select-none text-2xl leading-none pt-1">â‰¡</div>

              <div class="flex-1" @click="openGoogleMap(place)">
                <div class="flex items-center gap-2 flex-wrap mb-1">
                  <span v-if="place.time" class="text-blue-600 font-mono font-bold text-sm bg-blue-50 px-2 py-0.5 rounded border border-blue-100">{{ formatTime(place.time) }}</span>
                  <span class="font-bold text-lg text-gray-800">{{ place.name }}</span>
                </div>
                <div class="flex gap-2 items-center">
                  <span v-if="place.lat && place.lng" class="text-[10px] text-green-600 bg-green-100 px-1.5 rounded font-bold border border-green-200">å·²å®šä½</span>
                  <span v-else class="text-[10px] text-red-400 bg-red-50 px-1.5 rounded font-bold border border-red-200">ç„¡åº§æ¨™</span>
                  <div v-if="place.message" class="text-sm text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">ğŸ“ {{ place.message }}</div>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-1 pl-3 border-l ml-2">
              <button @click.stop="removePlace(place.id)" class="text-gray-300 hover:text-red-500 px-2 text-xl font-bold" :disabled="isLoading">Ã—</button>
            </div>
          </div>

          <div v-if="filteredItinerary.length===0" class="text-center text-gray-400 mt-10">å°šç„¡è¡Œç¨‹</div>
        </div>
      </div>

      <!-- Map (optional, you can keep your old map code if needed) -->
      <div v-show="currentTab === 'map'" class="content-fixed p-4 w-full">
        <div class="text-center text-gray-500 mt-10">ï¼ˆæ­¤ç‰ˆæœ¬å°ˆæ³¨è¡Œç¨‹/åˆ†å¸³/è³‡æ–™åº«é †åºï¼Œåœ°åœ–å¯æ²¿ç”¨ä½ åŸæœ¬ç‰ˆæœ¬ï¼‰</div>
      </div>

      <!-- Money -->
      <div v-if="currentTab === 'money'" class="p-4 space-y-4 pb-24">
        <div class="card bg-gradient-to-r from-gray-800 to-gray-700 text-white shadow-lg">
          <div class="flex justify-between items-end mb-4"><span class="text-gray-400 text-sm">ç¸½æ”¯å‡º</span><span class="text-3xl font-bold tracking-wider">${{ totalExpense }}</span></div>
          <div class="space-y-1 border-t border-gray-600 pt-3 text-sm">
            <div v-for="res in balanceSheet" :key="res.name" class="flex justify-between">
              <span>{{ res.name }}</span>
              <span :class="res.balance>=0?'text-green-400':'text-red-400'" class="font-bold">{{ res.balance > 0 ? '+' : ''}}{{ Math.round(res.balance) }}</span>
            </div>
          </div>
        </div>

        <div v-if="categoryAnalysis.length > 0" class="card">
          <h3 class="font-bold text-gray-700 text-sm mb-3">ğŸ“Š æ¶ˆè²»åˆ†æ</h3>
          <div class="space-y-3">
            <div v-for="cat in categoryAnalysis" :key="cat.name" class="text-xs">
              <div class="flex justify-between mb-1"><span class="text-gray-600">{{ cat.name }}</span><span class="font-bold text-gray-800">${{ cat.total }} ({{ ((cat.total/totalExpense)*100).toFixed(0) }}%)</span></div>
              <div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full stat-bar" :style="{ width: (cat.total/totalExpense)*100 + '%' }"></div></div>
            </div>
          </div>
        </div>

        <div class="card border border-blue-100">
          <div class="grid grid-cols-3 gap-3 mb-3">
            <input v-model="newExpense.title" placeholder="é …ç›®" class="col-span-2">
            <input v-model.number="newExpense.amount" type="number" placeholder="$" class="font-mono font-bold">
          </div>
          <div class="mb-3 flex gap-2 overflow-x-auto no-scrollbar pb-1">
            <button v-for="cat in categories" :key="cat" @click="newExpense.category = cat"
                    class="px-3 py-1.5 rounded-full border text-xs font-bold whitespace-nowrap transition"
                    :class="newExpense.category === cat ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-200'">{{ cat }}</button>
          </div>
          <div class="mb-3 flex gap-2 items-center">
            <span class="text-lg text-gray-500 font-bold w-10 text-center">ä»˜æ¬¾</span>
            <select v-model="newExpense.payer" class="flex-1">
              <option disabled value="">è«‹é¸æ“‡</option>
              <option v-for="(p, index) in people" :value="p.name">{{ p.name || 'æˆå“¡ ' + (index+1) }}</option>
            </select>
          </div>
          <div class="mb-4">
            <span class="text-xs text-gray-500 font-bold block mb-2 ml-1">åˆ†æ”¤çµ¦ (é»æ“Šåˆ‡æ›)</span>
            <div class="flex flex-wrap gap-2">
              <label v-for="(p, index) in people" :key="p.id" class="checkbox-wrapper cursor-pointer relative">
                <input type="checkbox" :value="p.name" v-model="newExpense.involved" class="absolute opacity-0 w-0 h-0">
                <div class="px-3 py-1.5 rounded-full border border-gray-200 text-sm bg-white transition select-none text-gray-700 hover:bg-gray-50">{{ p.name || 'æˆå“¡ ' + (index+1) }}</div>
              </label>
            </div>
          </div>
          <button @click="addExpense" class="w-full bg-blue-600 text-white h-[54px] rounded-xl font-bold shadow active:scale-95 transition text-lg" :disabled="isLoading">è¨˜å¸³</button>
        </div>

        <div class="space-y-2">
          <div v-for="(exp, idx) in expenses" :key="exp.id" class="card flex justify-between items-center py-3 border-l-4 border-gray-300">
            <div>
              <div class="font-bold text-gray-800 text-lg">{{ exp.title }} <span class="text-xs font-normal text-white bg-gray-400 px-1.5 py-0.5 rounded ml-1">{{ exp.category }}</span></div>
              <div class="text-xs text-gray-500 mt-1">{{ exp.payer }} å…ˆä»˜ <span class="text-gray-300">|</span> {{ formatInvolved(exp.involved) }} åˆ†æ”¤</div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="font-bold text-xl text-gray-800 font-mono">${{ exp.amount }}</span>
              <button @click="removeExpense(idx)" class="text-gray-300 hover:text-red-500 px-2">Ã—</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div v-if="currentTab === 'settings'" class="p-4 space-y-4 pb-24">
        <button @click="exitTrip" class="w-full bg-gray-700 text-white h-[54px] rounded-lg font-bold mb-6 shadow text-lg">ğŸ”™ åˆ‡æ›æ—…ç¨‹</button>

        <h3 class="font-bold text-gray-700 ml-1">ğŸ“‹ è³‡æ–™ç®¡ç†</h3>
        <button @click="exportItinerary" class="w-full bg-white text-blue-600 border border-blue-200 h-[54px] rounded-lg font-bold shadow-sm active:scale-95 transition flex justify-center items-center gap-2"><span>ğŸ“¤</span> åŒ¯å‡ºç´”æ–‡å­—è¡Œç¨‹</button>

        <h3 class="font-bold text-gray-700 mt-6 ml-1">ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
        <div class="flex gap-2"><input v-model="newPerson" placeholder="åå­—" class="flex-1"><button @click="addPerson" class="bg-gray-800 text-white px-4 rounded-lg font-bold">æ–°å¢</button></div>
        <div class="space-y-2 mb-10">
          <div v-for="(p, idx) in people" :key="p.id" class="flex justify-between items-center p-3 bg-white rounded border border-gray-100 shadow-sm">
            <span class="font-bold text-gray-800">{{ p.name || 'æˆå“¡ ' + (idx + 1) }}</span>
            <button @click="removePerson(idx)" class="text-red-400 font-bold px-2">ç§»é™¤</button>
          </div>
        </div>

        <div class="border-t pt-4 mt-4 text-center">
          <button @click="deleteTripTotally" class="w-full bg-red-500 text-white border border-red-600 py-3 rounded-lg font-bold mb-3 shadow-md hover:bg-red-600 transition">âŒ åˆªé™¤æ­¤æ—…ç¨‹</button>
        </div>
      </div>
    </main>

    <nav class="bg-white border-t flex justify-around pb-safe pt-2 pb-2 z-50 flex-shrink-0 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
      <button @click="switchTab('itinerary')" class="flex flex-col items-center w-full transition duration-200" :class="currentTab==='itinerary'?'text-blue-600 scale-110':'text-gray-400'"><span class="text-2xl mb-0.5">ğŸ“</span><span class="text-[10px] font-bold">è¡Œç¨‹</span></button>
      <button @click="switchTab('money')" class="flex flex-col items-center w-full transition duration-200" :class="currentTab==='money'?'text-green-600 scale-110':'text-gray-400'"><span class="text-2xl mb-0.5">ğŸ’°</span><span class="text-[10px] font-bold">åˆ†å¸³</span></button>
      <button @click="switchTab('settings')" class="flex flex-col items-center w-full transition duration-200" :class="currentTab==='settings'?'text-gray-800 scale-110':'text-gray-400'"><span class="text-2xl mb-0.5">âš™ï¸</span><span class="text-[10px] font-bold">è¨­å®š</span></button>
    </nav>
  </div>

  <!-- Modal: Day1(æ—¥æœŸ+äº¤æ›) / å…¶ä»–å¤©(äº¤æ›) -->
  <div v-if="showDayModal" class="modal-mask" @click.self="closeDayModal">
    <div class="modal-card">
      <div class="font-bold text-gray-800 text-lg mb-3">
        Day {{ modalDay }} åŠŸèƒ½
      </div>

      <!-- âœ… åªè®“ Day1 è¨­æ—¥æœŸ -->
      <div v-if="modalDay === 1" class="space-y-3">
        <div class="text-sm text-gray-600 font-bold">è¨­å®š Day1 æ—¥æœŸ</div>
        <input type="date" v-model="dateInput">
      </div>

      <div class="mt-4 space-y-3">
        <div class="text-sm text-gray-600 font-bold">äº¤æ›å¤©æ•¸</div>
        <select v-model.number="swapTarget">
          <option v-for="d in totalDays" :key="d" :value="d" :disabled="d===modalDay">
            Day {{ d }}
          </option>
        </select>
      </div>

      <div class="flex gap-2 mt-5">
        <button class="flex-1 h-[50px] rounded-xl border font-bold text-gray-600" @click="closeDayModal">å–æ¶ˆ</button>
        <button class="flex-1 h-[50px] rounded-xl bg-blue-600 text-white font-bold" @click="applyDayModal">å¥—ç”¨</button>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

createApp({
  setup() {
    // âœ… æ›æˆä½ çš„ Apps Script /exec
    const API_URL = 'https://script.google.com/macros/s/AKfycbyv7LEjXXTnGssx9djolANVxhj7A5Jbq0togPnT2hBXpit6OsW9puoeXzEY0YWub5BU/exec';

    const currentView = ref('lobby');
    const currentTrip = ref(null);
    const trips = ref([]);
    const newTripName = ref('');
    const newTripCity = ref('');

    const currentTab = ref('itinerary');
    const isLoading = ref(false);

    const currentDay = ref(1);
    const totalDays = ref(1);

    const people = ref([]);
    const itinerary = ref([]);
    const expenses = ref([]);

    const newPlace = ref('');
    const newTime = ref('');
    const newNote = ref('');
    const newPerson = ref('');
    const newExpense = ref({ title: '', amount: '', payer: '', involved: [], category: 'é£²é£Ÿ' });
    const categories = ['é£²é£Ÿ', 'äº¤é€š', 'ä½å®¿', 'è³¼ç‰©', 'é–€ç¥¨', 'å…¶ä»–'];

    const searchResults = ref([]);
    const isSearching = ref(false);
    const isCoordinateMode = ref(false);
    const resolvedCoordName = ref('');
    const selectedLat = ref(null);
    const selectedLng = ref(null);
    const selectedPlaceData = ref(null);

    const itineraryListEl = ref(null);
    let sortable = null;

    // Day modal
    const showDayModal = ref(false);
    const modalDay = ref(1);
    const dateInput = ref('');
    const swapTarget = ref(2);

    // ---------- JSONP ----------
    const jsonp = (url, timeoutMs = 15000) => {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1000);
        const sep = url.includes('?') ? '&' : '?';
        const full = `${url}${sep}callback=${cb}`;

        const script = document.createElement('script');
        const timer = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);

        const cleanup = () => {
          clearTimeout(timer);
          if (script.parentNode) script.parentNode.removeChild(script);
          try { delete window[cb]; } catch(e) { window[cb] = undefined; }
        };

        window[cb] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };
        script.src = full;
        document.head.appendChild(script);
      });
    };

    const apiGet = async (paramsObj) => {
      const qs = new URLSearchParams(paramsObj).toString();
      return await jsonp(`${API_URL}?${qs}`);
    };

    // ---------- helpers ----------
    const generateId = () => Date.now() + '_' + Math.floor(Math.random() * 1000);
    const pad2 = (n) => String(n).padStart(2, '0');

    const parseYMD = (s) => {
      if (!s) return null;
      const p = String(s).split('-');
      if (p.length !== 3) return null;
      const y = parseInt(p[0],10), m = parseInt(p[1],10), d = parseInt(p[2],10);
      if (!y || !m || !d) return null;
      // âœ… å›ºå®šä¸­åˆï¼Œé¿å… DST/æ™‚å€é‚Šç•Œå•é¡Œ
      return new Date(y, m-1, d, 12, 0, 0);
    };

    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };

    // âœ… Day1 è¨­å®šå¾Œï¼Œå…¶ä»–å¤©ç”¨æ¨ç®—ï¼ˆä½ è¦çš„é‚è¼¯ï¼‰
    const dayLabel = (day) => {
      const base = parseYMD(currentTrip.value?.start_date);
      if (!base) return '';
      const dt = addDays(base, day-1);
      const wk = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dt.getDay()];
      return `${dt.getFullYear()}/${pad2(dt.getMonth()+1)}/${pad2(dt.getDate())} (${wk})`;
    };

    const formatInvolved = (list) => (!list || list.length === 0) ? 'å…¨å“¡' : (Array.isArray(list) ? list.join(', ') : list);

    const formatTime = (timeStr) => {
      if (!timeStr) return '';
      if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}$/.test(timeStr)) return timeStr;
      try {
        const date = new Date(timeStr);
        if (isNaN(date.getTime())) return timeStr;
        const h = date.getHours().toString().padStart(2, '0');
        const m = date.getMinutes().toString().padStart(2, '0');
        return `${h}:${m}`;
      } catch (e) { return timeStr; }
    };

    const timeToNum = (t) => {
      const s = formatTime(t);
      if (!s) return 999999;
      const p = s.split(':');
      if (p.length !== 2) return 999999;
      const hh = parseInt(p[0],10), mm = parseInt(p[1],10);
      if (Number.isNaN(hh) || Number.isNaN(mm)) return 999999;
      return hh*60+mm;
    };

    // ---------- Orders: DB orders sheet ----------
    const loadOrderFromDB = async (tripId, day) => {
      try {
        const rows = await apiGet({ type: 'orders', tripId });
        const hit = (Array.isArray(rows) ? rows : []).find(r => String(r.day) === String(day));
        if (!hit || !hit.order) return null;
        const ids = String(hit.order).split(',').map(s=>s.trim()).filter(Boolean);
        return ids.length ? ids : null;
      } catch(e) { return null; }
    };

    const saveOrderToDB = async (tripId, day, ids) => {
      const csv = ids.map(x=>String(x)).join(',');
      await apiGet({ action:'save_order', type:'orders', tripId, day: String(day), order: csv });
    };

    const clearOrderFromDB = async (tripId, day) => {
      await apiGet({ action:'clear_order', type:'orders', tripId, day: String(day) });
    };

    // cache orders in memory
    const orderCache = ref({}); // key: `${tripId}_${day}` => ids[]
    const orderKey = (tripId, day) => `${tripId}_${day}`;

    const getOrderIds = (tripId, day) => orderCache.value[orderKey(tripId, day)] || null;
    const setOrderIds = (tripId, day, ids) => { orderCache.value[orderKey(tripId, day)] = ids; };

    // ---------- Data ----------
    const fetchTrips = async () => {
      isLoading.value = true;
      try {
        const data = await apiGet({ type:'trips' });
        trips.value = Array.isArray(data) ? data : [];
      } finally { isLoading.value = false; }
    };

    const createTrip = async () => {
      if(!newTripName.value.trim()) return;
      isLoading.value = true;
      try {
        const id = generateId();
        // âœ… æ–°æ—…ç¨‹è‡ªå‹•ç·¨è™Ÿï¼ˆä½ å•éï¼‰
        const nextNo = trips.value.length + 1;
        const tripName = newTripName.value.trim() || `æ—…ç¨‹ ${nextNo}`;

        const newTrip = { id, name: tripName, city: newTripCity.value || '', start_date: '' };
        trips.value.push(newTrip);

        await apiGet({ action:'add', type:'trips', data: JSON.stringify(newTrip) });

        newTripName.value = ''; newTripCity.value = '';
      } finally { isLoading.value = false; }
    };

    const selectTrip = async (trip) => {
      if(!trip) return;
      currentTrip.value = trip;
      itinerary.value = [];
      expenses.value = [];
      people.value = [];
      currentDay.value = 1;
      totalDays.value = 1;
      currentView.value = 'app';
      await fetchData(true);
    };

    const exitTrip = async () => {
      currentView.value = 'lobby';
      currentTrip.value = null;
      await fetchTrips();
    };

    const deleteTripTotally = async () => {
      if(!currentTrip.value) return;
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿ')) return;
      isLoading.value = true;
      try {
        await apiGet({ action:'del', type:'trips', id: currentTrip.value.id });
        await exitTrip();
      } finally { isLoading.value = false; }
    };

    const fetchData = async (withTrips=false) => {
      if(!currentTrip.value) return;
      isLoading.value = true;
      const tripId = currentTrip.value.id;

      try {
        const [itinData, expData, pplData] = await Promise.all([
          apiGet({ type:'itinerary', tripId }),
          apiGet({ type:'expenses', tripId }),
          apiGet({ type:'people', tripId })
        ]);

        itinerary.value = Array.isArray(itinData) ? itinData : [];
        expenses.value = Array.isArray(expData) ? expData : [];
        people.value = (Array.isArray(pplData) && pplData.length) ? pplData : [{id:'default', name:'æˆ‘'}];

        if (people.value.length) {
          newExpense.value.payer = people.value[0].name;
          newExpense.value.involved = people.value.map(p=>p.name);
        }

        const maxDay = itinerary.value.reduce((m, it) => Math.max(m, it.day ? parseInt(it.day,10) : 1), 1);
        totalDays.value = Math.max(1, maxDay, totalDays.value);

        // âœ… æ›´æ–° start_dateï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡é€²ä¾†æˆ–ä½ æƒ³å¼·åˆ¶åŒæ­¥æ™‚ï¼‰
        if (withTrips) {
          const allTrips = await apiGet({ type:'trips' });
          const t = (Array.isArray(allTrips)?allTrips:[]).find(x=>String(x.id)===String(tripId));
          if (t) currentTrip.value.start_date = t.start_date || '';
        }

        // load order for current day
        const key = orderKey(tripId, currentDay.value);
        if (!orderCache.value[key]) {
          const ids = await loadOrderFromDB(tripId, currentDay.value);
          if (ids) setOrderIds(tripId, currentDay.value, ids);
        }

        await nextTick();
        initSortable();
      } finally {
        isLoading.value = false;
      }
    };

    // ---------- Day interactions ----------
    const onDayClick = async (d) => {
      currentDay.value = d;

      // lazy load order
      if (currentTrip.value) {
        const tripId = currentTrip.value.id;
        const key = orderKey(tripId, d);
        if (!orderCache.value[key]) {
          const ids = await loadOrderFromDB(tripId, d);
          if (ids) setOrderIds(tripId, d, ids);
        }
      }

      await nextTick();
      initSortable();
    };

    const onDayDblClick = (d) => {
      modalDay.value = d;
      // Day1 é è¨­æ—¥æœŸï¼šå¦‚æœå·²æœ‰ start_date ç”¨å®ƒï¼Œä¸ç„¶ç”¨ä»Šå¤©
      if (d === 1) {
        dateInput.value = currentTrip.value?.start_date || '';
      } else {
        dateInput.value = '';
      }
      // swap é è¨­ï¼šé¸ä¸‹ä¸€å¤©æˆ– 1
      swapTarget.value = (d === 1 && totalDays.value >= 2) ? 2 : 1;
      if (swapTarget.value === d) swapTarget.value = (d === 1 ? 2 : 1);
      showDayModal.value = true;
    };

    const closeDayModal = () => { showDayModal.value = false; };

    const applyDayModal = async () => {
      if (!currentTrip.value) return;
      const d = modalDay.value;

      isLoading.value = true;
      try {
        // âœ… Day1 æ‰èƒ½è¨­å®šæ—¥æœŸï¼ˆä½ è¦åˆªé™¤å°æ–¹å¡Šçš„è¨­å®šåŠŸèƒ½å°±æ˜¯é€™å€‹ï¼‰
        if (d === 1) {
          const ymd = String(dateInput.value || '').trim();
          if (ymd) {
            currentTrip.value.start_date = ymd;
            // å¯«å…¥ DBï¼ˆJSONPï¼‰
            await apiGet({ action:'set_trip_start_date', type:'trips', tripId: currentTrip.value.id, start_date: ymd });
          }
        }

        // âœ… äº¤æ›å¤©æ•¸
        const target = Number(swapTarget.value || 0);
        if (target && target !== d) {
          await swapDays(d, target);
        }

        showDayModal.value = false;
        await fetchData(false);
      } finally {
        isLoading.value = false;
      }
    };

    const swapDays = async (dayA, dayB) => {
      if (!currentTrip.value) return;
      dayA = Number(dayA||0); dayB = Number(dayB||0);
      if (!dayA || !dayB || dayA === dayB) return;

      if (!confirm(`ç¢ºå®šäº¤æ› Day ${dayA} èˆ‡ Day ${dayB} çš„æ‰€æœ‰è¡Œç¨‹ï¼Ÿ`)) return;

      await apiGet({ action:'swap_days', type:'itinerary', tripId: currentTrip.value.id, dayA: String(dayA), dayB: String(dayB) });

      // äº¤æ›å¾Œ order ä¹Ÿæ¸…æ‰ï¼Œé¿å…é †åºéŒ¯äº‚
      await clearOrderFromDB(currentTrip.value.id, dayA);
      await clearOrderFromDB(currentTrip.value.id, dayB);
      setOrderIds(currentTrip.value.id, dayA, null);
      setOrderIds(currentTrip.value.id, dayB, null);

      currentDay.value = dayA;
    };

    const addNewDay = () => {
      totalDays.value++;
      currentDay.value = totalDays.value;
      nextTick().then(initSortable);
    };

    // ---------- sortable ----------
    const destroySortable = () => { if (sortable) { sortable.destroy(); sortable = null; } };

    const initSortable = () => {
      destroySortable();
      if (!itineraryListEl.value) return;
      if (currentTab.value !== 'itinerary') return;
      if (!currentTrip.value) return;

      sortable = new Sortable(itineraryListEl.value, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'opacity-50',
        onEnd: async () => {
          try {
            const ids = Array.from(itineraryListEl.value.querySelectorAll('[data-id]'))
              .map(el => el.getAttribute('data-id'))
              .filter(Boolean);

            setOrderIds(currentTrip.value.id, currentDay.value, ids);
            // âœ… å­˜åˆ°è³‡æ–™åº«ï¼ˆorders sheetï¼‰
            await saveOrderToDB(currentTrip.value.id, currentDay.value, ids);
          } catch(e) {}
        }
      });
    };

    const filteredItinerary = computed(() => {
      const day = currentDay.value;
      const list = itinerary.value.filter(i => (i.day ? parseInt(i.day,10) : 1) === day);

      const ids = currentTrip.value ? getOrderIds(currentTrip.value.id, day) : null;
      if (ids && Array.isArray(ids) && ids.length) {
        const map = new Map(list.map(x => [String(x.id), x]));
        const ordered = [];
        ids.forEach(id => { const it = map.get(String(id)); if (it) ordered.push(it); });
        list.forEach(it => { if (!ids.includes(String(it.id))) ordered.push(it); });
        return ordered;
      }

      return list.slice().sort((a,b) => {
        const ta = timeToNum(a.time), tb = timeToNum(b.time);
        if (ta !== tb) return ta - tb;
        return (a.name||'').localeCompare(b.name||'');
      });
    });

    // ---------- Place search (ç°¡åŒ–ï¼šä¿ç•™åº§æ¨™æ¨¡å¼ï¼›ä¸ä¾è³´ Google Places ä»¥é¿å…å¢åŠ  load) ----------
    const searchPlacesInput = () => {
      const q = newPlace.value.trim();
      if(!q) { searchResults.value = []; return; }
      const coordRegex = /^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/;
      if (coordRegex.test(q)) {
        isCoordinateMode.value = true;
        isSearching.value = false;
        const parts = q.split(',');
        selectedLat.value = parseFloat(parts[0]);
        selectedLng.value = parseFloat(parts[1]);
        resolvedCoordName.value = 'åº§æ¨™';
        return;
      }
      isCoordinateMode.value = false;
      selectedLat.value = null;
      selectedLng.value = null;
      resolvedCoordName.value = '';
      // ä¸åš Places autocompleteï¼Œé¿å…è¼‰å…¥ map SDKï¼ˆä½ è¦æé€Ÿï¼‰
      searchResults.value = [];
    };

    const useCoordinateInput = () => { if (resolvedCoordName.value) newPlace.value = resolvedCoordName.value; addPlace(); };
    const selectPlace = (item) => { newPlace.value = item.structured_formatting.main_text; selectedPlaceData.value = item; searchResults.value = []; };
    const searchInGoogleMaps = () => {
      const query = newPlace.value + (currentTrip.value.city ? ' ' + currentTrip.value.city : '');
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
      searchResults.value = [];
    };

    const addPlace = async () => {
      if(!newPlace.value.trim() || !currentTrip.value) return;

      isLoading.value = true;
      try {
        const id = generateId();
        const d = currentDay.value;

        const item = {
          id,
          name: newPlace.value.trim(),
          day: d,
          lat: selectedLat.value,
          lng: selectedLng.value,
          place_id: '',
          message: newNote.value || '',
          time: newTime.value || '',
          trip_id: currentTrip.value.id
        };

        itinerary.value.push(item);

        // æ¸… UI
        newPlace.value = ''; newNote.value = ''; newTime.value = '';
        selectedPlaceData.value = null; searchResults.value = [];
        selectedLat.value = null; selectedLng.value = null;
        resolvedCoordName.value = ''; isCoordinateMode.value = false;

        // å¯«å…¥ DB
        await apiGet({ action:'add', type:'itinerary', data: JSON.stringify(item) });

        // æ›´æ–° orderï¼šæŠŠæ–° id append
        const oldIds = (getOrderIds(currentTrip.value.id, d) || filteredItinerary.value.map(x=>String(x.id)));
        const ids = oldIds.slice();
        ids.push(String(id));
        setOrderIds(currentTrip.value.id, d, ids);
        await saveOrderToDB(currentTrip.value.id, d, ids);

        await nextTick();
        initSortable();
      } finally { isLoading.value = false; }
    };

    const removePlace = async (id) => {
      if(!currentTrip.value) return;
      isLoading.value = true;
      try {
        const i = itinerary.value.findIndex(x=>String(x.id)===String(id));
        if(i!==-1) itinerary.value.splice(i,1);

        await apiGet({ action:'del', type:'itinerary', id: String(id) });

        // order remove
        const ids = (getOrderIds(currentTrip.value.id, currentDay.value) || []).filter(x => String(x) !== String(id));
        setOrderIds(currentTrip.value.id, currentDay.value, ids);
        await saveOrderToDB(currentTrip.value.id, currentDay.value, ids);

        await nextTick();
        initSortable();
      } finally { isLoading.value = false; }
    };

    const openGoogleMap = (p) => {
      if (p.lat && p.lng) window.open(`https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`, '_blank');
      else window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.name + ' ' + (currentTrip.value?.city||''))}`, '_blank');
    };

    const switchTab = (tab) => {
      currentTab.value = tab;
      nextTick().then(initSortable);
    };

    // ---------- Expenses ----------
    const addExpense = async () => {
      if (!currentTrip.value) return;
      if (!newExpense.value.title || !newExpense.value.amount) return;

      isLoading.value = true;
      try {
        const uid = generateId();
        const d = { id: uid, ...newExpense.value, involved: [...newExpense.value.involved], trip_id: currentTrip.value.id };
        expenses.value.unshift(d);

        await apiGet({ action:'add', type:'expenses', data: JSON.stringify({ ...d, involved: d.involved }) });

        newExpense.value = { title: '', amount: '', payer: people.value[0]?.name||'', involved: people.value.map(p=>p.name), category: 'é£²é£Ÿ' };
      } finally { isLoading.value = false; }
    };

    const removeExpense = async (idx) => {
      const item = expenses.value[idx];
      if (!item?.id) return;
      isLoading.value = true;
      try {
        expenses.value.splice(idx, 1);
        await apiGet({ action:'del', type:'expenses', id: item.id });
      } finally { isLoading.value = false; }
    };

    // ---------- People ----------
    const addPerson = async () => {
      if(!currentTrip.value) return;
      const name = newPerson.value.trim();
      if (!name) return;

      isLoading.value = true;
      try {
        const uid = generateId();
        const obj = { id: uid, name, trip_id: currentTrip.value.id };
        people.value.push(obj);
        newExpense.value.involved.push(name);
        newPerson.value = '';

        await apiGet({ action:'add', type:'people', data: JSON.stringify(obj) });
      } finally { isLoading.value = false; }
    };

    const removePerson = async (idx) => {
      const item = people.value[idx];
      if (!item?.id || !confirm('ç§»é™¤ï¼Ÿ')) return;
      isLoading.value = true;
      try {
        people.value.splice(idx, 1);
        await apiGet({ action:'del', type:'people', id: item.id });
      } finally { isLoading.value = false; }
    };

    // ---------- computed ----------
    const totalExpense = computed(() => expenses.value.reduce((s,i)=>s+(Number(i.amount)||0),0));

    const balanceSheet = computed(() => {
      if(!people.value.length) return [];
      let b={};
      people.value.forEach(p=>b[p.name]=0);
      expenses.value.forEach(e=>{
        const amt=Number(e.amount)||0;
        if(b[e.payer]===undefined) return;
        b[e.payer]+=amt;
        const inv=(e.involved&&e.involved.length)?e.involved:people.value.map(p=>p.name);
        const v=inv.filter(n=>b[n]!==undefined);
        if(v.length) {
          const s=amt/v.length;
          v.forEach(n=>b[n]-=s);
        }
      });
      return Object.keys(b).map(n=>({name:n, balance:b[n]}));
    });

    const categoryAnalysis = computed(() => {
      const stats = {};
      expenses.value.forEach(e => {
        const cat = e.category || 'æœªåˆ†é¡';
        stats[cat] = (stats[cat] || 0) + (Number(e.amount) || 0);
      });
      return Object.entries(stats).map(([name, total]) => ({name, total})).sort((a,b)=>b.total-a.total);
    });

    const exportItinerary = () => {
      if (!currentTrip.value) return;
      let text = `ã€${currentTrip.value.name}ã€‘è¡Œç¨‹è¡¨\n\n`;
      for(let d = 1; d <= totalDays.value; d++) {
        text += `ğŸ“… Day ${d}\n`;
        const base = itinerary.value.filter(i => (i.day ? parseInt(i.day,10) : 1) === d);
        // order å„ªå…ˆï¼ˆå¦‚æœ cache æœ‰ï¼‰
        const ids = getOrderIds(currentTrip.value.id, d);
        let dayItems = base.slice();
        if (ids && ids.length) {
          const map = new Map(dayItems.map(x => [String(x.id), x]));
          const ordered = [];
          ids.forEach(id => { const it = map.get(String(id)); if (it) ordered.push(it); });
          dayItems.forEach(it => { if (!ids.includes(String(it.id))) ordered.push(it); });
          dayItems = ordered;
        } else {
          dayItems = dayItems.sort((a,b)=>timeToNum(a.time)-timeToNum(b.time));
        }

        if(dayItems.length === 0) { text += "  (ç„¡è¡Œç¨‹)\n\n"; continue; }
        dayItems.forEach(item => {
          text += `  ${formatTime(item.time) ? formatTime(item.time)+' ' : ''}${item.name} ${item.message ? '('+item.message+')' : ''}\n`;
        });
        text += "\n";
      }
      navigator.clipboard.writeText(text);
      alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    };

    watch(currentDay, () => nextTick().then(initSortable));
    watch(currentTab, () => nextTick().then(initSortable));
    watch(currentView, () => nextTick().then(initSortable));

    onMounted(() => { fetchTrips(); });

    return {
      currentView, currentTrip, trips, newTripName, newTripCity, createTrip, selectTrip, exitTrip, deleteTripTotally,
      currentTab, switchTab, isLoading,
      currentDay, totalDays, addNewDay,
      people, itinerary, expenses, filteredItinerary,
      newPlace, newTime, newNote, newPerson, newExpense, categories,
      searchResults, isSearching, isCoordinateMode, resolvedCoordName,
      searchPlacesInput, useCoordinateInput, selectPlace, searchInGoogleMaps,
      addPlace, removePlace, openGoogleMap,
      addExpense, removeExpense, addPerson, removePerson,
      totalExpense, balanceSheet, categoryAnalysis,
      exportItinerary, fetchData, formatInvolved, formatTime,
      itineraryListEl,
      showDayModal, modalDay, dateInput, swapTarget, closeDayModal, applyDayModal,
      onDayClick, onDayDblClick, dayLabel
    };
  }
}).mount('#app');
</script>

</body>
</html>

