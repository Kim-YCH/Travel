<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºç™¼å›‰</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; 
            -webkit-user-select: none; user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        input, select, textarea { -webkit-user-select: text; user-select: text; }
        
        /* å¤©æ•¸æ¨™ç±¤æ¨£å¼ */
        .day-tab-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .day-tab-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .loading-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 3px; background: #2563eb; z-index: 9999;
            animation: loading 1s infinite linear;
        }
        @keyframes loading { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }

        /* åœ°åœ–å®¹å™¨ */
        #map { height: 100%; width: 100%; border-radius: 16px; z-index: 1; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
    
    <div v-if="isLoading" class="loading-bar"></div>

    <header class="bg-blue-600 text-white p-4 pt-12 pb-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-xl font-bold tracking-wide">â˜ï¸ é›²ç«¯æ—…éŠå¸³æœ¬</h1>
        <button @click="fetchData" class="text-xs bg-blue-700 px-3 py-1 rounded-full text-blue-100 active:scale-95">â†» åŒæ­¥</button>
    </header>

    <main class="flex-1 p-4 pb-24 overflow-y-auto flex flex-col">
        
        <div v-if="currentTab === 'itinerary'" class="space-y-4">
            
            <div class="flex overflow-x-auto pb-2 gap-2 no-scrollbar items-center">
                <button v-for="d in totalDays" :key="d" 
                    @click="currentDay = d"
                    class="px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition flex-shrink-0 tap-highlight-transparent"
                    :class="currentDay === d ? 'day-tab-active' : 'day-tab-inactive'">
                    Day {{ d }}
                </button>
                <button @click="addNewDay" class="px-3 py-2 rounded-full border border-gray-300 text-gray-500 bg-white font-bold flex-shrink-0 active:bg-gray-100 tap-highlight-transparent">
                    +
                </button>
            </div>

            <div class="card p-4 space-y-2">
                <div class="flex gap-2">
                    <input v-model="newPlace" type="text" :placeholder="'æ–°å¢ Day ' + currentDay + ' åœ°é»'" class="flex-1 border-0 bg-gray-100 p-3 rounded-lg outline-none text-lg font-bold">
                    <button @click="addPlace" class="bg-blue-600 text-white w-12 rounded-lg text-2xl shadow active:scale-95 transition" :disabled="isLoading">+</button>
                </div>
                <input v-model="newNote" type="text" placeholder="å‚™è¨» (ä¾‹å¦‚: äº¤é€šæ–¹å¼ã€é ç´„æ™‚é–“...)" class="w-full border-0 bg-gray-50 p-2 rounded-lg outline-none text-sm text-gray-600">
            </div>

            <div class="space-y-3">
                <div v-for="(place, index) in filteredItinerary" :key="place.id" class="card p-4 flex justify-between items-start active:scale-[0.99] transition">
                    <div class="flex-1" @click="openMapLink(place.name)">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-800 text-lg">{{ place.name }}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full text-white" :style="{ backgroundColor: getDayColor(currentDay) }">D{{ currentDay }}</span>
                        </div>
                        <div v-if="place.message" class="text-sm text-gray-500 mt-1 bg-gray-50 p-1 rounded inline-block">
                            ğŸ“ {{ place.message }}
                        </div>
                        <div class="text-xs text-blue-400 mt-1">ğŸ—ºï¸ å°èˆª</div>
                    </div>
                    <button @click.stop="removePlace(place.id)" class="text-gray-300 hover:text-red-500 px-2 text-xl mt-1" :disabled="isLoading">Ã—</button>
                </div>
                <div v-if="filteredItinerary.length === 0 && !isLoading" class="text-center text-gray-400 mt-10">Day {{ currentDay }} å°šç„¡è¡Œç¨‹</div>
            </div>
        </div>

        <div v-show="currentTab === 'map'" class="flex-1 flex flex-col h-full min-h-[400px] relative">
            <div class="absolute top-4 left-4 right-4 z-[9999]">
                <button @click="updateMapMarkers" class="w-full bg-white text-blue-600 font-bold py-2 rounded-full shadow-lg border border-blue-100 active:scale-95 transition text-sm flex justify-center items-center gap-2">
                    <span v-if="isMapLoading" class="animate-spin">â†»</span>
                    {{ isMapLoading ? 'æ­£åœ¨æœå°‹åœ°é»...' : 'ğŸ“ æ›´æ–°åœ°åœ–æ¨™é»' }}
                </button>
            </div>
            <div id="map" class="flex-1 shadow-inner border border-gray-200"></div>
            <div class="bg-white p-2 text-xs flex gap-3 overflow-x-auto whitespace-nowrap border-t">
                <div v-for="d in totalDays" :key="d" class="flex items-center gap-1">
                    <span class="w-3 h-3 rounded-full" :style="{ background: getDayColor(d) }"></span>
                    <span>D{{ d }}</span>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'money'" class="space-y-4">
            <div class="card p-4 bg-gradient-to-r from-gray-800 to-gray-700 text-white shadow-lg">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-gray-300 text-sm">ç¸½æ”¯å‡º</span>
                    <span class="text-2xl font-bold">${{ totalExpense }}</span>
                </div>
                <div class="space-y-2 border-t border-gray-600 pt-3">
                    <div v-for="result in balanceSheet" :key="result.name" class="flex justify-between text-sm items-center">
                        <span class="text-gray-200">{{ result.name }}</span>
                        <div class="flex items-center gap-2">
                            <span :class="result.balance >= 0 ? 'text-green-300' : 'text-red-300'" class="font-mono font-bold text-base">
                                ${{ Math.abs(result.balance).toFixed(0) }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4 border border-blue-100">
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <input v-model="newExpense.title" type="text" placeholder="é …ç›®" class="col-span-2 bg-gray-50 p-3 rounded-lg border-0 ring-1 ring-gray-200 outline-none">
                    <input v-model.number="newExpense.amount" type="number" placeholder="$" class="bg-gray-50 p-3 rounded-lg border-0 ring-1 ring-gray-200 outline-none">
                </div>
                <div class="mb-3 flex gap-2 items-center">
                    <span class="text-xs text-gray-500 w-12">ä»˜æ¬¾äºº</span>
                    <select v-model="newExpense.payer" class="flex-1 bg-gray-50 p-2 rounded border-0 ring-1 ring-gray-200">
                        <option v-for="p in people" :value="p.name">{{ p.name }}</option>
                    </select>
                </div>
                <div class="mb-4">
                    <span class="text-xs text-gray-500 block mb-1">åˆ†æ”¤çµ¦</span>
                    <div class="flex flex-wrap gap-2">
                        <label v-for="p in people" :key="p.id" class="checkbox-wrapper cursor-pointer relative">
                            <input type="checkbox" :value="p.name" v-model="newExpense.involved" class="absolute opacity-0 w-0 h-0">
                            <div class="px-3 py-1 rounded-full border border-gray-200 text-sm text-gray-500 bg-white transition select-none">
                                {{ p.name }}
                            </div>
                        </label>
                    </div>
                </div>
                <button @click="addExpense" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow" :disabled="isLoading">è¨˜å¸³</button>
            </div>

            <div class="space-y-2 pb-10">
                <div v-for="(exp, index) in expenses" :key="exp.id" class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-blue-500 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-800">{{ exp.title }}</div>
                        <div class="text-xs text-gray-500">
                            <span class="font-bold text-blue-600">{{ exp.payer }}</span> å…ˆä»˜
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-gray-800 text-lg">${{ exp.amount }}</span>
                        <button @click="removeExpense(index)" class="text-gray-300 hover:text-red-500 px-2 text-xl">Ã—</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'settings'" class="card p-4">
            <h3 class="font-bold mb-4 text-gray-700">ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
            <div class="flex gap-2 mb-6">
                <input v-model="newPerson" type="text" placeholder="åå­—" class="flex-1 bg-gray-100 p-2 rounded">
                <button @click="addPerson" class="bg-gray-800 text-white px-4 rounded">æ–°å¢</button>
            </div>
            <div class="space-y-2 mb-10">
                <div v-for="(p, index) in people" :key="p.id" class="flex justify-between items-center p-3 bg-gray-50 rounded border border-gray-100">
                    <span class="font-medium">{{ p.name }}</span>
                    <button @click="removePerson(index)" class="text-red-400 text-sm">ç§»é™¤</button>
                </div>
            </div>
            <div class="border-t pt-6 mt-6">
                <button @click="resetApp" class="w-full bg-red-50 text-red-600 border border-red-200 py-3 rounded-lg font-bold active:bg-red-100 transition">
                    ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™
                </button>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around pb-safe pt-2 pb-2 z-50">
        <button @click="switchTab('itinerary')" class="flex flex-col items-center w-full tap-highlight-transparent" :class="currentTab === 'itinerary' ? 'text-blue-600' : 'text-gray-400'">
            <span class="text-xl">ğŸ“</span><span class="text-xs mt-1">è¡Œç¨‹</span>
        </button>
        <button @click="switchTab('map')" class="flex flex-col items-center w-full tap-highlight-transparent" :class="currentTab === 'map' ? 'text-purple-600' : 'text-gray-400'">
            <span class="text-xl">ğŸ—ºï¸</span><span class="text-xs mt-1">åœ°åœ–</span>
        </button>
        <button @click="switchTab('money')" class="flex flex-col items-center w-full tap-highlight-transparent" :class="currentTab === 'money' ? 'text-green-600' : 'text-gray-400'">
            <span class="text-xl">ğŸ’°</span><span class="text-xs mt-1">åˆ†å¸³</span>
        </button>
        <button @click="switchTab('settings')" class="flex flex-col items-center w-full tap-highlight-transparent" :class="currentTab === 'settings' ? 'text-gray-600' : 'text-gray-400'">
            <span class="text-xl">âš™ï¸</span><span class="text-xs mt-1">è¨­å®š</span>
        </button>
    </nav>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // â˜…â˜…â˜… è«‹æ›¿æ›æˆæ‚¨çš„ API ç¶²å€ â˜…â˜…â˜…
            const API_URL = 'https://script.google.com/macros/s/AKfycbzCY554TEj4JSALyOrGhpiXE97zP2W3jRg8huIIbJBY7gBdwbBv4EMvW70lxqH5NxzE/exec';

            const currentTab = ref('itinerary');
            const isLoading = ref(false);
            const isMapLoading = ref(false);
            const currentDay = ref(1);
            const totalDays = ref(1);

            const people = ref([]);
            const itinerary = ref([]);
            const expenses = ref([]);

            const newPlace = ref('');
            const newNote = ref(''); // æ–°å¢å‚™è¨»æ¬„ä½
            const newPerson = ref('');
            const newExpense = ref({ title: '', amount: '', payer: '', involved: [] });

            // åœ°åœ–ç›¸é—œ
            let mapInstance = null;
            let markersLayer = null;

            // ä¸åŒå¤©æ•¸çš„é¡è‰² (å¾ªç’°ä½¿ç”¨)
            const dayColors = ['#2563eb', '#dc2626', '#16a34a', '#d97706', '#9333ea', '#db2777', '#0891b2'];
            const getDayColor = (day) => dayColors[(day - 1) % dayColors.length];

            const generateId = () => Date.now() + '_' + Math.floor(Math.random() * 1000);

            // åˆ‡æ›åˆ†é  (è™•ç†åœ°åœ–åˆå§‹åŒ–)
            const switchTab = (tab) => {
                currentTab.value = tab;
                if (tab === 'map') {
                    // ç­‰å¾…ç•«é¢åˆ‡æ›å®Œæˆå¾Œå†åˆå§‹åŒ–åœ°åœ–
                    nextTick(() => {
                        initMap();
                    });
                }
            };

            const fetchData = async () => {
                if(!API_URL.includes('google')) return alert('è«‹å…ˆè¨­å®š API ç¶²å€');
                isLoading.value = true;
                try {
                    const [resItin, resExp, resPpl] = await Promise.all([
                        fetch(`${API_URL}?type=itinerary`),
                        fetch(`${API_URL}?type=expenses`),
                        fetch(`${API_URL}?type=people`)
                    ]);
                    
                    const itinData = await resItin.json();
                    itinerary.value = itinData;
                    if (itinData.length > 0) {
                        const maxDay = itinData.reduce((max, item) => {
                            const d = item.day ? parseInt(item.day) : 1;
                            return d > max ? d : max;
                        }, 1);
                        if (maxDay > totalDays.value) totalDays.value = maxDay;
                    }

                    expenses.value = await resExp.json();
                    const pplData = await resPpl.json();
                    people.value = pplData.length ? pplData : [{id: 'default', name: 'æˆ‘'}];
                    
                    if(people.value.length > 0) {
                        newExpense.value.payer = people.value[0].name;
                        newExpense.value.involved = people.value.map(p => p.name);
                    }
                } catch (e) { console.error(e); } finally { isLoading.value = false; }
            };

            onMounted(() => fetchData());

            const sendToApi = async (action, type, dataOrId) => {
                const body = { action, type };
                if (action === 'add') body.data = dataOrId;
                else body.id = dataOrId;
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) });
            };

            // --- åœ°åœ–åŠŸèƒ½ ---
            const initMap = () => {
                if (mapInstance) {
                    mapInstance.invalidateSize(); // ä¿®æ­£åœ°åœ–ç ´åœ–
                    return;
                }
                // é è¨­ä¸­å¿ƒ (å¯ä»¥è¨­åœ¨æ±äº¬æˆ–å°ç£)
                mapInstance = L.map('map').setView([23.6, 121], 7); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap'
                }).addTo(mapInstance);
                markersLayer = L.layerGroup().addTo(mapInstance);
            };

            // æœå°‹åº§æ¨™ä¸¦æ¨™é»
            const updateMapMarkers = async () => {
                if (!itinerary.value.length) return alert('ç›®å‰æ²’æœ‰è¡Œç¨‹å¯é¡¯ç¤º');
                isMapLoading.value = true;
                markersLayer.clearLayers(); // æ¸…é™¤èˆŠæ¨™è¨˜

                const bounds = L.latLngBounds();
                let hasPoint = false;

                // æ‰¹æ¬¡è™•ç†æ¯å€‹è¡Œç¨‹
                for (const item of itinerary.value) {
                    if (!item.name) continue;
                    
                    try {
                        // ä½¿ç”¨ Nominatim å…è²» API æœå°‹
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.name)}`);
                        const data = await res.json();
                        
                        if (data && data.length > 0) {
                            const lat = data[0].lat;
                            const lon = data[0].lon;
                            const day = item.day ? parseInt(item.day) : 1;
                            const color = getDayColor(day);
                            
                            // ç¹ªè£½åœ“é»æ¨™è¨˜
                            const marker = L.circleMarker([lat, lon], {
                                color: color,
                                fillColor: color,
                                fillOpacity: 0.8,
                                radius: 8
                            }).bindPopup(`<b>Day ${day}: ${item.name}</b><br>${item.message || ''}`);
                            
                            marker.addTo(markersLayer);
                            bounds.extend([lat, lon]);
                            hasPoint = true;
                        }
                        // é¿å…è«‹æ±‚å¤ªå¿«è¢« API å°é–ï¼ŒåŠ ä¸€é»å»¶é²
                        await new Promise(r => setTimeout(r, 600)); 

                    } catch (e) {
                        console.error(`æ‰¾ä¸åˆ°åœ°é»: ${item.name}`);
                    }
                }

                if (hasPoint) {
                    mapInstance.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    alert('ç„¡æ³•æ‰¾åˆ°åœ°é»åº§æ¨™ï¼Œè«‹ç¢ºèªåœ°é»åç¨±æ˜¯å¦æ­£ç¢º (å»ºè­°è¼¸å…¥å®Œæ•´åç¨±ï¼Œå¦‚: å¤§é˜ªåŸ)');
                }
                isMapLoading.value = false;
            };

            // --- è¡Œç¨‹åŠŸèƒ½ ---
            const filteredItinerary = computed(() => itinerary.value.filter(item => (item.day ? parseInt(item.day) : 1) === currentDay.value));
            
            const addPlace = async () => {
                if (!newPlace.value.trim()) return;
                const uniqueId = generateId();
                const name = newPlace.value;
                const msg = newNote.value; // å–å¾—å‚™è¨»
                const day = currentDay.value;

                // æ–°å¢è³‡æ–™ (åŒ…å« message)
                itinerary.value.push({ id: uniqueId, name: name, day: day, message: msg });
                newPlace.value = '';
                newNote.value = '';

                await sendToApi('add', 'itinerary', { id: uniqueId, name: name, day: day, message: msg });
            };

            const removePlace = async (idToDelete) => {
                const index = itinerary.value.findIndex(item => item.id === idToDelete);
                if (index !== -1) {
                    itinerary.value.splice(index, 1);
                    await sendToApi('del', 'itinerary', idToDelete);
                }
            };

            // åŸæœ¬çš„å°èˆªé€£çµ
            const openMapLink = (name) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`, '_blank');
            
            const addNewDay = () => { totalDays.value++; currentDay.value = totalDays.value; };

            // --- å…¶ä»– (è¨˜å¸³ã€æˆå“¡ã€é‡ç½®) ç¶­æŒä¸è®Š ---
            const resetApp = async () => {
                if (!confirm('è­¦å‘Šï¼šé€™å°‡æœƒã€Œæ°¸ä¹…åˆªé™¤ã€æ‰€æœ‰è³‡æ–™ï¼')) return;
                if (!confirm('å†æ¬¡ç¢ºèªï¼šåˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼')) return;
                isLoading.value = true;
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'reset_all', type: 'all' }) });
                itinerary.value = []; expenses.value = []; people.value = [{id: 'default', name: 'æˆ‘'}];
                totalDays.value = 1; currentDay.value = 1; isLoading.value = false;
                markersLayer.clearLayers();
                alert('å·²é‡ç½®');
            };

            const addExpense = async () => {
                if (!newExpense.value.title || !newExpense.value.amount) return;
                const uniqueId = generateId();
                const dataObj = { id: uniqueId, ...newExpense.value, involved: [...newExpense.value.involved] };
                expenses.value.unshift(dataObj);
                await sendToApi('add', 'expenses', { ...dataObj, involved: dataObj.involved.join(',') });
                newExpense.value = { title: '', amount: '', payer: people.value[0]?.name||'', involved: people.value.map(p=>p.name) };
            };
            const removeExpense = async (index) => {
                const item = expenses.value[index];
                if (!item.id) return;
                expenses.value.splice(index, 1);
                await sendToApi('del', 'expenses', item.id);
            };
            const addPerson = async () => {
                if (!newPerson.value.trim()) return;
                const uniqueId = generateId();
                people.value.push({ id: uniqueId, name: newPerson.value });
                newExpense.value.involved.push(newPerson.value);
                newPerson.value = '';
                await sendToApi('add', 'people', { id: uniqueId, name: newPerson.value });
            };
            const removePerson = async (index) => {
                const item = people.value[index];
                if (!item.id || !confirm('ç§»é™¤æˆå“¡ï¼Ÿ')) return;
                people.value.splice(index, 1);
                await sendToApi('del', 'people', item.id);
            };

            const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (Number(item.amount) || 0), 0));
            const balanceSheet = computed(() => {
                if (people.value.length === 0) return [];
                let balances = {};
                people.value.forEach(p => balances[p.name] = 0);
                expenses.value.forEach(exp => {
                    const amount = Number(exp.amount) || 0;
                    const payer = exp.payer;
                    if (balances[payer] === undefined) return;
                    balances[payer] += amount;
                    const involvedList = (exp.involved && exp.involved.length > 0) ? exp.involved : people.value.map(p=>p.name);
                    const validInvolved = involvedList.filter(name => balances[name] !== undefined);
                    if (validInvolved.length > 0) {
                        const splitAmount = amount / validInvolved.length;
                        validInvolved.forEach(name => balances[name] -= splitAmount);
                    }
                });
                return Object.keys(balances).map(name => ({ name: name, balance: balances[name] }));
            });

            const formatInvolved = (list) => Array.isArray(list) ? list.join(', ') : list;

            return {
                currentTab, switchTab, isLoading, isMapLoading, currentDay, totalDays, addNewDay, getDayColor,
                people, itinerary, filteredItinerary, expenses,
                newPlace, newNote, newPerson, newExpense,
                addPlace, removePlace, openMapLink, updateMapMarkers,
                addExpense, removeExpense, addPerson, removePerson, resetApp,
                totalExpense, balanceSheet, formatInvolved, fetchData
            };
        }
    }).mount('#app');
</script>
</body>

</html>

