<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯æ—…éŠå¸³æœ¬</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f0f2f5; 
            -webkit-user-select: none; user-select: none;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        input, select, textarea { -webkit-user-select: text; user-select: text; }
        
        .day-tab-active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .day-tab-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .loading-bar { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: #2563eb; z-index: 9999; animation: loading 1s infinite linear; }
        @keyframes loading { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }

        #map { height: 100%; width: 100%; z-index: 1; }
        .popup-btn { background-color: #2563eb; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px; width: 100%; }
        
        .suggestions-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50; max-height: 200px; overflow-y: auto; margin-top: 4px; border: 1px solid #e5e7eb;
        }
        .suggestion-item { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
        .suggestion-item:active { background-color: #eff6ff; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col h-screen">
    
    <div v-if="isLoading" class="loading-bar"></div>

    <header class="bg-blue-600 text-white p-4 pt-12 pb-4 shadow-md sticky top-0 z-50 flex justify-between items-center flex-shrink-0">
        <h1 class="text-xl font-bold tracking-wide">â˜ï¸ é›²ç«¯æ—…éŠå¸³æœ¬</h1>
        <div class="flex gap-2">
            <span class="text-xs bg-blue-800 px-2 py-1 rounded text-blue-200">Day {{ currentDay }}</span>
            <button @click="fetchData" class="text-xs bg-blue-700 px-3 py-1 rounded-full text-blue-100 active:scale-95">â†» åŒæ­¥</button>
        </div>
    </header>

    <main class="flex-1 overflow-hidden flex flex-col relative bg-gray-50">
        
        <div v-if="currentTab === 'itinerary'" class="p-4 overflow-y-auto flex-1 space-y-4">
            
            <div class="flex overflow-x-auto pb-2 gap-2 no-scrollbar items-center">
                <button v-for="d in totalDays" :key="d" @click="currentDay = d"
                    class="px-4 py-2 rounded-full border text-sm font-bold whitespace-nowrap transition flex-shrink-0"
                    :class="currentDay === d ? 'day-tab-active' : 'day-tab-inactive'">
                    Day {{ d }}
                </button>
                <button @click="addNewDay" class="px-3 py-2 rounded-full border border-gray-300 bg-white font-bold flex-shrink-0">+</button>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center gap-2">
                <span class="text-xl">ğŸ“</span>
                <input v-model="targetCity" @change="saveCityPref" type="text" placeholder="è¨­å®šåŸå¸‚ (å¦‚: å°å—, äº¬éƒ½)" 
                       class="flex-1 bg-transparent border-0 outline-none text-blue-900 font-bold placeholder-blue-300">
            </div>

            <div class="card p-4 space-y-2 relative">
                <div class="flex gap-2 relative">
                    <input v-model="newPlace" @input="searchPlacesInput" type="text" 
                           :placeholder="targetCity ? 'æœå°‹ ' + targetCity + ' çš„åœ°é»...' : 'æœå°‹åœ°é»...'" 
                           class="flex-1 border-0 bg-gray-100 p-3 rounded-lg outline-none font-bold">
                    <button @click="addPlace" class="bg-blue-600 text-white w-12 rounded-lg text-2xl shadow active:scale-95 transition" :disabled="isLoading">+</button>
                    
                    <div v-if="searchResults.length > 0" class="suggestions-list">
                        <div v-for="item in searchResults" :key="item.place_id" @click="selectPlace(item)" class="suggestion-item">
                            <div class="font-bold text-gray-800 text-sm">{{ item.display_name.split(',')[0] }}</div>
                            <div class="text-xs text-gray-500 truncate">{{ item.display_name }}</div>
                        </div>
                    </div>
                </div>
                <input v-model="newNote" type="text" placeholder="å‚™è¨»..." class="w-full border-0 bg-gray-50 p-2 rounded-lg outline-none text-sm text-gray-600">
            </div>

            <div class="space-y-3 pb-20">
                <div v-for="place in filteredItinerary" :key="place.id" class="card p-4 flex justify-between items-start active:scale-[0.99] transition">
                    <div class="flex-1" @click="openGoogleMap(place)">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-800 text-lg">{{ place.name }}</span>
                            <span v-if="place.lat" class="text-[10px] text-green-600 bg-green-100 px-1 rounded">ğŸ“</span>
                        </div>
                        <div v-if="place.message" class="text-sm text-gray-500 mt-1 bg-gray-50 p-1 rounded inline-block">ğŸ“ {{ place.message }}</div>
                    </div>
                    <button @click.stop="removePlace(place.id)" class="text-gray-300 hover:text-red-500 px-2 text-xl" :disabled="isLoading">Ã—</button>
                </div>
                <div v-if="filteredItinerary.length === 0" class="text-center text-gray-400 mt-10">å°šç„¡è¡Œç¨‹ï¼Œå¯å»åœ°åœ–æ¢ç´¢</div>
            </div>
        </div>

        <div v-show="currentTab === 'map'" class="absolute inset-0 flex flex-col z-10">
            <div class="absolute top-4 left-4 right-4 z-[500] flex flex-col gap-2">
                <div class="flex shadow-lg rounded-lg overflow-hidden">
                    <input v-model="mapSearchQuery" @keyup.enter="searchCityAndJump" type="text" 
                           :placeholder="targetCity ? 'è·³è½‰è‡³ ' + targetCity + '...' : 'è¼¸å…¥åŸå¸‚...'" 
                           class="flex-1 p-3 border-0 outline-none h-12">
                    <button @click="searchCityAndJump" class="bg-blue-600 text-white px-4 font-bold h-12">å‰å¾€</button>
                </div>
                <div class="flex gap-2">
                    <button @click="exploreNearby" class="flex-1 bg-white text-purple-700 font-bold py-2 rounded-lg shadow-lg border border-purple-100 active:scale-95 transition text-sm flex justify-center items-center gap-1">
                        <span v-if="isMapLoading" class="animate-spin">â†»</span>
                        {{ isMapLoading ? 'æœå°‹ä¸­...' : 'ğŸ” æœå°‹æ­¤å€åŸŸæ™¯é»' }}
                    </button>
                    <button @click="showMyItineraryOnMap" class="flex-1 bg-white text-gray-700 font-bold py-2 rounded-lg shadow-lg border border-gray-100 active:scale-95 transition text-sm">ğŸ“ é¡¯ç¤ºè¡Œç¨‹</button>
                </div>
            </div>
            <div id="map" class="flex-1 bg-gray-100"></div>
            <div class="bg-white/90 backdrop-blur p-2 text-xs text-center text-gray-500 absolute bottom-20 left-4 right-4 rounded-lg shadow pointer-events-none z-[500]">ğŸ’¡ é»æ“Šåœ°åœ–å¯æ–°å¢åœ°é»</div>
        </div>

        <div v-if="currentTab === 'money'" class="p-4 overflow-y-auto space-y-4 pb-24">
            <div class="card p-4 bg-gradient-to-r from-gray-800 to-gray-700 text-white shadow-lg">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-gray-300 text-sm">ç¸½æ”¯å‡º</span>
                    <span class="text-2xl font-bold">${{ totalExpense }}</span>
                </div>
                <div class="space-y-2 border-t border-gray-600 pt-3">
                    <div v-for="res in balanceSheet" :key="res.name" class="flex justify-between text-sm">
                        <span>{{ res.name }}</span>
                        <span :class="res.balance >= 0 ? 'text-green-300' : 'text-red-300'" class="font-mono font-bold">${{ Math.abs(res.balance).toFixed(0) }}</span>
                    </div>
                </div>
            </div>
            <div class="card p-4 border border-blue-100">
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <input v-model="newExpense.title" placeholder="é …ç›®" class="col-span-2 bg-gray-50 p-3 rounded-lg border-0 ring-1 ring-gray-200">
                    <input v-model.number="newExpense.amount" type="number" placeholder="$" class="bg-gray-50 p-3 rounded-lg border-0 ring-1 ring-gray-200">
                </div>
                <div class="mb-3 flex gap-2"><select v-model="newExpense.payer" class="flex-1 bg-gray-50 p-2 rounded border ring-1 ring-gray-200"><option v-for="p in people" :value="p.name">{{p.name}}</option></select></div>
                <button @click="addExpense" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">è¨˜å¸³</button>
            </div>
            <div class="space-y-2">
                <div v-for="(exp, idx) in expenses" :key="exp.id" class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-blue-500 flex justify-between">
                    <div><div class="font-bold">{{exp.title}}</div><div class="text-xs text-gray-500">{{exp.payer}} ä»˜æ¬¾</div></div>
                    <div class="flex items-center gap-2"><span class="font-bold">${{exp.amount}}</span><button @click="removeExpense(idx)" class="text-red-300">Ã—</button></div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'settings'" class="p-4 space-y-4">
            <h3 class="font-bold text-gray-700">ğŸ‘¥ æˆå“¡ç®¡ç†</h3>
            <div class="flex gap-2">
                <input v-model="newPerson" placeholder="åå­—" class="flex-1 bg-gray-100 p-2 rounded">
                <button @click="addPerson" class="bg-gray-800 text-white px-4 rounded">æ–°å¢</button>
            </div>
            <div class="space-y-2">
                <div v-for="(p, idx) in people" :key="p.id" class="flex justify-between p-3 bg-gray-50 rounded border border-gray-100">
                    <span>{{ p.name }}</span><button @click="removePerson(idx)" class="text-red-400">ç§»é™¤</button>
                </div>
            </div>
            <div class="border-t pt-4 mt-4"><button @click="resetApp" class="w-full bg-red-50 text-red-600 border border-red-200 py-3 rounded-lg font-bold">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button></div>
        </div>
    </main>

    <nav class="bg-white border-t flex justify-around pb-safe pt-2 pb-2 z-50 flex-shrink-0">
        <button @click="switchTab('itinerary')" class="flex flex-col items-center w-full" :class="currentTab==='itinerary'?'text-blue-600':'text-gray-400'"><span class="text-xl">ğŸ“</span><span class="text-xs">è¡Œç¨‹</span></button>
        <button @click="switchTab('map')" class="flex flex-col items-center w-full" :class="currentTab==='map'?'text-purple-600':'text-gray-400'"><span class="text-xl">ğŸ—ºï¸</span><span class="text-xs">æ¢ç´¢</span></button>
        <button @click="switchTab('money')" class="flex flex-col items-center w-full" :class="currentTab==='money'?'text-green-600':'text-gray-400'"><span class="text-xl">ğŸ’°</span><span class="text-xs">åˆ†å¸³</span></button>
        <button @click="switchTab('settings')" class="flex flex-col items-center w-full" :class="currentTab==='settings'?'text-gray-600':'text-gray-400'"><span class="text-xl">âš™ï¸</span><span class="text-xs">è¨­å®š</span></button>
    </nav>
</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() {
            // â˜…â˜…â˜… è«‹ç¢ºèªé€™è£¡æ˜¯æ‚¨çš„å®Œæ•´ç¶²å€ â˜…â˜…â˜…
            const API_URL = 'https://script.google.com/macros/s/AKfycbzCY554TEj4JSALyOrGhpiXE97zP2W3jRg8huIIbJBY7gBdwbBv4EMvW70lxqH5NxzE/exec';

            // State
            const currentTab = ref('itinerary');
            const isLoading = ref(false);
            const isMapLoading = ref(false);
            const currentDay = ref(1);
            const totalDays = ref(1);
            
            const people = ref([]);
            const itinerary = ref([]);
            const expenses = ref([]);

            // Form
            const newPlace = ref('');
            const newNote = ref('');
            const newPerson = ref('');
            const newExpense = ref({ title: '', amount: '', payer: '', involved: [] });
            
            // â˜… æ–°å¢ï¼šç›®æ¨™åŸå¸‚ (æœƒå„²å­˜åœ¨æ‰‹æ©Ÿè£¡)
            const targetCity = ref(localStorage.getItem('travel_city') || '');
            const saveCityPref = () => localStorage.setItem('travel_city', targetCity.value);

            // Search & Map
            const searchResults = ref([]);
            const selectedLat = ref(null);
            const selectedLng = ref(null);
            const mapSearchQuery = ref('');
            let searchTimeout = null;
            let mapInstance = null;
            let markersLayer = null;
            let exploreLayer = null;

            const dayColors = ['#2563eb', '#dc2626', '#16a34a', '#d97706', '#9333ea', '#db2777', '#0891b2'];
            const getDayColor = (d) => dayColors[(d - 1) % dayColors.length];
            const generateId = () => Date.now() + '_' + Math.floor(Math.random() * 1000);

            // Fetch
            const fetchData = async () => {
                if(!API_URL.includes('google')) return alert('API URL æœªè¨­å®š');
                isLoading.value = true;
                try {
                    const [resItin, resExp, resPpl] = await Promise.all([
                        fetch(`${API_URL}?type=itinerary`),
                        fetch(`${API_URL}?type=expenses`),
                        fetch(`${API_URL}?type=people`)
                    ]);
                    const itinData = await resItin.json();
                    itinerary.value = itinData;
                    if(itinData.length > 0) {
                        const max = itinData.reduce((m, i) => Math.max(m, i.day ? parseInt(i.day) : 1), 1);
                        if(max > totalDays.value) totalDays.value = max;
                    }
                    expenses.value = await resExp.json();
                    const ppl = await resPpl.json();
                    people.value = ppl.length ? ppl : [{id:'default', name:'æˆ‘'}];
                    if(people.value.length) {
                        newExpense.value.payer = people.value[0].name;
                        newExpense.value.involved = people.value.map(p=>p.name);
                    }
                } catch(e) { console.error(e); } finally { isLoading.value = false; }
            };
            onMounted(() => fetchData());

            const sendToApi = async (action, type, data) => {
                const body = { action, type };
                if (action === 'add') body.data = data; else body.id = data;
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) });
            };

            // --- â˜… æ™ºæ…§æœå°‹åŠŸèƒ½ (v14.0) ---
            const searchPlacesInput = () => {
                const q = newPlace.value.trim();
                const city = targetCity.value.trim(); // å–å¾—é–å®šçš„åŸå¸‚

                if(q.length < 2) { searchResults.value = []; return; }
                if(searchTimeout) clearTimeout(searchTimeout);
                
                searchTimeout = setTimeout(async () => {
                    try {
                        // â˜… é—œéµä¿®æ”¹ï¼šå¦‚æœæœ‰é»åŸå¸‚ï¼Œæœå°‹é—œéµå­—è‡ªå‹•è®Šæˆ "åœ°å, åŸå¸‚å"
                        // ä¾‹å¦‚: è¼¸å…¥ "è¥¿é–€å¸‚å ´"ï¼Œç³»çµ±æœ "è¥¿é–€å¸‚å ´, å°å—"
                        const query = city ? `${q}, ${city}` : q;
                        
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                        searchResults.value = await res.json();
                    } catch(e){}
                }, 500);
            };

            const selectPlace = (item) => {
                newPlace.value = item.display_name.split(',')[0];
                selectedLat.value = item.lat; selectedLng.value = item.lon;
                searchResults.value = [];
            };

            // --- åœ°åœ–åŠŸèƒ½ ---
            const switchTab = (tab) => {
                currentTab.value = tab;
                if(tab === 'map') {
                    // å¦‚æœæœ‰é»åŸå¸‚ï¼Œåœ°åœ–æœå°‹é è¨­å¡«å…¥è©²åŸå¸‚
                    if(targetCity.value && !mapSearchQuery.value) mapSearchQuery.value = targetCity.value;
                    nextTick(() => initMap());
                }
            };

            const initMap = () => {
                if(mapInstance) { mapInstance.invalidateSize(); return; }
                mapInstance = L.map('map').setView([23.6, 121], 7);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(mapInstance);
                markersLayer = L.layerGroup().addTo(mapInstance);
                exploreLayer = L.layerGroup().addTo(mapInstance);

                mapInstance.on('click', async (e) => {
                    const { lat, lng } = e.latlng;
                    const tempMarker = L.marker([lat, lng]).addTo(mapInstance).bindPopup('æŸ¥è©¢ä¸­...').openPopup();
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                        const data = await res.json();
                        const name = data.display_name ? data.display_name.split(',')[0] : 'åœ°é»';
                        tempMarker.setPopupContent(`
                            <div style="text-align:center"><b>${name}</b><br>
                            <button class="popup-btn" onclick="document.dispatchEvent(new CustomEvent('add-from-map', {detail: {name: '${name}', lat: ${lat}, lng: ${lng}}}))">â• åŠ å…¥ Day ${currentDay.value}</button></div>
                        `);
                    } catch(err) { tempMarker.setPopupContent('æœªçŸ¥åœ°é»'); }
                });
                document.addEventListener('add-from-map', (e) => addPlaceFromMap(e.detail));
                showMyItineraryOnMap();
                
                // å¦‚æœæœ‰è¨­å®šåŸå¸‚ï¼Œåˆå§‹åŒ–æ™‚è©¦è‘—è·³éå»
                if(targetCity.value) { mapSearchQuery.value = targetCity.value; searchCityAndJump(); }
            };

            const searchCityAndJump = async () => {
                if(!mapSearchQuery.value) return;
                isMapLoading.value = true;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(mapSearchQuery.value)}`);
                    const data = await res.json();
                    if(data.length > 0) {
                        mapInstance.setView([data[0].lat, data[0].lon], 13);
                    } else { alert('æ‰¾ä¸åˆ°åŸå¸‚'); }
                } catch(e){} finally { isMapLoading.value = false; }
            };

            const exploreNearby = async () => {
                if(!mapInstance) return;
                isMapLoading.value = true;
                exploreLayer.clearLayers();
                const b = mapInstance.getBounds();
                const viewbox = `${b.getWest()},${b.getNorth()},${b.getEast()},${b.getSouth()}`;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=tourism&viewbox=${viewbox}&bounded=1&limit=20`);
                    const data = await res.json();
                    if(!data.length) alert('é™„è¿‘ç„¡æ™¯é»');
                    data.forEach(item => {
                        L.circleMarker([item.lat, item.lon], {color: '#9333ea', fillColor: '#9333ea', fillOpacity: 0.6, radius: 6}).addTo(exploreLayer)
                        .bindPopup(`<div style="text-align:center"><b>${item.display_name.split(',')[0]}</b><br><button class="popup-btn" onclick="document.dispatchEvent(new CustomEvent('add-from-map', {detail: {name: '${item.display_name.split(',')[0]}', lat: ${item.lat}, lng: ${item.lon}}}))">â• åŠ å…¥</button></div>`);
                    });
                } catch(e){} finally { isMapLoading.value = false; }
            };

            const showMyItineraryOnMap = () => {
                if(!mapInstance) return;
                markersLayer.clearLayers();
                exploreLayer.clearLayers();
                const bounds = L.latLngBounds();
                let hasPoint = false;
                itinerary.value.forEach(item => {
                    // â˜… å³ä½¿èˆŠè³‡æ–™æ²’æœ‰åº§æ¨™ï¼Œä¹Ÿå˜—è©¦ç”¨åŸå¸‚åä¿®æ­£
                    if(item.lat && item.lng) {
                        const d = item.day ? parseInt(item.day) : 1;
                        L.circleMarker([item.lat, item.lng], {color: getDayColor(d), fillColor: getDayColor(d), fillOpacity: 0.9, radius: 8})
                        .addTo(markersLayer).bindPopup(`<b>D${d}: ${item.name}</b><br>${item.message||''}`);
                        bounds.extend([item.lat, item.lng]); hasPoint = true;
                    }
                });
                if(hasPoint) mapInstance.fitBounds(bounds, { padding: [50,50] });
            };

            const addPlaceFromMap = async ({ name, lat, lng }) => {
                const id = generateId(); const d = currentDay.value;
                itinerary.value.push({ id, name, day: d, lat, lng, message: '' });
                await sendToApi('add', 'itinerary', { id, name, day: d, lat, lng, message: '' });
                alert(`å·²åŠ å…¥ Day ${d}`); showMyItineraryOnMap();
            };

            const addPlace = async () => {
                if(!newPlace.value.trim()) return;
                const id = generateId();
                const d = { id, name: newPlace.value, day: currentDay.value, lat: selectedLat.value, lng: selectedLng.value, message: newNote.value };
                itinerary.value.push(d);
                newPlace.value = ''; newNote.value = ''; selectedLat.value = null;
                await sendToApi('add', 'itinerary', d);
            };
            const removePlace = async(id) => {
                const i = itinerary.value.findIndex(x=>x.id===id);
                if(i!==-1) { itinerary.value.splice(i,1); await sendToApi('del', 'itinerary', id); }
            };
            const addNewDay = () => { totalDays.value++; currentDay.value = totalDays.value; };
            const openGoogleMap = (p) => window.open(p.lat ? `https://maps.google.com/?q=${p.lat},${p.lng}` : `https://maps.google.com/?q=${encodeURIComponent(p.name + (targetCity.value ? ','+targetCity.value : ''))}`, '_blank');
            
            // Money & Settings
            const addExpense = async () => {
                if (!newExpense.value.title || !newExpense.value.amount) return;
                const uid = generateId(); const d = { id: uid, ...newExpense.value, involved: [...newExpense.value.involved] };
                expenses.value.unshift(d); await sendToApi('add', 'expenses', { ...d, involved: d.involved.join(',') });
                newExpense.value = { title: '', amount: '', payer: people.value[0]?.name||'', involved: people.value.map(p=>p.name) };
            };
            const removeExpense = async (idx) => { const item = expenses.value[idx]; if (!item.id) return; expenses.value.splice(idx, 1); await sendToApi('del', 'expenses', item.id); };
            const addPerson = async () => { if (!newPerson.value.trim()) return; const uid = generateId(); people.value.push({ id: uid, name: newPerson.value }); newExpense.value.involved.push(newPerson.value); newPerson.value = ''; await sendToApi('add', 'people', { id: uid, name: newPerson.value }); };
            const removePerson = async (idx) => { const item = people.value[idx]; if (!item.id || !confirm('ç§»é™¤ï¼Ÿ')) return; people.value.splice(idx, 1); await sendToApi('del', 'people', item.id); };
            const resetApp = async () => { if(!confirm('åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) return; await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'reset_all', type:'all'})}); itinerary.value=[]; expenses.value=[]; people.value=[{id:'def',name:'æˆ‘'}]; totalDays.value=1; currentDay.value=1; alert('å·²é‡ç½®'); };
            const totalExpense = computed(() => expenses.value.reduce((s,i)=>s+(Number(i.amount)||0),0));
            const balanceSheet = computed(() => { if(!people.value.length) return []; let b={}; people.value.forEach(p=>b[p.name]=0); expenses.value.forEach(e=>{ const amt=Number(e.amount)||0; if(b[e.payer]===undefined) return; b[e.payer]+=amt; const inv=(e.involved&&e.involved.length)?e.involved:people.value.map(p=>p.name); const v=inv.filter(n=>b[n]!==undefined); if(v.length) { const s=amt/v.length; v.forEach(n=>b[n]-=s); } }); return Object.keys(b).map(n=>({name:n, balance:b[n]})); });

            return {
                currentTab, switchTab, isLoading, isMapLoading, currentDay, totalDays, addNewDay,
                people, itinerary, expenses, filteredItinerary: computed(()=>itinerary.value.filter(i=>(i.day?parseInt(i.day):1)===currentDay.value)),
                newPlace, newNote, newPerson, newExpense,
                targetCity, saveCityPref, // â˜… åŸå¸‚è®Šæ•¸
                mapSearchQuery, searchResults, searchCityAndJump, exploreNearby, showMyItineraryOnMap,
                searchPlacesInput, selectPlace, addPlace, removePlace, openGoogleMap,
                addExpense, removeExpense, addPerson, removePerson, resetApp,
                totalExpense, balanceSheet, fetchData
            };
        }
    }).mount('#app');
</script>
</body>
</html>
